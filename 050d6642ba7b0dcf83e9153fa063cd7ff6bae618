{
  "comments": [
    {
      "key": {
        "uuid": "272bbe19_14f0f485",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_117.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2016-01-19T04:51:04Z",
      "side": 1,
      "message": "This SQL operation is dialect specific. You should use JdbcSchema#renameColumn() method instead:\n\n  try (StatementExecutor e \u003d newExecutor(db)) {\n      ((JdbcSchema)db).renameColumn(e,\n          \"patch_sets\",\n          \"push_certficate\",\n          \"push_certificate\");\n  }",
      "range": {
        "startLine": 36,
        "startChar": 13,
        "endLine": 36,
        "endChar": 19
      },
      "revId": "050d6642ba7b0dcf83e9153fa063cd7ff6bae618",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e7828650_72d95846",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_117.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2016-01-19T05:02:42Z",
      "side": 1,
      "message": "I had tried to use SchemaVersion.renameColumn, but that also failed.  I saw that renameColumn actually calls JdbcSchema.renameField, which looked wrong, so changed it to JdbcSchema.renameColumn, and that also failed.  I\u0027m getting the same error if I directly call JdbcSchema.renameColumn here too.\n\n Cannot apply SQL\nALTER TABLE patch_sets ALTER COLUMN push_certficate RENAME TO push_certificate\n\n Caused by: org.h2.jdbc.JdbcSQLException: Duplicate column name \"PUSH_CERTIFICATE\"; SQL statement:\nALTER TABLE patch_sets ALTER COLUMN push_certficate RENAME TO push_certificate [42121-176]",
      "parentUuid": "272bbe19_14f0f485",
      "range": {
        "startLine": 36,
        "startChar": 13,
        "endLine": 36,
        "endChar": 19
      },
      "revId": "050d6642ba7b0dcf83e9153fa063cd7ff6bae618",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "67313682_b65d882e",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_117.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2016-01-19T05:23:41Z",
      "side": 1,
      "message": "That\u0027s strange. I went to the ssh host gerrit gsql command on current master, created table FOO with couple of columns and tried the alter table statement directly and it worked as expected:\n\n gerrit\u003e \\d FOO\n Table FOO\n COLUMN_NAME     | TYPE\n ----------------+-----------------------------\n CREATED_ON      | TIMESTAMP NOT NULL\n DRAFT           | CHAR(1) DEFAULT \u0027N\u0027 NOT NULL\n REVISION        | VARCHAR(40)\n GROUPS          | VARCHAR(255)\n PUSH_CERTFICATE | CLOB\n\n gerrit\u003e alter table FOO ALTER COLUMN push_certficate RENAME TO push_certificate;\n\n UPDATE 0; 1 ms\n gerrit\u003e \\d FOO\n Table FOO\n COLUMN_NAME      | TYPE\n -----------------+-----------------------------\n CREATED_ON       | TIMESTAMP NOT NULL\n DRAFT            | CHAR(1) DEFAULT \u0027N\u0027 NOT NULL\n REVISION         | VARCHAR(40)\n GROUPS           | VARCHAR(255)\n PUSH_CERTIFICATE | CLOB",
      "parentUuid": "e7828650_72d95846",
      "range": {
        "startLine": 36,
        "startChar": 13,
        "endLine": 36,
        "endChar": 19
      },
      "revId": "050d6642ba7b0dcf83e9153fa063cd7ff6bae618",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c785825a_f1ec68e6",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_117.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2016-01-19T05:31:33Z",
      "side": 1,
      "message": "Strange indeed.  I just double-checked with gsql and there seems to already be a PUSH_CERTIFICATE column.\n\n Welcome to Gerrit Code Review 2.12-693-g3d67c92\n (H2 1.3.176 (2014-04-05))\n \n Type \u0027\\h\u0027 for help.  Type \u0027\\r\u0027 to clear the buffer.\n \n gerrit\u003e \\d patch_sets\n                     Table PATCH_SETS\n COLUMN_NAME         | TYPE\n --------------------+-----------------------------\n REVISION            | VARCHAR(40)\n UPLOADER_ACCOUNT_ID | INTEGER DEFAULT 0 NOT NULL\n CREATED_ON          | TIMESTAMP NOT NULL\n DRAFT               | CHAR(1) DEFAULT \u0027N\u0027 NOT NULL\n GROUPS              | VARCHAR(255)\n PUSH_CERTFICATE     | VARCHAR(255)\n CHANGE_ID           | INTEGER DEFAULT 0 NOT NULL\n PATCH_SET_ID        | INTEGER DEFAULT 0 NOT NULL\n PUSH_CERTIFICATE    | VARCHAR(255)\n \n Indexes on PATCH_SETS:\n  PATCH_SETS_BYREVISION (REVISION)\n  PRIMARY_KEY_52 UNIQUE (CHANGE_ID, PATCH_SET_ID)\n\nI\u0027ll try again with a clean site...",
      "parentUuid": "67313682_b65d882e",
      "range": {
        "startLine": 36,
        "startChar": 13,
        "endLine": 36,
        "endChar": 19
      },
      "revId": "050d6642ba7b0dcf83e9153fa063cd7ff6bae618",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "272bbe19_d49fdc26",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_117.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2016-01-19T05:37:12Z",
      "side": 1,
      "message": "Ohh, now I understand what happens: You change the class attribute from PatchSet.pushCertficate to PatchSet.pushCertificate and schema migration machinerry is run *before* invocation of the migrateData() method and creates new (missing) column: push_certficate. After this is done your schema migration process is failing as expected with duplicate column SQL error message.\n\nTo rectify, you must put rename column invocation in method that run *before* schema migratioj machinery. That what the\n\n  preUpdateSchema(ReviewDb db)\n\nwas invented for.",
      "parentUuid": "c785825a_f1ec68e6",
      "range": {
        "startLine": 36,
        "startChar": 13,
        "endLine": 36,
        "endChar": 19
      },
      "revId": "050d6642ba7b0dcf83e9153fa063cd7ff6bae618",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c785825a_91f15cc1",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_117.java",
        "patchSetId": 2
      },
      "lineNbr": 36,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2016-01-19T05:51:16Z",
      "side": 1,
      "message": "Thanks.  That fixed it, however I also had to make a fix on SchemaVersion.renameColumn (see new ancestor change of this one).",
      "parentUuid": "272bbe19_d49fdc26",
      "range": {
        "startLine": 36,
        "startChar": 13,
        "endLine": 36,
        "endChar": 19
      },
      "revId": "050d6642ba7b0dcf83e9153fa063cd7ff6bae618",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}