{
  "comments": [
    {
      "key": {
        "uuid": "d802aa8c_e6b35e3a",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1001240
      },
      "writtenOn": "2015-07-15T04:55:28Z",
      "side": 1,
      "message": "Today we learned this is causing significant CPU load on our bigger repositories.\n\nThe web UI calls /detail with a If-None-Match header, polling to see if the change has been updated. The server has to compute the ETag via this getETag() call.\n\nOn a big repository that is very active the canRebase method is actually a bottleneck. We observe quite a few thread traces busy inside of the rebase logic, checking the change against current head.\n\nAs a workaround we have disabled the browser polling, but that only sheds some load. Automated tools are still free to ping away and wait for ETag generation. :(",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "784c5e14_dbb3933a",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1018043
      },
      "writtenOn": "2015-07-15T08:12:23Z",
      "side": 1,
      "message": "Yeah its not surprising since rebase.canRebase is very heavy. I guess we could add a cache into canRebase, which should speed things up.",
      "parentUuid": "d802aa8c_e6b35e3a",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d802aa8c_26d29646",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1001240
      },
      "writtenOn": "2015-07-15T15:50:32Z",
      "side": 1,
      "message": "Don\u0027t we already have a cache for \"can A rebase onto B?\"\n\nNote we don\u0027t do this for canMerge. That is handled elsewhere. So why are we doing canRebase in the ETag?",
      "parentUuid": "784c5e14_dbb3933a",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "784c5e14_7beeff00",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1018043
      },
      "writtenOn": "2015-07-15T16:15:17Z",
      "side": 1,
      "message": "What we want to know here is whether its possible to do a rebase or is the change already up-to-date, so that we can show/hide an orange Circle next to the Parent revision on the Change screen. If this info is not reflected in the ETag the orange circle is not updated properly.\n\nRegarding whether \"can A rebase onto B\" cache ... I\u0027m only aware of the mergability checks if that is what you\u0027re referring to? However, its more like \"is review A up-to-date with the target branch or its closest parent review B\" we need to cache I think.",
      "parentUuid": "d802aa8c_26d29646",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "581ddaf5_1ad25d46",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1001240
      },
      "writtenOn": "2015-07-15T16:24:48Z",
      "side": 1,
      "message": "Urrrgh. This is very expensive for us to compute for a simple orange circle icon. I bet most users don\u0027t even know what that orange circle means.\n\nRight now its costing us \u003e1s per etag generation on one of our bigger projects. This canRebase stuff isn\u0027t cheap. It hurts less when its an async REST API that runs in the background after the change screen is loaded, because at least then the user isn\u0027t waiting for this information before they can see the change and open a file.\n\nThere are a lot of other visual elements on the change screen that are dynamic that are not part of the /detail cached call. It seems like this information should be moved there.",
      "parentUuid": "784c5e14_7beeff00",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1817e2d9_f8b8d116",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2015-07-15T17:11:46Z",
      "side": 1,
      "message": "canRebase is way overkill for what we need for this orange dot anyway, which is just \"is commit X merged into branch B\".\n\nBut yeah in retrospect this should definitely not be in the ETag generation. We can do a request when the user hits the rebase button prior to rendering the dialog.",
      "parentUuid": "581ddaf5_1ad25d46",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3820262d_f9b8d716",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2015-07-15T17:20:07Z",
      "side": 1,
      "message": "\u003e \"is commit X merged into branch B\"\n\nOr...not even. \"Is commit X the tip of branch B?\" should be sufficient. No? Am I missing something?",
      "parentUuid": "1817e2d9_f8b8d116",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b84256dc_bddb1f5b",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeResource.java",
        "patchSetId": 12
      },
      "lineNbr": 74,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-07-15T18:09:33Z",
      "side": 1,
      "message": "| What we want to know here is whether its possible to do a rebase or is the change already up-to-date [...]\n\nReally, this is all nice to have. Now, that I have seen load time around 30 seconds on gerrit-review, nobody really cares, if the button is orange or blue: the use would just kill the window. If we don\u0027t know a way to load change screen with 1-2 seconds, highest tolerale time for the user, than it only means that we don\u0027t offer orange button, and not wait up to 30 seconds to compute the colour of the buton.",
      "parentUuid": "784c5e14_7beeff00",
      "revId": "0d99067b8ddae3554c1e067d5a9cc2fc6d8c8629",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}