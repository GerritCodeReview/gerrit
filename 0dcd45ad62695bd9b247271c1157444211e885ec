{
  "pushCert": "certificate version 0.1\npusher Dave Borowitz \u003cdborowitz@google.com\u003e 1542666199 -0800\nnonce ADWBXRCsi/bl9Z5fYa1ZuocUGZU1jJAcrXlZkPke2KqaTM9H1DLWLzBryIwnof7UI97YfllstAKY\n\n0000000000000000000000000000000000000000 61ebe2787d3e3a26300d058c1876700f43ed27d8 refs/for/master\n-----BEGIN PGP SIGNATURE-----\n\niQJJBAABCgAzFiEEpPm/sOxWgSqG5grhX9fFmpoSiIwFAlvzN9cVHGRib3Jvd2l0\nekBnb29nbGUuY29tAAoJEF/XxZqaEoiMGjMQAMK2xJJ8iH1O/Dekn6uGMt5IxXlv\n7TNfdRjp3b1Thw4FGb4kpFJEPwlyWVtYY2nSxInN5UaIwyZ7k32fhaePo1qRGEML\nvrwcwnZbigpUiu32xPjkxdtCn1OIlz5jGf5Z+W/LBLftERxaWwX5mu1JI5SctHsc\nldm76SbzrS0WuJvqhJB9cwJT/4ZaTDuL8F2TiLBD1RmN78pm8HHAcxBvsDFsKFB+\nhNjeF9Y2khwo771AlU8OZid7quK4Q5HmCvW6Zhwd0aSP9M1LRVa5WO1lq1RmaHTY\nuWFFfbTn2dFD6bd+3//HTj1l8AfG5V6EvXhOhmBTVpEk8C+kvzrjV50DOWrlTJUq\niaz4YB8kdCLLKcFGiwbkkSXwttONzOiSbH4mZVmYTze/u3accBXjzRB9Ut0TZ9RP\nKrHdSUF/lGvDiQMTKf0jT4RO/rHz4o9M799GLdb6ikeznzWvCs3gqUZqZIQsgjtu\nvj7fbshl7BvcxCQwUAWQ5pPTnVNpoufna3a7r4i0TXe7K7Gq6YlXr0/wwrNYWEgF\nakqtGl1P3vN4QZR/tBnNp0Bg8l6J/IDJYRvtzS06BXYzKy22D1w81XGqw4Xhy5EJ\nxCVU1sufHRIFrOspphcdtFgjGe9Gp2sPN1Ca0jH7nyjTBMaQQvDGu7T+n+71h1p5\ne/oMbp/kuO+8bSSt\n\u003djPeQ\n-----END PGP SIGNATURE-----\n",
  "comments": [
    {
      "key": {
        "uuid": "457e1bd0_9713336d",
        "filename": "java/com/google/gerrit/server/schema/NoteDbSchemaUpdater.java",
        "patchSetId": 2
      },
      "lineNbr": 123,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-11-26T20:44:52Z",
      "side": 1,
      "message": "In init phase we provide link to the notedb documentation:\n\n  Use NoteDb for change metadata?\n  See documentation:\n  https://gerrit-review.googlesource.com/Documentation/note-db.html\n\nHere we could extend the exception and link to the online or offline migration sections:\n\n* https://gerrit-review.googlesource.com/Documentation/note-db.html#offline-migration\n* https://gerrit-review.googlesource.com/Documentation/note-db.html#online-migration\n\nAnother option would be to add new section: migration to 3.0, explain the requirements and link to this section here.\n\nUnrelated to this change, but I\u0027m seeing this statement in note-db.html:\n\n* Offline migration: [...] Available in both Gerrit 2.x and 3.0.\n\nBut for migrate-to-note-db to access the database in 3.0, the ReviewDb binding code should be preserved in 3.0. OTOH the plan was/is (?) to remove ReviewDb binding entirely in 3.0, so either the documentation or the plan is wrong?",
      "range": {
        "startLine": 123,
        "startChar": 6,
        "endLine": 123,
        "endChar": 47
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "10c7ae2a_2eaccc0a",
        "filename": "java/com/google/gerrit/server/schema/NoteDbSchemaUpdater.java",
        "patchSetId": 2
      },
      "lineNbr": 138,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2018-11-26T15:55:04Z",
      "side": 1,
      "message": "or if init was run from 2.16 but a schema migration \u003e 163 failed and hence was not executed\n\nCould we instead maybe have a last migration in 2.16 that populates the refs/meta/version ref?",
      "range": {
        "startLine": 137,
        "startChar": 7,
        "endLine": 138,
        "endChar": 95
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8d5af9ad_2d19d6b0",
        "filename": "java/com/google/gerrit/server/schema/NoteDbSchemaUpdater.java",
        "patchSetId": 2
      },
      "lineNbr": 138,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-11-26T16:03:42Z",
      "side": 1,
      "message": "-1. As explained in my comment on previous change, ReviewDb schema migrations and NoteDb schema migrations should stay separated and not interfer with each other:\n\n* stable-2.16 last ReviewDb schema migration (currently 170, but we can add as many as we want)\n* master/3.0 first NoteDb schema migration, assigning refs/meta/version to 180",
      "parentUuid": "10c7ae2a_2eaccc0a",
      "range": {
        "startLine": 137,
        "startChar": 7,
        "endLine": 138,
        "endChar": 95
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a3b10a74_048b2b80",
        "filename": "java/com/google/gerrit/server/schema/NoteDbSchemaUpdater.java",
        "patchSetId": 2
      },
      "lineNbr": 138,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2018-11-27T07:31:08Z",
      "side": 1,
      "message": "\u003e -1. As explained in my comment on previous change, ReviewDb schema migrations and NoteDb schema migrations should stay separated and not interfer with each other:\n\nFor some migrations that you have in mind in may be possible to guarantee that they don\u0027t interfere, however it can be difficult to be sure about this. So at least adding new schema migration in 2.16 would need to be done with great care to avoid conflicts.\n\n\u003e \n\u003e * stable-2.16 last ReviewDb schema migration (currently 170, but we can add as many as we want)\n\nThis basically means that we do not support upgrade of 2.16 to 3.0, but that require having 2.16.x before upgrading to 3.0 where 2.16.x is the 2.16 version that contains all schema migrations. But then this check here is not good enough since it doesn\u0027t differentiate between 2.16 and 2.16.x.\n\nMy proposal of adding a last migration in 2.16 that populates the refs/meta/version ref also means that we require 2.16.x before upgrade to 3.0, but in this case we can at least reliably check that the system is on 2.16.x.\n\n\u003e * master/3.0 first NoteDb schema migration, assigning refs/meta/version to 180",
      "parentUuid": "8d5af9ad_2d19d6b0",
      "range": {
        "startLine": 137,
        "startChar": 7,
        "endLine": 138,
        "endChar": 95
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "11481740_2b5b91a7",
        "filename": "java/com/google/gerrit/server/schema/NoteDbSchemaUpdater.java",
        "patchSetId": 2
      },
      "lineNbr": 138,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2018-12-06T15:41:33Z",
      "side": 1,
      "message": "I agree that the corner case pointed out by Edwin exists but I personally don\u0027t think it\u0027s that serious. To hit it you have to observe init failing on 2.16, which means you literally won\u0027t be able to launch a 2.16 daemon. Then you decide that instead of ever running a successful init/daemon on 2.16, you would rather upgrade to 3.0. Do you think that\u0027s realistic enough to change our whole approach?\n\nAnother possibility: we might be able to make this change detect schema 167, which migrates groups to NoteDb. That just leaves:\n\n* 168: No-op; deletes some ReviewDb tables\n* 169: Migrate NoteDb comments to JSON. Could be easily duplicated as a ReviewDb schema upgrade.\n* 170: No-op; deletes ReviewDb tables.\n\nTo detect whether 167 was done, we can just look for the group name ref in NoteDb. The only assumption we\u0027re making is that there exists at least one internal group. I think this is a safe assumption, because init always creates the Administrators group and IIRC groups can\u0027t be deleted.\n\nWDYT?",
      "parentUuid": "a3b10a74_048b2b80",
      "range": {
        "startLine": 137,
        "startChar": 7,
        "endLine": 138,
        "endChar": 95
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f2dcb45d_0302707c",
        "filename": "java/com/google/gerrit/server/schema/NoteDbSchemaUpdater.java",
        "patchSetId": 2
      },
      "lineNbr": 138,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2018-12-06T15:54:19Z",
      "side": 1,
      "message": "Maybe just add the failed schema migration case to the comment above which talks about corner-cases. I agree that this is rather unlikely to happen and probably doesn\u0027t justify a higher implementation effort.\n\n\u003e 168: No-op; deletes some ReviewDb tables\n\u003e 169: Migrate NoteDb comments to JSON. Could be easily duplicated as a ReviewDb schema upgrade.\n\u003e 170: No-op; deletes ReviewDb tables.\n\nI guess for 169 you meant duplication as NoteDb schema upgrade?\n\nI\u0027m fine with this, but if we allow further migrations in 2.16 we should document the requirements / limitations for adding such migrations somewhere (e.g. must be idempotent and re-implemented as NoteDb schema upgrade).\n\n\u003e To detect whether 167 was done, we can just look for the group name ref in NoteDb. \n\nSG, but I\u0027m not sure if it\u0027s any better than the approach that is currently implemented by this change (checking if the ref with the group sequence exists).",
      "parentUuid": "11481740_2b5b91a7",
      "range": {
        "startLine": 137,
        "startChar": 7,
        "endLine": 138,
        "endChar": 95
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "38530a70_d0bff2ab",
        "filename": "java/com/google/gerrit/server/schema/NoteDbSchemaUpdater.java",
        "patchSetId": 2
      },
      "lineNbr": 138,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-06T16:01:52Z",
      "side": 1,
      "message": "I\u0027m fine with how it\u0027s solved right now. If it helps, we can prohibit further reviewdb migrations on 2.16.",
      "parentUuid": "f2dcb45d_0302707c",
      "range": {
        "startLine": 137,
        "startChar": 7,
        "endLine": 138,
        "endChar": 95
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ce64fc56_0a201478",
        "filename": "javatests/com/google/gerrit/server/schema/NoteDbSchemaUpdaterTest.java",
        "patchSetId": 2
      },
      "lineNbr": 171,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-11-26T20:44:52Z",
      "side": 1,
      "message": "@SuppressWarnings(\"unused\") to suppress warning in Eclipse.\n\nI mean I\u0027m fine to drop the requirement for the code base to be Eclipse warning free, if more and more core developers are switching to IntelliJ IDEA or GNU Emacs. But, before doing this, we should remove/adjust this section in contribution documentation: dev-contributing.txt:\n\n  This project has a policy of Eclipse\u0027s warning free code. Eclipse\n  configuration is added to git and we expect the changes to be\n  warnings free.",
      "range": {
        "startLine": 171,
        "startChar": 6,
        "endLine": 171,
        "endChar": 37
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "750807f2_91286353",
        "filename": "javatests/com/google/gerrit/server/schema/NoteDbSchemaUpdaterTest.java",
        "patchSetId": 2
      },
      "lineNbr": 182,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-11-26T20:44:52Z",
      "side": 1,
      "message": "Same here.",
      "range": {
        "startLine": 182,
        "startChar": 6,
        "endLine": 182,
        "endChar": 37
      },
      "revId": "0dcd45ad62695bd9b247271c1157444211e885ec",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}