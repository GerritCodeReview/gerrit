{
  "comments": [
    {
      "key": {
        "uuid": "8f05e06d_1962d792",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 10,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T04:28:15Z",
      "side": 1,
      "message": "These and other lines below are too long. Wrap the lines to 72 chars.",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 78
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3483e510_66f30080",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 10,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T06:54:41Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8f05e06d_1962d792",
      "range": {
        "startLine": 10,
        "startChar": 0,
        "endLine": 10,
        "endChar": 78
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4eef2378_8eacad0f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 21,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T04:28:15Z",
      "side": 1,
      "message": "Add the reference to the commit that introduced the breakage: as abbreviated Change-Id: Ie4c677365cd.",
      "range": {
        "startLine": 18,
        "startChar": 0,
        "endLine": 21,
        "endChar": 15
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e261d38e_5585cd40",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 21,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T06:56:00Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4eef2378_8eacad0f",
      "range": {
        "startLine": 18,
        "startChar": 0,
        "endLine": 21,
        "endChar": 15
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "870cbaaf_c41886d4",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T04:28:15Z",
      "side": 1,
      "message": "What about: Issue 9001? Is that now fixed as well? Link it here too? Can you comment/merge those issues and mark one of the as a duplicate of another?",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7ab8bfda_fa77f3e4",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T06:56:00Z",
      "side": 1,
      "message": "Not sure, because the bug I fixed did not exist until v2.16. I guess the exception is similar but the bug could be different.",
      "parentUuid": "870cbaaf_c41886d4",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "998c4180_a7137056",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T08:22:23Z",
      "side": 1,
      "message": "Yes, it sounds like related. And description of issue 9001 (see the code pointer in description of that issue) also reveals yet another problem with the approach in this change: it is relaxing the restriction to having the same email multiple times across different external ids for the same account in AccountManager, while still missed to fix the consistency checker for account and external_ids to relax the check as well: [1].\n\nREST endpoint: \n\n  https://gerrit.domain/a/config/server/check.consistency\n\nwith this body:\n\n  \"check_accounts\": {},\n  \"check_account_external_ids\": {} \n\nSo that this change might create a situation, where AccountManager would allow something to happen, that would be detected as inconsistent by the current ConsistencyChecker code.\n\nBefore the to strict email check regression introduced in: Ie4c677365cd, linking of external ids in OAuth-plugin worked as expected. Given this external id (see detailed bug report in: [2]):\n\n  [externalId \"123456789098765432123\"]\n        accountId \u003d 4711\n        email \u003d foo@example.org\n\noauth plugin linked on login attempt the above legacy external id (note, there is no provider prefix) to this one:\n\n  [externalId \"google-oauth:123456789098765432123\"]\n        accountId \u003d 4711\n        email \u003d foo@example.org\n\nTo summarize, this change fixed both issue 11246 and issue 9001, so that they both should be linked here, or one be merged into another.\n\n* [1] https://github.com/GerritCodeReview/gerrit/blob/master/java/com/google/gerrit/server/account/externalids/ExternalIdsConsistencyChecker.java#L95-L107\n* [2] https://github.com/davido/gerrit-oauth-provider/issues/123",
      "parentUuid": "7ab8bfda_fa77f3e4",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a58d450e_a85de94e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T08:39:32Z",
      "side": 1,
      "message": "Thanks for the pointers, I need to dig into it a bit more. It is still unclear to me how fixing a problem introduced in v2.16 could have solved an issue on v2.14/v2.15 :-O",
      "parentUuid": "998c4180_a7137056",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "48da4d2a_fe910d34",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T12:27:44Z",
      "side": 1,
      "message": "From the first investigation of the Issue 9001, it looks like I may have *not covered* that scenario at all. By looking at the ExternalIT, the test is asserting that if you have a preferred e-mail user@company.com BUT not an external id of type mailto:user@company.com, then you are fine.\n\nI need to add an extra test case of when you have the preferred e-mail *and* the mailto: external id, and let\u0027s see if that case is fixed also ... or not :-(",
      "parentUuid": "a58d450e_a85de94e",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4b32fcd5_4c3111a1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T12:38:27Z",
      "side": 1,
      "message": "So, I have added the extra test-case where an external mailto:\u003c\u003e is used as preferred email and ExternalIT.checkConsistency() test fails.\n\nIt is thus confirmed that this change *does not fix* Issue 9001.\n\nP.S. Issue 9001 *must be fixed* but it is a different problem and needs to be addressed in a follow-up change.",
      "parentUuid": "48da4d2a_fe910d34",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fa59b550_52c7d6f4",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T16:27:32Z",
      "side": 1,
      "message": "\u003e So, I have added the extra test-case where an external mailto:\u003c\u003e is used as preferred email and ExternalIT.checkConsistency() test fails.\n\u003e \n\u003e It is thus confirmed that this change *does not fix* Issue 9001.\n\nApparently there are different use cases. Can you re-check my comment from today 10:22 AM? So I have just confirmed, that in context of oauth-plugin, issue 9001 and this upstream issue: https://github.com/davido/gerrit-oauth-provider/issues/123 are definitely fixed with this change applied and that is really great!\n\nNow I\u0027m able to link new external id: \"google-oauth:123456789098765432123\" (note: with the provider name prefix) to the existing one \"123456789098765432123\" (note: without the provider name prefix).\n\nAlso note: that the reporter of issue 9001 and https://github.com/davido/gerrit-oauth-provider/issues/123 is the same person.\n\nAs he correctly pointed out, ExternalIdsConsistencyChecker is still broken, and still rejects the same email be referenced by different external ids, that belongs to the same account. Also with the OAuth external ids in my previous comment, that is made possible by this change, consistency checker result is:\n\n  $ curl --user joe:secret -X POST -H \"Content-Type: application/json\" \\\n    -d {\"check_account_external_ids\": {}} \\\n    http://localhost:8080/a/config/server/check.consistency \\\n   | sed \"s/\\\\\\\\u0027/\u0027/g\"\n\nAnd the result is:\n\n  \"check_account_external_ids_result\": {\n    \"problems\": [\n      {\n        \"status\": \"ERROR\",\n        \"message\": \"Email \u0027foo@example.org\u0027 is not unique, it\u0027s used by the following external IDs: \u0027123456789098765432123\u0027, \u0027google-oauth:123456789098765432123\u0027\"\n      }\n    ]\n  }\n\nBut this is wrong, because the both external ids belong to exactly same account id: 4711, and this is exactly what this change is trying to fix.\n\nI looked into the fix, and it seems, that this diff fixed the problem: [1]. However, I haven\u0027t checked if this code change broke any tests.\n\n[1] http://paste.openstack.org/show/779703",
      "parentUuid": "4b32fcd5_4c3111a1",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2c0da1b2_15b935d5",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T20:10:12Z",
      "side": 1,
      "message": "\u003e Apparently there are different use cases. Can you re-check my comment from today 10:22 AM? \n\nYou said: \"So that this change might create a situation, where AccountManager would allow something to happen, that would be detected as inconsistent by the current ConsistencyChecker code.\"\n\nThe answer is yes, because this fixes an AccountManager bug that was blocking people to login via LDAP.\n\nThe consistency checker, instead, is verifying the direct pushes to refs/meta/external-ids and the associated REST-API, and those are still broken.\n\n\u003e So I have just confirmed, that in context of oauth-plugin, issue 9001\n\nNope, Issue 9001 isn\u0027t fixed yet.\n\n\u003e and this upstream issue: https://github.com/davido/gerrit-oauth-provider/issues/123 \n\nYes, this is fixed.\n\n\u003e Now I\u0027m able to link new external id: \"google-oauth:123456789098765432123\" (note: with the provider name prefix) to the existing one \"123456789098765432123\" (note: without the provider name prefix).\n\nYes, that should be working now.\n\n\u003e I looked into the fix, and it seems, that this diff fixed the problem: [1]. However, I haven\u0027t checked if this code change broke any tests.\n\u003e \n\u003e [1] http://paste.openstack.org/show/779703\n\nThat looks a good start, why don\u0027t you upload it as WIP change and we can start an early review?",
      "parentUuid": "fa59b550_52c7d6f4",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "5fad2788_1f101eee",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T21:28:00Z",
      "side": 1,
      "message": "\u003e That looks a good start, why don\u0027t you upload it as WIP change and we can start an early review?\n\nBecause I am convinced that this should happen in this change. Before this change both behaviors are consistent: AccountManager and ConsistencyChecker. After this change, AccountManager is fixed, ConsistencyChecker is still broken. So that this change cannot be submitted as is.",
      "parentUuid": "2c0da1b2_15b935d5",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "21a1fcec_bcf5367e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 37,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T21:30:09Z",
      "side": 1,
      "message": "\u003e \u003e That looks a good start, why don\u0027t you upload it as WIP change and we can start an early review?\n\u003e \n\u003e Because I am convinced that this should happen in this change. Before this change both behaviors are consistent: AccountManager and ConsistencyChecker. After this change, AccountManager is fixed, ConsistencyChecker is still broken. So that this change cannot be submitted as is.\n\nWhat about two changes in the same topic? :-)",
      "parentUuid": "5fad2788_1f101eee",
      "range": {
        "startLine": 37,
        "startChar": 0,
        "endLine": 37,
        "endChar": 16
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "16e1619a_6a60f86d",
        "filename": "java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 6
      },
      "lineNbr": 374,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T04:28:15Z",
      "side": 1,
      "message": "externalId.get()",
      "range": {
        "startLine": 374,
        "startChar": 12,
        "endLine": 374,
        "endChar": 71
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b96bc1cd_a5ad2b61",
        "filename": "java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 6
      },
      "lineNbr": 374,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T04:47:19Z",
      "side": 1,
      "message": "\u003e externalId.get()\n\nI meant: externalId.accountId().get(), of course.",
      "parentUuid": "16e1619a_6a60f86d",
      "range": {
        "startLine": 374,
        "startChar": 12,
        "endLine": 374,
        "endChar": 71
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2adbd7dc_243d4054",
        "filename": "java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 6
      },
      "lineNbr": 374,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T06:51:19Z",
      "side": 1,
      "message": "Good catch, however that part hasn\u0027t changed and isn\u0027t part of the fix.\nHappy to do that in a follow-up fix.",
      "parentUuid": "b96bc1cd_a5ad2b61",
      "range": {
        "startLine": 374,
        "startChar": 12,
        "endLine": 374,
        "endChar": 71
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f636f2fe_05c39f0f",
        "filename": "java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 6
      },
      "lineNbr": 374,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T06:55:57Z",
      "side": 1,
      "message": "It is changed indirectly: Before this change there wasn\u0027t a loop over matched externalId instances. This change added the loop and should take advantage in accessing the matched account id from the loop variable instead of accessing it through yet another iterator instance.",
      "parentUuid": "2adbd7dc_243d4054",
      "range": {
        "startLine": 374,
        "startChar": 12,
        "endLine": 374,
        "endChar": 71
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "18c08368_97a756e9",
        "filename": "java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 6
      },
      "lineNbr": 374,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T06:56:31Z",
      "side": 1,
      "message": "point taken, will fix here then.",
      "parentUuid": "f636f2fe_05c39f0f",
      "range": {
        "startLine": 374,
        "startChar": 12,
        "endLine": 374,
        "endChar": 71
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "71fd1712_25651d2b",
        "filename": "java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 6
      },
      "lineNbr": 374,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T07:51:43Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "18c08368_97a756e9",
      "range": {
        "startLine": 374,
        "startChar": 12,
        "endLine": 374,
        "endChar": 71
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "afaa1d41_0d7f93fb",
        "filename": "javatests/com/google/gerrit/acceptance/api/accounts/AccountManagerIT.java",
        "patchSetId": 6
      },
      "lineNbr": 24,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T05:01:52Z",
      "side": 1,
      "message": "Not needed.",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 24,
        "endChar": 49
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0ab763fa_622a7c00",
        "filename": "javatests/com/google/gerrit/acceptance/api/accounts/AccountManagerIT.java",
        "patchSetId": 6
      },
      "lineNbr": 24,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T07:51:43Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "afaa1d41_0d7f93fb",
      "range": {
        "startLine": 24,
        "startChar": 0,
        "endLine": 24,
        "endChar": 49
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d10f02b7_2f921d77",
        "filename": "javatests/com/google/gerrit/acceptance/api/accounts/AccountManagerIT.java",
        "patchSetId": 6
      },
      "lineNbr": 441,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-09-27T05:01:52Z",
      "side": 1,
      "message": "This doesn\u0027t seem to be needed. If I remove it the test still succeed.",
      "range": {
        "startLine": 441,
        "startChar": 2,
        "endLine": 441,
        "endChar": 15
      },
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3214bca6_dae45aa7",
        "filename": "javatests/com/google/gerrit/acceptance/api/accounts/AccountManagerIT.java",
        "patchSetId": 6
      },
      "lineNbr": 441,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-09-27T07:51:43Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d10f02b7_2f921d77",
      "range": {
        "startLine": 441,
        "startChar": 2,
        "endLine": 441,
        "endChar": 15
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "12c325a1eeae781d847b4da2276a448baad431a2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}