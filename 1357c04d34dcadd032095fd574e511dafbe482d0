{
  "comments": [
    {
      "key": {
        "uuid": "b69cbd42_be73708d",
        "filename": "polygerrit-ui/server.go",
        "patchSetId": 4
      },
      "lineNbr": 78,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-09-13T05:46:12Z",
      "side": 1,
      "message": "Interestingly, I had a different idea to pass in the absolute location from the polygerrit-ui/BUILD file, e.g.:\n\n  go_binary(\n    name \u003d \"server\",\n    srcs \u003d [\"server.go\"],\n    args \u003d [\"$(location //polygerrit-ui/app:test_components.zip)\"],\n\nand parse it here and extract the polygerrit-ui here from it, but then as an alternative, a different approach: Can\u0027t we just assume that the bazel run is issued from the current directory? Atr least on Bazel version: 0.18.0rc3 that worked:\n\n  if err :\u003d os.Chdir(\"polygerrit-ui\"); err !\u003d nil {\n                log.Fatal(err)\n  }\n\nas expected, here is the diff: [1], and here is the log:\n\n  $ bazel run //polygerrit-ui:server\n  INFO: Analysed target //polygerrit-ui:server (0 packages loaded).\n  INFO: Found 1 target...\n  Target //polygerrit-ui:server up-to-date:\n    bazel-bin/polygerrit-ui/linux_amd64_stripped/server\n  INFO: Elapsed time: 0.776s, Critical Path: 0.63s\n  INFO: 2 processes: 2 linux-sandbox.\n  INFO: Build completed successfully, 3 total actions\n  INFO: Build completed successfully, 3 total actions\n  2018/09/13 07:45:41 Serving on port :8081\n\n* [1] http://paste.openstack.org/show/730009",
      "range": {
        "startLine": 76,
        "startChar": 1,
        "endLine": 78,
        "endChar": 2
      },
      "revId": "1357c04d34dcadd032095fd574e511dafbe482d0",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d4cde389_b3bb5048",
        "filename": "polygerrit-ui/server.go",
        "patchSetId": 4
      },
      "lineNbr": 78,
      "author": {
        "id": 1027267
      },
      "writtenOn": "2018-09-13T21:48:39Z",
      "side": 1,
      "message": "I\u0027ve kept the logic that sets the working directory to $BUILD_WORKSPACE_DIRECTORY/polygerrit-ui/app. This is so that local modifications to html/js files under the app directory are immediately served without restarting the server.\n\nI don\u0027t see an args attr documented for the go_binary rule. Does it exist? That would be nice. My existing approach of using the argv[0] path is certainly brittle. I could reconstruct the bazel-bin path relative to the workspace, I think there are some go toolchain variables I need to incorporate into the path (e.g. on my machine it\u0027s bazel-bin/polygerrit-ui/linux_amd64_stripped/devserver.runfiles).",
      "parentUuid": "b69cbd42_be73708d",
      "range": {
        "startLine": 76,
        "startChar": 1,
        "endLine": 78,
        "endChar": 2
      },
      "revId": "1357c04d34dcadd032095fd574e511dafbe482d0",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "27f9542d_aaa4dc80",
        "filename": "polygerrit-ui/server.go",
        "patchSetId": 4
      },
      "lineNbr": 110,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-09-13T04:55:06Z",
      "side": 1,
      "message": "This doesn\u0027t work. This process already started from Bazel. In my case, Bazel 0.18.rc3 is used I\u0027m getting wrong workspace resolved:\n\n  $ bazel run //polygerrit-ui:server\n  INFO: Analysed target //polygerrit-ui:server (0 packages loaded).\n  INFO: Found 1 target...\n  Target //polygerrit-ui:server up-to-date:\n    bazel-bin/polygerrit-ui/linux_amd64_stripped/server\n  INFO: Elapsed time: 0.794s, Critical Path: 0.65s\n  INFO: 2 processes: 2 linux-sandbox.\n  INFO: Build completed successfully, 3 total actions\n  INFO: Build completed successfully, 3 total actions\n  2018/09/13 06:37:10 bazel info workspace:  /home/davido\n  2018/09/13 06:37:10 Workspace directory:  /home/davido\n  2018/09/13 06:37:10 chdir /home/davido/polygerrit-ui: no such file or directory\n\nI added some diagnostic output.\n\nHere is a similar question how to figure out workspace directory from within the build rule:[1].\n\nTo make that change work, I turned workspace to input parameter: [2] and invoked it like this:\n\n  $ bazel run //polygerrit-ui:server -- -workspace\u003d/home/davido/projects/gerrit\n\n* [1] https://stackoverflow.com/questions/48545575/how-to-get-workspace-directory-in-bazel-rule\n* [2] http://paste.openstack.org/show/730008",
      "range": {
        "startLine": 110,
        "startChar": 1,
        "endLine": 110,
        "endChar": 50
      },
      "revId": "1357c04d34dcadd032095fd574e511dafbe482d0",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "50284f0c_e07c39b2",
        "filename": "polygerrit-ui/server.go",
        "patchSetId": 4
      },
      "lineNbr": 110,
      "author": {
        "id": 1027267
      },
      "writtenOn": "2018-09-13T21:48:39Z",
      "side": 1,
      "message": "I was playing around with the --script_path argument to bazel run, and it looks like bazel does chdir to the .runfiles/gerrit directory. It also exports a couple of useful environment variables.\n\nI\u0027ve modified the server to use BUILD_WORKSPACE_DIRECTORY instead of running \"bazel info.\" I\u0027ve also brought back run_server.sh, which uses bazel run --script_path so we can release the bazel lock while the server is running.",
      "parentUuid": "27f9542d_aaa4dc80",
      "range": {
        "startLine": 110,
        "startChar": 1,
        "endLine": 110,
        "endChar": 50
      },
      "revId": "1357c04d34dcadd032095fd574e511dafbe482d0",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}