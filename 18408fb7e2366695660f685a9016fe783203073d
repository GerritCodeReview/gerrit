{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "83cbaad4_f961efe5",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesCache.java",
        "patchSetId": 1
      },
      "lineNbr": 379,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-11T11:55:54Z",
      "side": 0,
      "message": "I am puzzled by this assignment: this is a side-effect outside the contract of the loader.\n\nThe `Loader.call()` contract is to load the value from the persistence layer, how come that stores the revision note map as instance variable shared across threads?",
      "range": {
        "startLine": 379,
        "startChar": 6,
        "endLine": 379,
        "endChar": 52
      },
      "revId": "18408fb7e2366695660f685a9016fe783203073d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "508f689b_392d9ea1",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesCache.java",
        "patchSetId": 1
      },
      "lineNbr": 379,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T12:13:50Z",
      "side": 0,
      "message": "the `revisionNoteMap` is explicitly marked as _mutable and non-threadsafe_ in it\u0027s javadoc L345.\n\nAlso, the `Loader` _is not_ shared between threads, it is created in L406, and then immutable `ChangeNotesCache.Value` was used. Theoretically, it was all good... till 3.7 and external server account IDs ;)\n\nI can see this being a performance optimization, as we already read and loaded everything into memory, we can \"just\" reuse it, as it **was** the same as the data in the git repo.\n\nI can\u0027t tell how much of the performance boost that gave in the past. It seems that it is doubtful that `ChangUpdate` will populate the cache. At least in my testing, the cache was populated upfront.\n\nThe contract of cache mirroring git data is broken now, so we can\u0027t use this approach.",
      "parentUuid": "83cbaad4_f961efe5",
      "range": {
        "startLine": 379,
        "startChar": 6,
        "endLine": 379,
        "endChar": 52
      },
      "revId": "18408fb7e2366695660f685a9016fe783203073d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "84bf5079_bf07c5c2",
        "filename": "java/com/google/gerrit/server/notedb/ChangeUpdate.java",
        "patchSetId": 1
      },
      "lineNbr": 631,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-11T11:55:54Z",
      "side": 0,
      "message": "I believe this is the culprit: instead of reading the revision note map from the storage, we create one based on the one cached in the loader instance variable.\n\nCould we reduce this change to only this bit and still get the fix working?",
      "range": {
        "startLine": 628,
        "startChar": 0,
        "endLine": 631,
        "endChar": 7
      },
      "revId": "18408fb7e2366695660f685a9016fe783203073d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7cc53392_8cbc079a",
        "filename": "java/com/google/gerrit/server/notedb/ChangeUpdate.java",
        "patchSetId": 1
      },
      "lineNbr": 631,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T12:21:48Z",
      "side": 0,
      "message": "Yes, exactly that\u0027s the culprit. The rest of the change in the PS is just a cleanup of the code that is not needed anymore after this is removed.\n\nI will verify the simplified patch and get back to you.",
      "parentUuid": "84bf5079_bf07c5c2",
      "range": {
        "startLine": 628,
        "startChar": 0,
        "endLine": 631,
        "endChar": 7
      },
      "revId": "18408fb7e2366695660f685a9016fe783203073d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6607df33_ced70ec7",
        "filename": "javatests/com/google/gerrit/server/notedb/ChangeNotesTest.java",
        "patchSetId": 1
      },
      "lineNbr": 1968,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-11T11:55:54Z",
      "side": 0,
      "message": "Why do we need also to change the test? Was this added for triggering a side-effect in the way the change notes are loaded?",
      "revId": "18408fb7e2366695660f685a9016fe783203073d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "dfdbd2ab_f28ed9b2",
        "filename": "javatests/com/google/gerrit/server/notedb/ChangeNotesTest.java",
        "patchSetId": 1
      },
      "lineNbr": 1968,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T12:21:48Z",
      "side": 0,
      "message": "even before this change this was a \"dead code\", as the return value for `readNote` was never used. Sure it read the data from cache (that this change is removing now), but it wasn\u0027t testing anything.\n\nWe can\u0027t keep this code as with the other changes we\u0027ll get a compilation error in L3947, as the `notes.revisionNoteMap` is now removed.\n\nYes, we need this change in order to accommodate the code clean up after the fix.",
      "parentUuid": "6607df33_ced70ec7",
      "revId": "18408fb7e2366695660f685a9016fe783203073d",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}