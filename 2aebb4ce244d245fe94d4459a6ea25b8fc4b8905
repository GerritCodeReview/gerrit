{
  "comments": [
    {
      "key": {
        "uuid": "e9941f92_cb67c74f",
        "filename": "java/com/google/gerrit/server/schema/InMemoryAccountPatchReviewStore.java",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-20T06:56:26Z",
      "side": 1,
      "message": "IIRC, we had performance problems in the past and the reason was just that: we opened every time new H2 connections directly in the driver. H2 is not optimized for that use cases. If the only goal of this change is avoid dependency on gwtorm, can we use org.apache.commons.dbcp.BasicDataSource instead, that gerrit has a a dependency anyway?",
      "range": {
        "startLine": 43,
        "startChar": 10,
        "endLine": 43,
        "endChar": 55
      },
      "revId": "2aebb4ce244d245fe94d4459a6ea25b8fc4b8905",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "22cd2600_c17739e3",
        "filename": "java/com/google/gerrit/server/schema/InMemoryAccountPatchReviewStore.java",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-20T07:28:13Z",
      "side": 1,
      "message": "This is the source: [1]:\n\n\"\nKeep Connections Open or Use a Connection Pool\nIf your application opens and closes connections a lot (for example, for each request), you should consider using a connection pool. Opening a connection using DriverManager.getConnection is specially slow if the database is closed. By default the database is closed if the last connection is closed.\n\"\n\nOr this is only meant to be used in memory-only case, and in real JDBC use case we still use BasicDataSource? Then this should be fine.\n\n* [1] http://www.h2database.com/html/performance.html",
      "parentUuid": "e9941f92_cb67c74f",
      "range": {
        "startLine": 43,
        "startChar": 10,
        "endLine": 43,
        "endChar": 55
      },
      "revId": "2aebb4ce244d245fe94d4459a6ea25b8fc4b8905",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c3660d48_782a0e77",
        "filename": "java/com/google/gerrit/server/schema/InMemoryAccountPatchReviewStore.java",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2018-12-20T14:23:54Z",
      "side": 1,
      "message": "First of all this class is only for tests.\n\nSecond of all, here\u0027s the implementation of SimpleDataSource#getConnection():\n\n  // ctor has driver \u003d (Driver) Class.forName(name, true, loader).newInstance();\n\n  @Override\n  public Connection getConnection() throws SQLException {\n    if (driver !\u003d null) {\n      return driver.connect(url, connectionInfo);\n    }\n    return DriverManager.getConnection(url, connectionInfo);\n  }\n\nSo this is really just inlining the old implementation. (Unless you\u0027re concerned about calling load() each time which I don\u0027t think is what you\u0027re talking about.)\n\nOf course it\u0027s possible to use BasicDataSource. That would just be more code since we\u0027d have to either call a bunch of methods on it during setup or else set up the GerritServerConfig properly, whereas this is one line.\n\nIt\u0027s conceivable that using a connection pool in tests would be faster if we actually used the AccountPatchReviewStore frequently in tests, but I don\u0027t think we do.",
      "parentUuid": "22cd2600_c17739e3",
      "range": {
        "startLine": 43,
        "startChar": 10,
        "endLine": 43,
        "endChar": 55
      },
      "revId": "2aebb4ce244d245fe94d4459a6ea25b8fc4b8905",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9fa29ede_2a076854",
        "filename": "java/com/google/gerrit/server/schema/InMemoryAccountPatchReviewStore.java",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2018-12-20T14:55:51Z",
      "side": 1,
      "message": "\u003e That would just be more code\n\nI take that back. I think if we just set accountPatchReviewDb.url to the in-memory string in InMemoryModule, then we can delete this whole file, so that\u0027s definitely a win.",
      "parentUuid": "c3660d48_782a0e77",
      "range": {
        "startLine": 43,
        "startChar": 10,
        "endLine": 43,
        "endChar": 55
      },
      "revId": "2aebb4ce244d245fe94d4459a6ea25b8fc4b8905",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f9c58d6f_3e742cb6",
        "filename": "java/com/google/gerrit/server/schema/InMemoryAccountPatchReviewStore.java",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-20T15:13:05Z",
      "side": 1,
      "message": "+1. I confused the code path with real JDBC file. We had performance regression in the past, where opening connection on every call was around 1 second and we got complaint from Gerrit users on the repo-discuss. This is totaly unrelated to this change, though, because it\u0027s test and in memory code path.",
      "parentUuid": "9fa29ede_2a076854",
      "range": {
        "startLine": 43,
        "startChar": 10,
        "endLine": 43,
        "endChar": 55
      },
      "revId": "2aebb4ce244d245fe94d4459a6ea25b8fc4b8905",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "74cbbe0d_057757d6",
        "filename": "java/com/google/gerrit/server/schema/InMemoryAccountPatchReviewStore.java",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-20T15:37:27Z",
      "side": 1,
      "message": "I\u0027ve found the thread: [1] the issue: [2] and the fix: [3]. It made Gerrit 50 times faster with H2 on disk, to not use DriverManager.getConnection() but use DataSource instead.\n\n* [1] https://groups.google.com/d/topic/repo-discuss/AJsTjxfpUt4/discussion\n* [2] https://bugs.chromium.org/p/gerrit/issues/detail?id\u003d5906\n* [3] https://gerrit-review.googlesource.com/c/gerrit/+/101630",
      "parentUuid": "f9c58d6f_3e742cb6",
      "range": {
        "startLine": 43,
        "startChar": 10,
        "endLine": 43,
        "endChar": 55
      },
      "revId": "2aebb4ce244d245fe94d4459a6ea25b8fc4b8905",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}