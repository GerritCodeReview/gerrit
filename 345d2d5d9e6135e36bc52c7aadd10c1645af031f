{
  "comments": [
    {
      "key": {
        "uuid": "f62eb68f_4baac547",
        "filename": "gerrit-acceptance-framework/BUCK",
        "patchSetId": 3
      },
      "lineNbr": 6,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-11-02T22:06:13Z",
      "side": 1,
      "message": "You cannot do that, without adjusting this rule. This pulls tons of transitive dependencies for virtual all, in which case you would ship everything twice: in extension-api.jar and in acceptance-framework.jar. This is why ths size of the acceptance-framework.jar was increased from 10MB to 30 MB. I think what you want, is to swap the transitive deps to provided deps in //gerrit-openid:openid target, except //lib/openid:consumer jar. Untested, but this should fix it?\n\n  java_library(\n    name \u003d \u0027openid\u0027,\n    srcs \u003d glob([\u0027src/main/java/**/*.java\u0027]),\n    resources \u003d glob([\u0027src/main/resources/**/*\u0027]),\n    deps \u003d [\n      \u0027//lib/openid:consumer\u0027\n    ],\n    provided_deps \u003d [\n      \u0027//gerrit-common:annotations\u0027,\n      \u0027//gerrit-common:server\u0027,\n      \u0027//gerrit-extension-api:api\u0027,\n      \u0027//gerrit-gwtexpui:server\u0027,\n      \u0027//gerrit-httpd:httpd\u0027,\n      \u0027//gerrit-reviewdb:server\u0027,\n      \u0027//gerrit-server:server\u0027,\n      \u0027//lib:guava\u0027,\n      \u0027//lib:gwtorm\u0027,\n      \u0027//lib:servlet-api-3_1\u0027,\n      \u0027//lib/guice:guice-servlet\u0027,\n      \u0027//lib/jgit:jgit\u0027,\n      \u0027//lib/log:api\u0027,\n    ],\n    visibility \u003d [\u0027PUBLIC\u0027],\n  )\n\nAlso I think it would make sense to do this change in extra commit.",
      "range": {
        "startLine": 6,
        "startChar": 3,
        "endLine": 6,
        "endChar": 25
      },
      "revId": "345d2d5d9e6135e36bc52c7aadd10c1645af031f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "96f2da53_4045ee96",
        "filename": "gerrit-acceptance-framework/BUCK",
        "patchSetId": 3
      },
      "lineNbr": 6,
      "author": {
        "id": 1012732
      },
      "writtenOn": "2015-11-03T14:30:26Z",
      "side": 1,
      "message": "Thx David. Two questions then please:\n\n1. When making deps as provided_deps such as above, I often wonder about the potential negative side effects this can have on libs depending on such \"nodep\u0027ed\" libs. In order to properly test a change such as above with openid, is it enough to rebuild all from clean, init then load a test-site (incl. buck test --all)? -I\u0027d basically worry about potentially missing some deps in some run-time contexts.\n\n2. I\u0027m asking that for the above openid fix, but also for the other dep I added, gerrit-server/src/main/prolog:common. The latter \"deps\" on gerrit-server:server, which in turn deps on many dependencies that can also grow e.g. the acceptance lib inappropriately. There is even a TODO above the latter java_library about having to split that one too... Your thoughts on adding that (needful) prolog dep then? -Thx again! \u003d)",
      "parentUuid": "f62eb68f_4baac547",
      "range": {
        "startLine": 6,
        "startChar": 3,
        "endLine": 6,
        "endChar": 25
      },
      "revId": "345d2d5d9e6135e36bc52c7aadd10c1645af031f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f62eb68f_eb6df1db",
        "filename": "gerrit-acceptance-framework/BUCK",
        "patchSetId": 3
      },
      "lineNbr": 6,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-11-03T16:17:17Z",
      "side": 1,
      "message": "| 1. When making deps as provided_deps such as above, I often wonder about the potential negative side effects this can have on libs depending on such \"nodep\u0027ed\" libs.\n\nThat\u0027s very good question. In the end the deps should be included in gerrit.war. That why war depends on openid:\n\n  $ git grep gerrit-openid:openid\n  gerrit-pgm/BUCK:  \u0027//gerrit-openid:openid\u0027,\n  gerrit-war/BUCK:    \u0027//gerrit-openid:openid\u0027,\n\nSo if you would move all the transitive deps from //gerrit-openid:openid rule to provided_deps, gerrit.war would be broken, because //lib/openid:consumer would be lost. So the question is how do you know, that all other deps can be moved to provided_deps, because they already would be pull in gerrit.war by other deps but the //lib/openid:consumer is really needed and must stay as a transitive dependency? The answer is experience. I\u0027m also not sure if it would be enough to just load a test site, or even tat even `buck test` would trigger the code in question so that the missing runtime dependency would be noticed. One thing that work for sure, is `buck build gerrit` before your change and `buck build gerrit` after your change should list the same libraries in WEB-INF/lib of gerrit.war.\n\n| 2. I\u0027m asking that for the above openid fix, but also for the other dep I added, gerrit-server/src/main/prolog:common.\n\ngerrit-acceptance-framework must not depend on gerrit-server transitively as you have noticed.",
      "parentUuid": "96f2da53_4045ee96",
      "range": {
        "startLine": 6,
        "startChar": 3,
        "endLine": 6,
        "endChar": 25
      },
      "revId": "345d2d5d9e6135e36bc52c7aadd10c1645af031f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "16342adb_ec862bca",
        "filename": "gerrit-pgm/BUCK",
        "patchSetId": 3
      },
      "lineNbr": 106,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-11-02T22:06:13Z",
      "side": 1,
      "message": "This should be named http-jetty. Check:\n\n  $ jar -tf buck-out/gen/headless/headless.war | grep --regex \u0027.*pgm.*\u0027\n  WEB-INF/lib/gerrit-pgm-init-api.jar\n  WEB-INF/lib/gerrit-pgm-util-nodep.jar\n  WEB-INF/lib/gerrit-pgm-init.jar\n  WEB-INF/lib/gerrit-pgm-pgm-jetty.jar\n\nSo that we get gerrit-pgm-http-jetty.jar instead of gerrit-pgm-pgm-jetty.jar. Commit message and other places sould be adapted as well.",
      "range": {
        "startLine": 106,
        "startChar": 10,
        "endLine": 106,
        "endChar": 19
      },
      "revId": "345d2d5d9e6135e36bc52c7aadd10c1645af031f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "96f2da53_204aeaa8",
        "filename": "gerrit-pgm/BUCK",
        "patchSetId": 3
      },
      "lineNbr": 106,
      "author": {
        "id": 1012732
      },
      "writtenOn": "2015-11-03T14:30:26Z",
      "side": 1,
      "message": "Agreed; will be done asap.",
      "parentUuid": "16342adb_ec862bca",
      "range": {
        "startLine": 106,
        "startChar": 10,
        "endLine": 106,
        "endChar": 19
      },
      "revId": "345d2d5d9e6135e36bc52c7aadd10c1645af031f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}