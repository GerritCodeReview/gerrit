{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "126bf2ca_4ae4ace9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-02-06T01:30:54Z",
      "side": 1,
      "message": "Missing test.",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fca2e780_87b0299e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2021-04-12T15:18:32Z",
      "side": 1,
      "message": "Gerrit has already zillion of tests with serializing/de-serializing of events and all those tests are passing with this change.",
      "parentUuid": "126bf2ca_4ae4ace9",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3fe82dfa_573f0072",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-04-13T01:52:49Z",
      "side": 1,
      "message": "True, but if we get rid of this code and the tests are still passing, that means this code is NOT useful and people may be tempted to remove it.\n\nI tried to just invert the check at L31 and the tests are still green, which doesn\u0027t look right to me.\n\nLooking carefully at EventJsonTest, we do indeed miss a test for the serialisation of a generic Event.class. Adding that test, then the breakage comes out.\n\nGerrit multi-site isn\u0027t a core plugin and it won\u0027t be obvious for people to realise they are breaking it. Adding one simple test would avoid these problems and allow to save a lot more time in the future.\n\nSample test:\n\n  public static class CustomEvent extends Event {\n\t  public static String TYPE \u003d \"custom-type\";\n\n\tprotected CustomEvent() {\n\t\tsuper(TYPE);\n\t} \n  }\n  \n  @Test\n  public void genericEvent() {\n\t  EventTypes.register(CustomEvent.TYPE, CustomEvent.class);  \n\t  Event event \u003d new CustomEvent();\n    \n    String json \u003d gson.toJson(event, Event.class);\n    Map\u003cObject, Object\u003e map \u003d\n        gson.fromJson(json, new TypeToken\u003cMap\u003cObject, Object\u003e\u003e() {}.getType());\n    assertThat(map.values()).contains(CustomEvent.TYPE);\n  }\n\nWDYT?",
      "parentUuid": "fca2e780_87b0299e",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3bbc4345_b1ff4806",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-04-15T00:23:35Z",
      "side": 1,
      "message": "Ping @DavidO?",
      "parentUuid": "3fe82dfa_573f0072",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c11c9512_5e692285",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2021-04-16T06:35:47Z",
      "side": 1,
      "message": "I added your test for custom event serialization in its own change 303514. As explained in the commit of this change message: custom events serialization works as-is in:\n\n* gerrit core\n* gerrit plugin\n\nI tried to explain in the commit message, the problem only shows up in inter-plugin communication scenario. Because the plugins have isolated classloader. Class for custom event created in one plugin is not accessible in another plugin.\n\nWhat this change is actually doing is kind of Plugin API, where we create a custom event class in plugin A, register this event in gerrit core using:\n\n  EventTypes.register(CustomEvent.TYPE, CustomEvent.class);\n\nand try to use that class and serialize the event instance as JSON in plugin B.\n\n\u003e Gerrit multi-site isn\u0027t a core plugin and it won\u0027t be obvious for people to realise they are breaking it. \n\nBut we added the multi-site related usage annotation:\n\n  @UsedAt(UsedAt.Project.PLUGIN_MULTI_SITE)\n  class EventSerializer implements JsonSerializer\u003cEvent\u003e {\n  [...]\n\nMy understanding is, it cannot be removed, until multi-site plugin is discontinued, isn\u0027t it?",
      "parentUuid": "3bbc4345_b1ff4806",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b1f5c84c_30249afb",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-04-17T02:07:41Z",
      "side": 1,
      "message": "The test in  change 303514 is wrong (I forgot to add some elements when I suggested it) and it could not be green without this fix.\n\nThe serialisation of custom event types is broken, without this change.",
      "parentUuid": "c11c9512_5e692285",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33c7fa45_94ac574e",
        "filename": "java/com/google/gerrit/server/events/EventSerializer.java",
        "patchSetId": 3
      },
      "lineNbr": 23,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-02-06T01:30:38Z",
      "side": 1,
      "message": "We should add the @UsedAt(), otherwise someone may just drop this class in the next commit because it is unused.",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a217ed2d_e4a99bd6",
        "filename": "java/com/google/gerrit/server/events/EventSerializer.java",
        "patchSetId": 3
      },
      "lineNbr": 23,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2021-04-12T15:18:32Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "33c7fa45_94ac574e",
      "revId": "40497523fef3e3c3fa9d1673f5ef80053de3ffb3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}