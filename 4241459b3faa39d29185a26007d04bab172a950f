{
  "comments": [
    {
      "key": {
        "uuid": "4175d075_15991488",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_102.java",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-12-25T09:22:59Z",
      "side": 1,
      "message": "Investigating development H2 schema for this table reveals that other indices contain sort_key column as well:\n\n  CHANGES_ALLCLOSED (OPEN, STATUS, SORT_KEY)\n  CHANGES_ALLOPEN (OPEN, SORT_KEY)\n  CHANGES_BYBRANCHCLOSED (STATUS, DEST_PROJECT_NAME, DEST_BRANCH_NAME, SORT_KEY)",
      "range": {
        "startLine": 40,
        "startChar": 26,
        "endLine": 40,
        "endChar": 58
      },
      "revId": "4241459b3faa39d29185a26007d04bab172a950f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "61781470_36137852",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_102.java",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-12-25T09:26:43Z",
      "side": 1,
      "message": "With the consequence, that upgrade is failing and that the table changes still contains sort_key column\n\n  gerrit\u003e \\d CHANGES\n                     Table CHANGES\n COLUMN_NAME          | TYPE\n ---------------------+---------------------------------\n CHANGE_KEY           | VARCHAR(60) DEFAULT \u0027\u0027 NOT NULL\n CREATED_ON           | TIMESTAMP NOT NULL\n CURRENT_PATCH_SET_ID | INTEGER DEFAULT 0 NOT NULL\n DEST_BRANCH_NAME     | VARCHAR(255) DEFAULT \u0027\u0027 NOT NULL\n DEST_PROJECT_NAME    | VARCHAR(255) DEFAULT \u0027\u0027 NOT NULL\n LAST_UPDATED_ON      | TIMESTAMP NOT NULL\n OPEN                 | CHAR(1) DEFAULT \u0027N\u0027 NOT NULL\n OWNER_ACCOUNT_ID     | INTEGER DEFAULT 0 NOT NULL\n SORT_KEY             | VARCHAR(16) DEFAULT \u0027\u0027 NOT NULL\n STATUS               | CHAR(1) DEFAULT \u0027 \u0027 NOT NULL\n SUBJECT              | VARCHAR(255) DEFAULT \u0027\u0027 NOT NULL\n TOPIC                | VARCHAR(255)\n ROW_VERSION          | INTEGER DEFAULT 0 NOT NULL\n CHANGE_ID            | INTEGER DEFAULT 0 NOT NULL\n\neven though the version was upgraded:\n\n  gerrit\u003e select VERSION_NBR from SCHEMA_VERSION;\n VERSION_NBR\n -----------\n 102\n(1 row; 1 ms)",
      "parentUuid": "4175d075_15991488",
      "range": {
        "startLine": 40,
        "startChar": 26,
        "endLine": 40,
        "endChar": 58
      },
      "revId": "4241459b3faa39d29185a26007d04bab172a950f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4175d075_d50b1c17",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_102.java",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-12-25T17:43:26Z",
      "side": 1,
      "message": "Found the root cause: in [1] three indices were removed in SQL scripts but missed to be dropped in the database.\n\n[1] https://gerrit-review.googlesource.com/52078",
      "parentUuid": "61781470_36137852",
      "range": {
        "startLine": 40,
        "startChar": 26,
        "endLine": 40,
        "endChar": 58
      },
      "revId": "4241459b3faa39d29185a26007d04bab172a950f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "61781470_b62f8878",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_102.java",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-12-25T21:05:59Z",
      "side": 1,
      "message": "Fixed in [1].\n\n [1] https://gerrit-review.googlesource.com/62758",
      "parentUuid": "4175d075_d50b1c17",
      "range": {
        "startLine": 40,
        "startChar": 26,
        "endLine": 40,
        "endChar": 58
      },
      "revId": "4241459b3faa39d29185a26007d04bab172a950f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ee0eb1b4_aa9f6f6c",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_102.java",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-01-09T16:16:53Z",
      "side": 1,
      "message": "As pointed out on this thread: [1] this statement is wrong for MySQL dialect. This should have been:\n\n  String stmt \u003d \"DROP INDEX changes_byProjectOpen\";\n  if (dialect instanceof DialectMySQL) {\n    stmt.executeUpdate(stmt + \" on changes\");\n  } else {\n    stmt.executeUpdate(stmt);\n  }\n\ninstead.\n\n* [1] https://groups.google.com/d/topic/repo-discuss/vJhoxNnfcHQ/discussion",
      "range": {
        "startLine": 40,
        "startChar": 6,
        "endLine": 40,
        "endChar": 23
      },
      "revId": "4241459b3faa39d29185a26007d04bab172a950f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0ee06512_eb1a1197",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_102.java",
        "patchSetId": 5
      },
      "lineNbr": 40,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2015-01-09T16:20:33Z",
      "side": 1,
      "message": "Oops, sorry about that.\n\nThis is too easy to screw up, it\u0027s used in several places, and I plan to drop more indexes soon. I\u0027m going to add a method in gwtorm.",
      "parentUuid": "ee0eb1b4_aa9f6f6c",
      "range": {
        "startLine": 40,
        "startChar": 6,
        "endLine": 40,
        "endChar": 23
      },
      "revId": "4241459b3faa39d29185a26007d04bab172a950f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4175d075_f5a3b8b2",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/schema/Schema_102.java",
        "patchSetId": 5
      },
      "lineNbr": 50,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-12-25T09:22:59Z",
      "side": 1,
      "message": "Upgrade to 102 is failing here on H2:\n\n  Exception in thread \"main\" com.google.gwtorm.server.OrmException: Cannot apply SQL\nALTER TABLE changes DROP COLUMN sort_key\n\tat com.google.gwtorm.jdbc.JdbcExecutor.execute(JdbcExecutor.java:44)\n\tat com.google.gerrit.pgm.init.BaseInit$SiteRun.upgradeSchema(BaseInit.java:313)\n\tat com.google.gerrit.pgm.init.BaseInit.run(BaseInit.java:111)\n\tat com.google.gerrit.pgm.util.AbstractProgram.main(AbstractProgram.java:64)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat com.google.gerrit.launcher.GerritLauncher.invokeProgram(GerritLauncher.java:166)\n\tat com.google.gerrit.launcher.GerritLauncher.mainImpl(GerritLauncher.java:93)\n\tat com.google.gerrit.launcher.GerritLauncher.main(GerritLauncher.java:50)\n\tat Main.main(Main.java:25)\nCaused by: org.h2.jdbc.JdbcSQLException: Column may be referenced by \"PUBLIC.CHANGES_ALLOPEN\"; SQL statement:\nALTER TABLE changes DROP COLUMN sort_key [90083-174]\n\tat org.h2.message.DbException.getJdbcSQLException(DbException.java:332)\n\tat org.h2.message.DbException.get(DbException.java:172)\n\tat org.h2.message.DbException.get(DbException.java:149)\n\tat org.h2.table.Table.dropSingleColumnConstraintsAndIndexes(Table.java:553)\n\tat org.h2.command.ddl.AlterTableAlterColumn.update(AlterTableAlterColumn.java:163)\n\tat org.h2.command.CommandContainer.update(CommandContainer.java:79)\n\tat org.h2.command.Command.executeUpdate(Command.java:253)\n\tat org.h2.jdbc.JdbcStatement.executeInternal(JdbcStatement.java:181)\n\tat org.h2.jdbc.JdbcStatement.execute(JdbcStatement.java:156)\n\tat com.google.gwtorm.jdbc.JdbcExecutor.execute(JdbcExecutor.java:42)\n\t... 11 more",
      "revId": "4241459b3faa39d29185a26007d04bab172a950f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}