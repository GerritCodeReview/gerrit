{
  "comments": [
    {
      "key": {
        "uuid": "b154dfd0_9be687ea",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 9,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2018-11-22T09:50:45Z",
      "side": 1,
      "message": "perhaps \"this\" or \"the\" instead of \"those\" would be more appropriate",
      "range": {
        "startLine": 9,
        "startChar": 58,
        "endLine": 9,
        "endChar": 63
      },
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3088cc36_ebfd7b25",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 13,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2018-11-22T09:50:45Z",
      "side": 1,
      "message": "Did you mean to say \"adapts\" instead of \"adopts\"?\nHow about: \"this commit makes the code compatible with servlet-api v2.5\"",
      "range": {
        "startLine": 13,
        "startChar": 12,
        "endLine": 13,
        "endChar": 29
      },
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fe406b73_e091e671",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 161,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2018-11-22T09:50:45Z",
      "side": 1,
      "message": "What\u0027s the reason of this change? is this just a stylistic refactoring?",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3bef1496_c7ee1b68",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 317,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2018-11-23T09:08:42Z",
      "side": 1,
      "message": "BTW, this audit is actually at wrong place: we should put the finally after the next.doFilter() and give a HttpServletResponseWrapper to capture the status code without relying on Servlet 3.0.\n\nLet me propose an alternative fix to this :-)",
      "range": {
        "startLine": 317,
        "startChar": 8,
        "endLine": 317,
        "endChar": 29
      },
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d1b72f3d_025e6431",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 326,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2018-11-22T09:50:45Z",
      "side": 1,
      "message": "Wouldn\u0027t this always generate a FORBIDDEN audit event, regardless the actual response result?",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b245e283_22c74d31",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 326,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2018-11-22T10:12:32Z",
      "side": 1,
      "message": "Yes, we have to call auditService.dispatch twice for the different cases, once for SUCCESS and once for FORBIDDEN.\n\nWe can do that easily without using the Servlet 3 getStatusCode by just passing the respective code directly.",
      "parentUuid": "d1b72f3d_025e6431",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0466ec9c_c03ae28d",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 326,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2018-11-22T10:51:03Z",
      "side": 1,
      "message": "yep exactly,\nPerhaps we can still call the dispatch only once (in the finally), but set statusCode to SC_FORBIDDEN in the catch block accordingly.",
      "parentUuid": "b245e283_22c74d31",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "23e0b8fd_13567771",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 326,
      "author": {
        "id": 1031898
      },
      "writtenOn": "2018-11-22T16:41:31Z",
      "side": 1,
      "message": "I start thinking whether this \"dispatch\" is WAI.\n\nThis \"dispatch\" is contained in the \"finally\" block which will always be executed for both SUCCESS and ERROR. However, this is just one filter in the FilerChain. In the SUCCESS case, the request will be forwarded to the next filter which means we may send multiple audit events for one request. Also the \"status\" code is not set for the \"ServerException\" case line#313. Is this WAI?\n\nThe commit is wrong because the \"errorStatusCode\" is only set in one catch block, we don\u0027t set it for other execute path.\n\nHow do you think?",
      "parentUuid": "0466ec9c_c03ae28d",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c73eb8cd_4e7fc746",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 326,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2018-11-22T18:10:48Z",
      "side": 1,
      "message": "yep, the dispatch is in the \"finally\" block exactly for this reason, we want to audit the fact the action occurred regardless of its result, so we always want to execute the dispatch.\n\nIf different filters in the chain intend to audit a specific action, then yes, there will be different audit events for one request, even though this is not the case at the moment, I think it would be perfectly fine.\n\nThe ServletException thrown at line#313 will not prevent the \"finally\" block from running. We can just decide what http status code is most representative for this case (perhaps an 500 is a good representation of ServletException?).\n\nSo for what I can tell the spectrum of http response codes could be:\n200 OK\n403 FORBIDDEN (when AuthException)\n500 INTERNAL SERVER ERROR (when PermissionBackendException)",
      "parentUuid": "23e0b8fd_13567771",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "840dbf8f_e1f353fc",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 326,
      "author": {
        "id": 1031898
      },
      "writtenOn": "2018-11-22T18:32:42Z",
      "side": 1,
      "message": "\u003e yep, the dispatch is in the \"finally\" block exactly for this reason, we want to audit the fact the action occurred regardless of its result, so we always want to execute the dispatch.\n\u003e \n\u003e If different filters in the chain intend to audit a specific action, then yes, there will be different audit events for one request, even though this is not the case at the moment, I think it would be perfectly fine.\n\u003e \n\u003e The ServletException thrown at line#313 will not prevent the \"finally\" block from running. We can just decide what http status code is most representative for this case (perhaps an 500 is a good representation of ServletException?).\n\u003e \n\u003e So for what I can tell the spectrum of http response codes could be:\n\u003e 200 OK\n\nI\u0027m a little bit concerned for this case because here we only successfully execute one permission check, it doesn\u0027t mean the response code should be \"200 OK\". If we do like this, the audit will like \"200 OK\" here but then later become something else, e.g. 404. \n\nIs \"200 OK\" what you would like to see in your audits in this case?\n\n\u003e 403 FORBIDDEN (when AuthException)\n\u003e 500 INTERNAL SERVER ERROR (when PermissionBackendException)",
      "parentUuid": "c73eb8cd_4e7fc746",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e65038fb_ed5f7bcc",
        "filename": "gerrit-httpd/src/main/java/com/google/gerrit/httpd/GitOverHttpServlet.java",
        "patchSetId": 3
      },
      "lineNbr": 437,
      "author": {
        "id": 1072905
      },
      "writtenOn": "2018-11-22T09:50:45Z",
      "side": 1,
      "message": "as above, wouldn\u0027t this always dispatch a FORBIDDEN audit log, even in case of success.",
      "revId": "44a54836a4028acfbb3402408e9a8bf32330312e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}