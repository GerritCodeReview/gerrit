{
  "comments": [
    {
      "key": {
        "uuid": "dec0c672_a9c4fdbc",
        "filename": "/COMMIT_MSG",
        "patchSetId": 16
      },
      "lineNbr": 10,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-01-27T21:42:00Z",
      "side": 1,
      "message": "I\u0027m not really following your analysis. Zuul or whatever client access Gerrit endpoint and GitOverHttpModule is binding this URL here:\n\n  if (downloadConfig.getDownloadSchemes().contains(CoreDownloadSchemes.ANON_HTTP)\n        || downloadConfig.getDownloadSchemes().contains(CoreDownloadSchemes.HTTP)) {\n      filterRegex(URL_REGEX).through(GerritAuthModule.retreiveAuthFilterFromConfig(authConfig));\n      serveRegex(URL_REGEX).with(GitOverHttpServlet.class);\n    }\n\nGitOverHttpServlet.java:99\n\n  \"^(?:/a)?(?:/p/|/)(.*/(?:info/refs|git-upload-pack|git-receive-pack))\"\n\nPolyGerrit Static Module is bound as the last one in Daemon for reason:\n\n    private Injector createWebInjector() {\n    final List\u003cModule\u003e modules \u003d new ArrayList\u003c\u003e();\n    if (sshd) {\n      modules.add(new ProjectQoSFilter.Module());\n    }\n    modules.add(RequestContextFilter.module());\n    modules.add(RequestMetricsFilter.module());\n    modules.add(H2CacheBasedWebSession.module());\n    modules.add(sysInjector.getInstance(GerritAuthModule.class));\n    modules.add(sysInjector.getInstance(GitOverHttpModule.class));\n    [...]\n    // StaticModule contains a \"/*\" wildcard, place it last.\n    GerritOptions opts \u003d sysInjector.getInstance(GerritOptions.class);\n    if (opts.enableMasterFeatures()) {\n      modules.add(sysInjector.getInstance(StaticModule.class));\n    }\n\nThat why if \"^(?:/a)?(?:/p/|/)(.*/(?:info/refs|git-upload-pack|git-receive-pack))\" is matched by GitOverHttpServlet, it should be handled by this servlet and the request is not processed further by the servlet pipeline.\n\nCan you try to track down, what exactly request is failing in Zuul? What URL is it?",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 42
      },
      "revId": "458b4ff64adae152b74ae348c2d21823daf494de",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "30b4f1be_6443de20",
        "filename": "/COMMIT_MSG",
        "patchSetId": 16
      },
      "lineNbr": 10,
      "author": {
        "id": 1029953
      },
      "writtenOn": "2019-01-27T22:10:36Z",
      "side": 1,
      "message": "The url that is failing is:\n\nhttps://gerrit.git.wmflabs.org/r/p/testing/test/info/refs?service\u003dgit-upload-pack\n\nThough i\u0027ve recently found out the problem was due to me mixing http and https, but the logs are spamming with it not being able to use this endpoint so it uses it for something.\n\nBut when i return false in matchPath it works.\n\n\n      if (isPolyGerritIndex(path, req)) {\n        polyGerritIndex.service(reqWrapper, res);\n        return;\n      }\n\nsince polygerrit does that if it returns true.\n\nHere\u0027s the log i got:\n\n2019-01-27 17:47:17,455 INFO zuul.IndependentPipelineManager: Reporting item \u003cQueueItem 0x7fb3a9bfc550 for \u003cChange 0x7fb3a99ab450 2181,1\u003e in test\u003e, actions: [\u003cGerritReporter connection: gerrit://gerrit\u003e]\n2019-01-27 17:47:17,470 ERROR zuul.source.Gerrit: Exception looking for ref refs/heads/master\nTraceback (most recent call last):\n  File \"/usr/share/python/zuul/local/lib/python2.7/site-packages/zuul/source/gerrit.py\", line 49, in getRefSha\n    refs \u003d self.connection.getInfoRefs(project)\n  File \"/usr/share/python/zuul/local/lib/python2.7/site-packages/zuul/connection/gerrit.py\", line 409, in getInfoRefs\n    raise Exception(\"Gerrit repository does not support \"\nException: Gerrit repository does not support git-upload-pack\n\nwhich in version 2.x is:\n\nhttps://github.com/openstack-infra/zuul/blob/2.6.0/zuul/connection/gerrit.py#L410",
      "parentUuid": "dec0c672_a9c4fdbc",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 42
      },
      "revId": "458b4ff64adae152b74ae348c2d21823daf494de",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "48fc45ef_e7ea7238",
        "filename": "/COMMIT_MSG",
        "patchSetId": 16
      },
      "lineNbr": 10,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-01-27T22:32:27Z",
      "side": 1,
      "message": "Does changing the URL in Zuul to remove /p part fixed the problem?\n\n  wget https://gerrit.git.wmflabs.org/r/testing/test/info/refs?service\u003dgit-upload-pack\n\n? Note, that /p part is option here: \"^(?:/a)?(?:/p/|/)(.*/(?:info/refs|git-upload-pack|git-receive-pack))\"",
      "parentUuid": "30b4f1be_6443de20",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 42
      },
      "revId": "458b4ff64adae152b74ae348c2d21823daf494de",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f42e85e4_827eec21",
        "filename": "/COMMIT_MSG",
        "patchSetId": 16
      },
      "lineNbr": 10,
      "author": {
        "id": 1029953
      },
      "writtenOn": "2019-01-27T23:20:21Z",
      "side": 1,
      "message": "Ah yes.",
      "parentUuid": "48fc45ef_e7ea7238",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 42
      },
      "revId": "458b4ff64adae152b74ae348c2d21823daf494de",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a05db09a_b2354a24",
        "filename": "/COMMIT_MSG",
        "patchSetId": 16
      },
      "lineNbr": 10,
      "author": {
        "id": 1029953
      },
      "writtenOn": "2019-01-27T23:27:09Z",
      "side": 1,
      "message": "I\u0027ve filed this https://phabricator.wikimedia.org/T214807 downstream.",
      "parentUuid": "f42e85e4_827eec21",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 42
      },
      "revId": "458b4ff64adae152b74ae348c2d21823daf494de",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "28968d64_f037d44f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 16
      },
      "lineNbr": 10,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-01-27T23:30:19Z",
      "side": 1,
      "message": "Well, something still strange here on the WMF side.\n\nOn googlesource.com both versions work:\n\n  wget https://gerrit-review.googlesource.com/p/plugins/oauth/info/refs?service\u003dgit-upload-pack -O refs_with_p.txt\n  wget https://gerrit-review.googlesource.com/plugins/oauth/info/refs?service\u003dgit-upload-pack -O refs_without_p.txt\n\nOn WMF, on stable-2.15 both versions are working, but on stable-2.16 only version without /p. That\u0027s weird.",
      "parentUuid": "a05db09a_b2354a24",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 42
      },
      "revId": "458b4ff64adae152b74ae348c2d21823daf494de",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "93eaec61_f307f575",
        "filename": "/COMMIT_MSG",
        "patchSetId": 16
      },
      "lineNbr": 10,
      "author": {
        "id": 1029953
      },
      "writtenOn": "2019-01-27T23:49:38Z",
      "side": 1,
      "message": "I get 400 when going to https://gerrit-review.googlesource.com/p/plugins/oauth/info/refs?service\u003dgit-upload-pack",
      "parentUuid": "28968d64_f037d44f",
      "range": {
        "startLine": 9,
        "startChar": 0,
        "endLine": 10,
        "endChar": 42
      },
      "revId": "458b4ff64adae152b74ae348c2d21823daf494de",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}