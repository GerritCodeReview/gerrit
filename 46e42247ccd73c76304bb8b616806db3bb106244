{
  "comments": [
    {
      "key": {
        "uuid": "cdb85f07_dc303cbb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-05T13:16:43Z",
      "side": 1,
      "message": "Can we turn this around? When a user uses the UI, they would first upload the new PS and then hit \u0027publish\u0027. The reason is that as a reviewer publishing the comment resolves it (if specified) when I see a resolved comment, I expect the code to have changed. So it feels more natural to first update the code and only then declare comments to be done.",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 15,
        "endChar": 43
      },
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3b648fc1_1a8d6dbe",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-10T18:34:15Z",
      "side": 1,
      "message": "I think you mean the UI ordering here (just change the ordering and show the uploaded PS ID message first).\n\nI think from a chronological ordering perspective, a user replies to the reviewers comments on the old patch set, and uploads a change that generates a new PS. So the current order is in increasing PS ID.\n\nFrom an implementation POV, as I understand, \"BatchUpdate\" line 574 orders the NoteDb operations using the PS ID, which always makes the comments committed to NoteDb first (they have a lower PS ID). Since I do both operations in one BU I can\u0027t override the ordering (but I can try 2 separate batch updates though).\n\nFrom a reviewer\u0027s perspective, they would see both the comments and the uploaded patchset message simultaneously (and the author will also do them simultaneously), so I think this is also OK.",
      "parentUuid": "cdb85f07_dc303cbb",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 15,
        "endChar": 43
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fd3449e6_e6834cb5",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-18T09:33:38Z",
      "side": 1,
      "message": "\u003e I think from a chronological ordering perspective, a user replies to the reviewers comments on the old patch set, and uploads a change that generates a new PS. So the current order is in increasing PS ID.\n\n\nIt\u0027s actually the other way around. When I see that someone replied to my comment (e.g. \"Done\") then I expect the content to already have changed. There is an argument to be made that for auto-publishing it doesn\u0027t matter since it\u0027s just a single transaction, but it would be nice anyway to follow the flow that a user would go through manually.\n\nI think it\u0027s totally fine to publish the comments on the new patch set - actually that would align more with what I would expect as a user. That should make BatchUpdate do the right thing.\n\nTalked to Edwin briefly and he would expect the same ordering.",
      "parentUuid": "3b648fc1_1a8d6dbe",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 15,
        "endChar": 43
      },
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7e3cc735_b3622b8b",
        "filename": "java/com/google/gerrit/server/git/receive/BUILD",
        "patchSetId": 1
      },
      "lineNbr": 22,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-05T13:16:43Z",
      "side": 1,
      "message": "Please don\u0027t reference API components in the git package.\n\nPostReview.Op is a pretty complex database update operation, that deals with way more things than just publishing user comments. In general, there are two ways to reuse such code:\n1) Factor out that Op from the API class (PostReview) into a common place (for example the notedb package) and then reuse it from the git package.\n2) Reuse smaller chunks of work by putting these into classes in a common place (a lot of times these chunks of code end up in Util classes) and then have two Ops classes, one in PostReview and one in the git package that just use the relevant parts by calling the Utils.\n\nIn this case, (2) seems to be the better option. Most (all?) code you need is already in CommentsUtil and the event logic is also centrally handled (commentAdded.fired...).",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fbbd8080_e6e78791",
        "filename": "java/com/google/gerrit/server/git/receive/BUILD",
        "patchSetId": 1
      },
      "lineNbr": 22,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-10T18:34:15Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7e3cc735_b3622b8b",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fba850a9_2c0451e5",
        "filename": "java/com/google/gerrit/server/git/receive/ReceiveCommits.java",
        "patchSetId": 1
      },
      "lineNbr": 931,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-05T13:16:43Z",
      "side": 1,
      "message": "As noted in the prior comment, just add your small Op here instead of referencing PostReview.Op.",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "46ec2de4_29bc7ab0",
        "filename": "java/com/google/gerrit/server/git/receive/ReceiveCommits.java",
        "patchSetId": 1
      },
      "lineNbr": 931,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-10T18:34:15Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "fba850a9_2c0451e5",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fba26fca_2b525c96",
        "filename": "java/com/google/gerrit/server/git/receive/ReplaceOp.java",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-05T13:16:43Z",
      "side": 1,
      "message": "Please remove any code from this class that is about \u0027comments\u0027.",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "511c9b3b_a6152541",
        "filename": "java/com/google/gerrit/server/git/receive/ReplaceOp.java",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-10T18:34:15Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "fba26fca_2b525c96",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "846511b4_c7cfddc9",
        "filename": "java/com/google/gerrit/server/restapi/change/PostReview.java",
        "patchSetId": 1
      },
      "lineNbr": 884,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-05T12:06:24Z",
      "side": 1,
      "message": "This OP is used to publish draft comments. I made it public as it is needed to be used from ReceiveCommits",
      "range": {
        "startLine": 884,
        "startChar": 2,
        "endLine": 884,
        "endChar": 42
      },
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0a10852e_43550310",
        "filename": "java/com/google/gerrit/server/restapi/change/PostReview.java",
        "patchSetId": 1
      },
      "lineNbr": 884,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-05T13:16:43Z",
      "side": 1,
      "message": "See my comment above, there is a cheaper/cleaner way to get the same outcome.",
      "parentUuid": "846511b4_c7cfddc9",
      "range": {
        "startLine": 884,
        "startChar": 2,
        "endLine": 884,
        "endChar": 42
      },
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6bbc78ca_0eef3219",
        "filename": "java/com/google/gerrit/server/restapi/change/PostReview.java",
        "patchSetId": 1
      },
      "lineNbr": 884,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-10T18:34:15Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "0a10852e_43550310",
      "range": {
        "startLine": 884,
        "startChar": 2,
        "endLine": 884,
        "endChar": 42
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "54f01aa1_21110c3e",
        "filename": "javatests/com/google/gerrit/acceptance/git/AbstractPushForReview.java",
        "patchSetId": 1
      },
      "lineNbr": 2059,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-05T13:16:43Z",
      "side": 1,
      "message": "We need to assert that there is a change message that published the comments. You do that with asserting the size of messages, but we also need to assert the String of the message.\n\nFurther down we assert that the message is \"Uploaded patch set 3\" but that seems wrong for publishing comments.",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e8f164fa_6fe14cc6",
        "filename": "javatests/com/google/gerrit/acceptance/git/AbstractPushForReview.java",
        "patchSetId": 1
      },
      "lineNbr": 2059,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-06T16:21:44Z",
      "side": 1,
      "message": "To be more clear here, we need to test two separate things:\n\n1) The number of emails and the content of emails is correct\n2) The number of change messages (\u003dNoteDb commits) and the content of these is correct\n\nI am not convinced that the two ops really produce two commits in NoteDb (I could imagine that the ops get squashed when the write operation gets committed). A test will clear that doubt :-)\n\nConfusingly, we call emails \u0027messages\u0027 and change messages \u0027messages\u0027 and these two are mixed up in this test. It might help renaming the emails to \u0027emails\u0027.",
      "parentUuid": "54f01aa1_21110c3e",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3509eded_4e9c11fb",
        "filename": "javatests/com/google/gerrit/acceptance/git/AbstractPushForReview.java",
        "patchSetId": 1
      },
      "lineNbr": 2059,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-10T18:34:15Z",
      "side": 1,
      "message": "Added checks. The last message is \"Uploaded patch set 3\" and the next to last is about the comments (My comment on the review description replies on the ordering).",
      "parentUuid": "54f01aa1_21110c3e",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7d9382fd_26275f37",
        "filename": "javatests/com/google/gerrit/acceptance/git/AbstractPushForReview.java",
        "patchSetId": 1
      },
      "lineNbr": 2123,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2019-12-05T13:16:43Z",
      "side": 1,
      "message": "Please add tests that assert that we send the right emails and fire the right events when comments are published upon push.",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e3cb9fc8_db550a9b",
        "filename": "javatests/com/google/gerrit/acceptance/git/AbstractPushForReview.java",
        "patchSetId": 1
      },
      "lineNbr": 2123,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2019-12-10T18:34:15Z",
      "side": 1,
      "message": "Done. Added checks on the emails sent, the messages \u0026 the note DB commits.",
      "parentUuid": "7d9382fd_26275f37",
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "46e42247ccd73c76304bb8b616806db3bb106244",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}