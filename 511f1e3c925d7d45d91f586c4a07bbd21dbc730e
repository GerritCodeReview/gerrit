{
  "comments": [
    {
      "key": {
        "uuid": "be68bb3b_2c663da6",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-08-01T07:39:07Z",
      "side": 0,
      "message": "Looks like this is not happening with the new code anymore?",
      "range": {
        "startLine": 274,
        "startChar": 6,
        "endLine": 274,
        "endChar": 79
      },
      "revId": "511f1e3c925d7d45d91f586c4a07bbd21dbc730e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f3878656_8e7f5226",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1030912
      },
      "writtenOn": "2017-08-01T09:33:48Z",
      "side": 0,
      "message": "That\u0027s part of GroupsUpdate#addGroupMember (see [1]), or did I miss something?\n\n[1] https://gerrit-review.googlesource.com/c/115639/4/gerrit-server/src/main/java/com/google/gerrit/server/group/GroupsUpdate.java#85",
      "parentUuid": "be68bb3b_2c663da6",
      "range": {
        "startLine": 274,
        "startChar": 6,
        "endLine": 274,
        "endChar": 79
      },
      "revId": "511f1e3c925d7d45d91f586c4a07bbd21dbc730e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "05b170e9_6dcf2d1f",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-08-01T09:39:36Z",
      "side": 0,
      "message": "This is only done if currentUser !\u003d null and a currentUser is only available if @UserInitiated is used, but in this class we use @ServerInitiated.",
      "parentUuid": "f3878656_8e7f5226",
      "range": {
        "startLine": 274,
        "startChar": 6,
        "endLine": 274,
        "endChar": 79
      },
      "revId": "511f1e3c925d7d45d91f586c4a07bbd21dbc730e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f99cc5d5_4f6fa845",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1030912
      },
      "writtenOn": "2017-08-01T13:01:01Z",
      "side": 0,
      "message": "Oh, good catch. Just adding that line back here wouldn\u0027t help as we have to plan ahead for NoteDb. In NoteDb, we would take the server identity for the commit and hence claim that the server added that user to the group. Do you think that even with NoteDb, we would need to attribute that action to the user?",
      "parentUuid": "05b170e9_6dcf2d1f",
      "range": {
        "startLine": 274,
        "startChar": 6,
        "endLine": 274,
        "endChar": 79
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "511f1e3c925d7d45d91f586c4a07bbd21dbc730e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "023e188d_994bd630",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-08-01T13:35:16Z",
      "side": 0,
      "message": "I think this is kind of a special case. By logging in the user triggers the creation of its account and adding it to the group. Hence that new account should be logged as actor in the audit log.\n\nMaybe you could inject a provider for a user initiated group update and then use it inside a request context:\n\ntry (ManualRequestContext ctx \u003d oneOffRequestContext.openAs(newId)) {\n  userInitiatedGroupsUpdateProvider.get().addGroupMember(db, uuid, newId);\n}\n\nOpening a request context manually is not very nice, but since it\u0027s only in the special case where the initial admin user is created it should be fine.",
      "parentUuid": "f99cc5d5_4f6fa845",
      "range": {
        "startLine": 274,
        "startChar": 6,
        "endLine": 274,
        "endChar": 79
      },
      "revId": "511f1e3c925d7d45d91f586c4a07bbd21dbc730e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "983e7bc8_ec2c881e",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1030912
      },
      "writtenOn": "2017-08-01T16:50:07Z",
      "side": 0,
      "message": "As the provider is marked with @ServerInitiated, we would still not use the user inside GroupsUpdate. We would have to retrieve the provider inside of the context.\n\nI decided to use another approach: I added the possibility to set the currentUser on an existing GroupsUpdate.",
      "parentUuid": "023e188d_994bd630",
      "range": {
        "startLine": 274,
        "startChar": 6,
        "endLine": 274,
        "endChar": 79
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "511f1e3c925d7d45d91f586c4a07bbd21dbc730e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}