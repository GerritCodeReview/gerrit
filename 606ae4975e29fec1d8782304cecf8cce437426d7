{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "9407b7eb_9426c571",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 575,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2023-09-12T14:04:24Z",
      "side": 1,
      "message": "Could this be done outside of the retry block (i.e. before line 565), so that we do not need the logic to check whether it\u0027s a retry?",
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8a27124d_9b637ce4",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 575,
      "author": {
        "id": 1118500
      },
      "writtenOn": "2023-09-12T14:42:53Z",
      "side": 1,
      "message": "Yes, of course! Thank you for noticing!",
      "parentUuid": "9407b7eb_9426c571",
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "345a1cd3_6bca1696",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 578,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2023-09-12T14:04:24Z",
      "side": 1,
      "message": "Using the input object to returned a value to the test looks a bit hacky.\n\nCould you use TestMetricMaker to check the RetryHelper.Metrics.attemptCounts metric instead? See usage of testMetricMaker in RebaseIT for an example.",
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ad427a24_a8c43476",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 578,
      "author": {
        "id": 1118500
      },
      "writtenOn": "2023-09-12T14:42:53Z",
      "side": 1,
      "message": "Yep, TestSubmitInput is hacky, so I thought it would not hurt re-using it. Changed to testMetricMaker, this is cleaner.",
      "parentUuid": "345a1cd3_6bca1696",
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "de2aa7c5_89031d4f",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 588,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2023-09-12T14:04:24Z",
      "side": 1,
      "message": "nit: bad formatting",
      "range": {
        "startLine": 584,
        "startChar": 22,
        "endLine": 588,
        "endChar": 96
      },
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "90a0829a_8c218426",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 588,
      "author": {
        "id": 1118500
      },
      "writtenOn": "2023-09-12T14:42:53Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "de2aa7c5_89031d4f",
      "range": {
        "startLine": 584,
        "startChar": 22,
        "endLine": 588,
        "endChar": 96
      },
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ba3323ce_9ae076d5",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 594,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2023-09-12T14:04:24Z",
      "side": 1,
      "message": "Why was this change from IllegalStateException to ResourceConflictException?\nResourceConflictException is used to trigger a 409 response, but it seems this exception is caught and wrapped in an IOException below (if all retries failed), so it\u0027s still a 500 ISE. So using ResourceConflictException is confusing.",
      "range": {
        "startLine": 594,
        "startChar": 32,
        "endLine": 594,
        "endChar": 57
      },
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7cf6bd28_5768a4f0",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 594,
      "author": {
        "id": 1118500
      },
      "writtenOn": "2023-09-12T14:42:53Z",
      "side": 1,
      "message": "I need some exception to filter on in retryOn method. I seems like a natural choice to throw ResourceConflictException, same as in L#592.\n\nI am happy to re-throw it as ResourceConflictException (not IoException), if you think this is the better choice?",
      "parentUuid": "ba3323ce_9ae076d5",
      "range": {
        "startLine": 594,
        "startChar": 32,
        "endLine": 594,
        "endChar": 57
      },
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6c54a52d_cb3890da",
        "filename": "java/com/google/gerrit/server/submit/MergeOp.java",
        "patchSetId": 1
      },
      "lineNbr": 594,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2023-09-12T15:09:55Z",
      "side": 1,
      "message": "If all retires fail because the change is still missing in the index, this should stay a 500 ISE. When I saw this throwing ResourceConflictException now I was first concerned that this changed the response code from 500 to 409, but it didn\u0027t. I think it\u0027s confusing if throwing ResourceConflictException doesn\u0027t result in a 409, hence I think we should throw another exception here.\n\n\u003e I seems like a natural choice to throw ResourceConflictException,\n\u003e same as in L#592.\n\nI missed that we throw ResourceConflictException there. This means we broke that case now. Throwing ResourceConflictException there shouldn\u0027t trigger a retry, but cause a 409 response to the caller. It seems now we are retrying and returning 500 ISE, which seems wrong. To fix this I think the catch block below needs to re-throw ResourceConflictException and we should not retry on ResourceConflictException. Consequently we need to throw another exception here to trigger retrying and causing an 500 ISE. Using IllegalStateException for this should be fine. If we are worryied that retrying on IllegalStateException may match other IllegalStateExceptions unintentionally, we could make the retryOn predicate more specific (e.g. also check the exception message).\n\nWDYT?",
      "parentUuid": "7cf6bd28_5768a4f0",
      "range": {
        "startLine": 594,
        "startChar": 32,
        "endLine": 594,
        "endChar": 57
      },
      "revId": "606ae4975e29fec1d8782304cecf8cce437426d7",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}