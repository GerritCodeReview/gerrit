{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "277be2d6_dd54caa1",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1083042
      },
      "writtenOn": "2021-11-08T10:51:49Z",
      "side": 1,
      "message": "I see your point, but I think that preventing breakage downstream is equally important. As discussed in the standup just now, can we somehow include this with the other messages we\u0027re already checking? Because to the backends like STBTI it\u0027s one and the same.",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2cfa596c_f6c34675",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2021-11-08T11:18:09Z",
      "side": 1,
      "message": "This is the first time we encounter this issue of something breaking, and this feature was in prod for around a year. Hence I think it\u0027s not super important.\n\nAnyway, autogenerated change messages were always excluded from the limit (see your initial implementation in  I93a6374b). We might have to rework that, but that means we risk breaking some user operations. \n\nI think it\u0027s best to keep as is. I also reduced the size too divide by 10 (300KB).",
      "parentUuid": "277be2d6_dd54caa1",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "103e83cd_22348994",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1083042
      },
      "writtenOn": "2021-11-08T11:36:55Z",
      "side": 1,
      "message": "I\u0027m guilty of not documenting why we exclude autogenerated messages. IIRC we reasoned that they are always small. Whether or not I remember correctly, this is definitely not true today, even with a limit of just 300KB.\n\nThis particular type of message has the nice property that it is only generated on submit, i.e. once. But I still think we should include autogenerated messages.\n\nConsider the failure modes: If some automation/some team\u0027s process breaks because they hit the validation threshold, they will get a clear message that explains the root cause. If we don\u0027t do that, we\u0027ll get degraded behavior in our storage layer or other dependencies. This will cause the same breakage, but it will likely be flaky and harder to diagnose.",
      "parentUuid": "2cfa596c_f6c34675",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0a2e70d7_eb0132e3",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2021-11-08T12:43:42Z",
      "side": 1,
      "message": "I have an idea. \nWhat if the comment size validator will limit to 80% of the limit?\n\nThat way we will have:\n80% set for everything except autogenerated messages.\n10% for the post submit diff.\n10% for all other autogenerated messages.\n\nAutomation or some team\u0027s process will still get the needed error messages if they exceed the limit (just not from autogenerated messages).\n\nOf course I\u0027ll document everything. If that makes sense I\u0027ll do it in a follow-up now.\n\nThe reason I\u0027m not implementing what you\u0027re suggesting and be done with it, is because it actually requires a new validator: We\u0027ll need to create a new class similar to CommentValidator to validate change messages. Is this new complexity worth it? Maybe, but I feel it\u0027s a bit out of scope.",
      "parentUuid": "103e83cd_22348994",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5d223e92_76c84d4c",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1083042
      },
      "writtenOn": "2021-11-08T13:55:09Z",
      "side": 1,
      "message": "Actually I did document why autogenerated change messages aren\u0027t counted, in line 64: They bypass the validator hooks. But now we have an explicit call site.\n\nWDYT about extracting the code from CommentCumulativeSizeValidator.java:57-69 to a static helper and reusing it here? That would make the connection even more explicit than comments, and we\u0027d make the best use of the available space.\n\nI\u0027m no longer sure the validator should skip autogenerated messages. We can\u0027t reject them, but that doesn\u0027t mean we shouldn\u0027t count them. It would be inconsistent to count them, but safer and more accurate. We\u0027d have one hole rather than two holes that we accept because they\u0027re consistent :-)",
      "parentUuid": "0a2e70d7_eb0132e3",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2a50ea8b_15631fa9",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2021-11-08T14:07:15Z",
      "side": 1,
      "message": "If195140 is a pointer to the implementation of this line 64 (this was not the default, I added it since it was not consistent).\n\nI think we\u0027re going in circles, invited you to a VC :-)",
      "parentUuid": "5d223e92_76c84d4c",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "31c90436_ad616980",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2021-11-08T16:05:59Z",
      "side": 1,
      "message": "discussed in VC, created a follow-up to remove the filter of autogenerated change messages in addition to this change.",
      "parentUuid": "2a50ea8b_15631fa9",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8d915755_1ddb3328",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1083042
      },
      "writtenOn": "2021-11-09T09:03:02Z",
      "side": 1,
      "message": "Didn\u0027t we also want to extract the size computation and use it here instead of the 10% approach?",
      "parentUuid": "31c90436_ad616980",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1dc59a39_f13576ac",
        "filename": "java/com/google/gerrit/server/patch/SubmitWithStickyApprovalDiff.java",
        "patchSetId": 3
      },
      "lineNbr": 99,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2021-11-09T11:15:17Z",
      "side": 1,
      "message": "ah, I forgot. I added another follow-up. I don\u0027t think it should be instead, but in addition (we never want to have 4.5MB of diff to take all the size).",
      "parentUuid": "8d915755_1ddb3328",
      "range": {
        "startLine": 99,
        "startChar": 11,
        "endLine": 99,
        "endChar": 47
      },
      "revId": "696467e40b4b57a27cc9df0bcd77dbb4888ac1c2",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}