{
  "comments": [
    {
      "key": {
        "uuid": "1c455a84_3edf6960",
        "filename": "gerrit-extension-api/src/main/java/com/google/gerrit/extensions/common/ApprovalInfo.java",
        "patchSetId": 4
      },
      "lineNbr": 23,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-13T14:37:21Z",
      "side": 1,
      "message": "Can you please document this new field in rest-api-changes.txt in the \u0027Approvalinfo\u0027 section?",
      "range": {
        "startLine": 23,
        "startChar": 17,
        "endLine": 23,
        "endChar": 34
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1cad5ab1_de49658c",
        "filename": "gerrit-extension-api/src/main/java/com/google/gerrit/extensions/common/ApprovalInfo.java",
        "patchSetId": 4
      },
      "lineNbr": 23,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-13T22:25:23Z",
      "side": 1,
      "message": "Sure, will fix, thanks for pointing to the doc.",
      "parentUuid": "1c455a84_3edf6960",
      "range": {
        "startLine": 23,
        "startChar": 17,
        "endLine": 23,
        "endChar": 34
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1c455a84_fef341f7",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-13T14:37:21Z",
      "side": 1,
      "message": "Would it makes sense to compute the permitted labels here and then pass them through labelsFor all the way down to setAllApprovals where you use them? \n\nThe other place where we need to the permitted labels is below (line 492) and this way we would need to invoke permittedLabels only once.",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "5c9fd279_a0431a6a",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-13T22:25:23Z",
      "side": 1,
      "message": "Yea, I think it definitely make sense to avoid unnecessary computation of permittedLabels. \n\nThe permittedLabels may be computed here and transferred all the way down to setAllApprovals to both labelsForOpenChange and labelsForClosedChange, in this case it will be computed only once, however it will be always computed once, but it\u0027s not needed for non detailed requests. It may be fine here or I can propose to create a small class PermittedLabelsProvider and transfer it all the way down and use in line 492. The class will lazily calculate permittedLabels during the first invocation and will return the cached version during the next invocations:\n\nprivate class PermittedLabelsProvider {\n    private ChangeControl ctl;\n    private ChangeData cd;\n    private Map\u003cString, Collection\u003cString\u003e\u003e permittedValues;\n\n    PermittedLabelsProvider(ChangeControl ctl, ChangeData cd) {\n      this.ctl \u003d ctl;\n      this.cd \u003d cd;\n    }\n    Map\u003cString, Collection\u003cString\u003e\u003e get() throws OrmException {\n      if (permittedValues \u003d\u003d null) {\n        permittedValues \u003d permittedLabels(ctl, cd);\n      }\n      return permittedValues;\n    }\n}\n\nIn this case the permittedLabels will be computed only when needed and only once, however the code will be more complex and not sure it will be consistent will the rest of the code (in terms of readability).\n\nIt looks like a tradeoff between simplicity and performance, I don\u0027t know what is better for the code base? or of course any other solution",
      "parentUuid": "1c455a84_fef341f7",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "dca822f6_2cad1388",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-14T06:39:01Z",
      "side": 1,
      "message": "Your proposal sounds good to me.",
      "parentUuid": "5c9fd279_a0431a6a",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "dc1d824e_24819200",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-14T19:11:34Z",
      "side": 1,
      "message": "There is one detail that I missed, the \"permittedLabels(ctl, cd)\" depends on the \"ChangeControl ctl\" that is unique per each reviewer (line 716). So, looks like we can\u0027t invoke permittedLabels only once here since it will return the permitted labels for the current user. Looks like we need to make at least N permittedLabels(ctl(n), cd) calls, where N is the number of reviewers. \n\nWhat do you think?",
      "parentUuid": "dca822f6_2cad1388",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "dca2e37b_631022c3",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-17T06:15:37Z",
      "side": 1,
      "message": "I missed this too :(\n\nMaybe this is why Dave was concerned about the performance.",
      "parentUuid": "dc1d824e_24819200",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1c7f1b9a_95ba44a2",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2016-10-17T15:33:53Z",
      "side": 1,
      "message": "Yes, this is the performance issue. O(1) permissions checks per N search results is ok, O(N) permissions checks per N search results starts to be a problem.",
      "parentUuid": "dca2e37b_631022c3",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "dc60231e_d3b754b8",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-17T21:23:12Z",
      "side": 1,
      "message": "I completely understand the performance drawback, but is there any way to implement this feature more efficiently? \n\nI traced the method permittedLabels(...) code, it seems some data is coming from caches. Also, I didn\u0027t find very expensive invocations (like db, etc), but of course I maybe be missing something. \n\nI\u0027m just thinking - this extra code will be executed only for \u0027detailed\u0027 requests, so it may be expected that \u0027detailed\u0027 requests require more calculations? However, seems like UI always request \u0027detailed\u0027 information.",
      "parentUuid": "1c7f1b9a_95ba44a2",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "616950e4_f77e201f",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 484,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-24T19:50:04Z",
      "side": 1,
      "message": "While the performance is still under discussion - I updated the change with tests and doc.",
      "parentUuid": "dc60231e_d3b754b8",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3c3cdef1_df62bba5",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 489,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-13T14:37:21Z",
      "side": 1,
      "message": "Should maxPermittedValue also be only set under these conditions?",
      "range": {
        "startLine": 488,
        "startChar": 6,
        "endLine": 489,
        "endChar": 75
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1cad5ab1_fe442176",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 489,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-13T22:25:23Z",
      "side": 1,
      "message": "I honestly don\u0027t know. My logic is: the limitToPsId is not transferred down to setAllApprovals, so most probably maxPermittedValue (part of Approvals) doesn\u0027t depend on limitToPsId.",
      "parentUuid": "3c3cdef1_df62bba5",
      "range": {
        "startLine": 488,
        "startChar": 6,
        "endLine": 489,
        "endChar": 75
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fc9fa6ca_adc1fd2e",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 489,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-14T06:39:01Z",
      "side": 1,
      "message": "I think you are right. Sorry for the confusion.",
      "parentUuid": "1cad5ab1_fe442176",
      "range": {
        "startLine": 488,
        "startChar": 6,
        "endLine": 489,
        "endChar": 75
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bc1a8e55_c379961d",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 489,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-14T19:11:34Z",
      "side": 1,
      "message": "no problem",
      "parentUuid": "fc9fa6ca_adc1fd2e",
      "range": {
        "startLine": 488,
        "startChar": 6,
        "endLine": 489,
        "endChar": 75
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7c89f63d_49c2a100",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 731,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2016-10-13T14:42:39Z",
      "side": 1,
      "message": "My main concern here is performance. Prior to this change, if you do a search with o\u003dDETAILED_LABELS, then it won\u0027t need to scan permissions on each change in order to serve the search results. Now, it needs to do one permission lookup per reviewer per change.\n\nI wonder if we should move all the permitted label stuff behind an option? But then again Shawn doesn\u0027t like adding new options willy-nilly as the space is somewhat limited.",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1c455a84_dec925a6",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 731,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-13T14:47:52Z",
      "side": 1,
      "message": "Shouldn\u0027t this be just fine if we set maxPermittedValue only when we compute the permitted labels anyway? See my comment above in lines 488-489.",
      "parentUuid": "7c89f63d_49c2a100",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1cad5ab1_3e7a89ad",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 731,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-13T22:25:23Z",
      "side": 1,
      "message": "I looked deeper in the code and realized that it\u0027s non necessary to compute permittedLabels here, at least for each accountId separately since it\u0027s not depend on it. I made a comment above, the option with computing it in toChangeInfo() looks promising",
      "parentUuid": "1c455a84_dec925a6",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1c455a84_def005ee",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 841,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-13T14:37:21Z",
      "side": 1,
      "message": "Should maxPermittedValue be set here too, so that this information is also available for closed changes?\n\nThis may make sense in the context of change 88572 [1], which adds support for voting on merged changes.\n\n[1] https://gerrit-review.googlesource.com/88572",
      "range": {
        "startLine": 839,
        "startChar": 10,
        "endLine": 841,
        "endChar": 34
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "5c9fd279_80593658",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 841,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-13T22:25:23Z",
      "side": 1,
      "message": "Sure, will fix",
      "parentUuid": "1c455a84_def005ee",
      "range": {
        "startLine": 839,
        "startChar": 10,
        "endLine": 841,
        "endChar": 34
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c16e7ce9_1a917d2e",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 841,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-24T19:50:04Z",
      "side": 1,
      "message": "Fixed",
      "parentUuid": "5c9fd279_80593658",
      "range": {
        "startLine": 839,
        "startChar": 10,
        "endLine": 841,
        "endChar": 34
      },
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1c455a84_5edeb560",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 864,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2016-10-13T14:37:21Z",
      "side": 1,
      "message": "Can you please add a few test that verify that this field is set correctly? ChangeIT.get() should be a good starting point for this.",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1cad5ab1_1e77cdc5",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 864,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-13T22:25:23Z",
      "side": 1,
      "message": "Sure, will add, thanks for pointing to ChangeIT.get()",
      "parentUuid": "1c455a84_5edeb560",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "616950e4_978b2400",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/ChangeJson.java",
        "patchSetId": 4
      },
      "lineNbr": 864,
      "author": {
        "id": 1029237
      },
      "writtenOn": "2016-10-24T19:50:04Z",
      "side": 1,
      "message": "Fixed, add 2 tests. The new tests cover the basic functionality of this feature. I can add more tests if needed.",
      "parentUuid": "1cad5ab1_1e77cdc5",
      "revId": "6cb81bfa4961f4a244733ba338c8749d68bd859f",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}