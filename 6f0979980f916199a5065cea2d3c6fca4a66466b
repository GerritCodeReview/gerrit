{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "f205d485_6a1096dc",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-11-27T17:57:26Z",
      "side": 1,
      "message": "@david.ostrovsky@gmail.com I have done some tests (in a docker container gerritforge/gerrit-release-bazel:debian-bullseye)\n\n- Test 1:\n\n```\nbazelisk  test //javatests/... --config\u003dremote_bb --remote_header\u003dx-buildbuddy-api-key\u003dXXXXX\n```\n\nResult: Succesful\n\n- Test 2:\n\n```\nbazelisk  test //javatests/... --config\u003dremote11_bb --remote_header\u003dx-buildbuddy-api-key\u003dXXXXX\n```\n\nResult: Succesful\n\n- Test 3:\n\n```\nbazelisk  test \\\n--config\u003dremote_bb \\\n--remote_header\u003dx-buildbuddy-api-key\u003dXXXXX \\\n--flaky_test_attempts 3 \\\n--test_timeout 3600 \\\n--test_tag_filters\u003d-flaky,-elastic,-no_rbe \\\n//...\n```\n\nResult: Failed 3 times in the same test:\n\n```\nThere was 1 failure:\n1) invalidTargetArchiveFolder(com.googlesource.gerrit.plugins.deleteproject.ConfigurationTest)\nexpected: /buildbuddy/remotebuilds/9812aa4d-4b39-405e-bc45-6662fc6d7b28/_tmp/1a603f63979fdbf7741d14f4152518a3/junit8509788577984914603/data\nbut was : /\\\\\\\n    at com.googlesource.gerrit.plugins.deleteproject.ConfigurationTest.invalidTargetArchiveFolder(ConfigurationTest.java:127)\n\nFAILURES!!!\nTests run: 45,  Failures: 1\n```\n\n- Test 4:\n\n```\nbazelisk  test \\\n--config\u003dremote11_bb \\\n--remote_header\u003dx-buildbuddy-api-key\u003dXXXXX \\\n--flaky_test_attempts 3 \\\n--test_timeout 3600 \\\n--test_tag_filters\u003d-flaky,-elastic,-no_rbe \\\n//...\n```\n\n\nResult: Failed 3 times in the same test:\n```\nThere was 1 failure:\n1) invalidTargetArchiveFolder(com.googlesource.gerrit.plugins.deleteproject.ConfigurationTest)\nexpected: /buildbuddy/remotebuilds/b32ea687-69a4-4aa5-9398-c06cefd8cdfe/_tmp/1a603f63979fdbf7741d14f4152518a3/junit14292937447987984095/data\nbut was : /\\\\\\\n    at com.googlesource.gerrit.plugins.deleteproject.ConfigurationTest.invalidTargetArchiveFolder(ConfigurationTest.java:127)\n\nFAILURES!!!\nTests run: 45,  Failures: 1\n\n```\n\n\nI think I am missing something when I execute the test remotely against the target `//...`",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "923fda08_eeed899f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2023-11-28T09:02:56Z",
      "side": 1,
      "message": "The difference between javatests/... and //...:  also plugin tests are executed.\n\nCan you take RBE-BB out of the picture, start their docker image directly and run delete-plugin test there like this:\n\n```bash\n  $ bazel test plugins/delete-project/...\n```",
      "parentUuid": "f205d485_6a1096dc",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ccd9bd93_9c90bdb0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-11-28T10:47:44Z",
      "side": 1,
      "message": "- Local tests:\n```\n$ bazelisk test plugins/delete-project/...\n```\n\n**Tests pass**\n\n\n- Remote tests:\n```\n$bazelisk test --flaky_test_attempts 3 --config\u003dremote_bb  --remote_header\u003dx-buildbuddy-api-key\u003dXXXX plugins/delete-project/...\n```\n\n**Tests fail**\n\n```\nThere was 1 failure:\n1) \ninvalidTargetArchiveFolder(com.googlesource.gerrit.plugins.deleteproject.ConfigurationTest)\nexpected: /buildbuddy/remotebuilds/1d9f2dcf-1db8-4ee4-82c2-94c5f3519f10/_tmp/1a603f63979fdbf7741d14f4152518a3/junit16069211931322936868/data\nbut was : /\\\\\\\n        at com.googlesource.gerrit.plugins.deleteproject.ConfigurationTest.invalidTargetArchiveFolder(ConfigurationTest.java:127)\nFAILURES!!!\nTests run: 45,  Failures: 1\n```\n\nAny thought? Could it be the docker image used by BuildBuddy for running the sandboxed environment? Apologies for my lack of accuracy in the Bazel terminology.",
      "parentUuid": "923fda08_eeed899f",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ffa2c605_cd0e22bc",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-11-30T14:06:08Z",
      "side": 1,
      "message": "I have been analysing the test [1] when I run it locally (the test passes) there is an exception raised [2]:\n\n```\njava.nio.file.FileSystemException: /\\\\\\: Operation not permitted\n\tat java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:100)\n\tat java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:106)\n\tat java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111)\n\tat java.base/sun.nio.fs.UnixFileSystemProvider.createDirectory(UnixFileSystemProvider.java:397)\n\tat java.base/java.nio.file.Files.createDirectory(Files.java:700)\n\tat java.base/java.nio.file.Files.createAndCheckIsDirectory(Files.java:807)\n\tat java.base/java.nio.file.Files.createDirectories(Files.java:793)\n\tat com.googlesource.gerrit.plugins.deleteproject.Configuration.getArchiveFolderFromConfig(Configuration.java:107)\n\tat com.googlesource.gerrit.plugins.deleteproject.Configuration.\u003cinit\u003e(Configuration.java:67)\n\tat com.googlesource.gerrit.plugins.deleteproject.ConfigurationTest.invalidTargetArchiveFolder(ConfigurationTest.java:125)\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\n\tat org.mockito.internal.runners.DefaultInternalRunner$1$1.evaluate(DefaultInternalRunner.java:55)\n\tat org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)\n\tat org.junit.rules.RunRules.evaluate(RunRules.java:20)\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)\n\tat org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n\tat org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n\tat org.mockito.internal.runners.DefaultInternalRunner$1.run(DefaultInternalRunner.java:100)\n\tat org.mockito.internal.runners.DefaultInternalRunner.run(DefaultInternalRunner.java:107)\n\tat org.mockito.internal.runners.StrictRunner.run(StrictRunner.java:42)\n\tat org.mockito.junit.MockitoJUnitRunner.run(MockitoJUnitRunner.java:163)\n\tat org.junit.runners.Suite.runChild(Suite.java:128)\n\tat org.junit.runners.Suite.runChild(Suite.java:27)\n\tat org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n\tat org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n\tat com.google.testing.junit.runner.internal.junit4.CancellableRequestFactory$CancellableRunner.run(CancellableRequestFactory.java:108)\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:137)\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:115)\n\tat com.google.testing.junit.runner.junit4.JUnit4Runner.run(JUnit4Runner.java:116)\n\tat com.google.testing.junit.runner.BazelTestRunner.runTestsInSuite(BazelTestRunner.java:145)\n\tat com.google.testing.junit.runner.BazelTestRunner.main(BazelTestRunner.java:76)\n```\n\nHowever when the test is executed with BuildBuddy RBE that exception is not raised and as a consequence of that the test ends up failing. It looks that the folder `/\\\\\\` is created in the remote executor.\n\n@david.ostrovsky@gmail.com, wdyt?\nReferences:\n[1] https://gerrit.googlesource.com/plugins/delete-project/+/refs/heads/master/src/test/java/com/googlesource/gerrit/plugins/deleteproject/ConfigurationTest.java#119\n[2]",
      "parentUuid": "ccd9bd93_9c90bdb0",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "56ddda3f_f84dd1e7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-11-30T15:17:45Z",
      "side": 1,
      "message": "I forgot to add the link to [2]: https://gerrit.googlesource.com/plugins/delete-project/+/refs/heads/master/src/main/java/com/googlesource/gerrit/plugins/deleteproject/Configuration.java#107",
      "parentUuid": "ffa2c605_cd0e22bc",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "780a44bf_647a2045",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-12-01T16:45:57Z",
      "side": 1,
      "message": "Definitively it is a matter of permissions. I have checked with BuildBuddy engineers and apparently the image `gcr.io/flame-public/rbe-ubuntu20-04:latest` is used for running remote actions and these ones are run as a `root` user.\nThey suggested to add the following in the delete-project plugin\u0027s test target BUILD [1]:\n```\n    exec_properties \u003d {\n        \"dockerUser\": \"nobody\",\n    },\n```\n\nAfter adding that, all the test passed correctly.\n\n@david.ostrovsky@gmail.com, please let me know when you are available.\nReferences:\n\n[1] https://gerrit.googlesource.com/plugins/delete-project/+/refs/heads/master/BUILD#30",
      "parentUuid": "56ddda3f_f84dd1e7",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "21781f51_4be71fd9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2023-12-06T05:32:12Z",
      "side": 1,
      "message": "\u003e hey suggested to add the following in the delete-project plugin\u0027s test target BUILD [1]:\n\nThis would be quite invasive change, to add this BuildBuddy specific configuration options for one specific test in Gerrit plugin.  Moreover for Gerrit developers (who mostly don\u0027t care about build, unless it\u0027s broken), it\u0027s not immediately clear, what docker environment is referenced to.\n\nImagine, other tests would be also affected, so that we would need to proliferate those magic confiuration: `exec_properties \u003d {\"dockerUser\": \"nobody\"}` across our build toolchain.\n\nI think the best option, that could help here, if a global option could be passed through Bazel to RBE on BuildBuddy, to force specific mount options of docker image, e.g.:\n\n### Specific action for RBE@GCP:\n\nbuild:config_gcp --action_env\u003dBAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN\u003d1\n\n### Specific action for RBE@BuildBuddy:\n\nbuild:config_gcp --action_env\u003dBUILD_BUDDY_MOUNT_DOCKER_WITH_NOBODY_USER\u003d1\n\n^^^ Can you check with the BuildBuddy folks, if they could support something like this (or similar), non invasive way to provide BuildBuddy specific option(s)?\n\nThe second best option, would be to (temporarily?) pass those magic options in the global `junit_tests` definition: [1].\n\n\u003e gcr.io/flame-public/rbe-ubuntu20-04:latest\n\nCould we use exactly the same base docker image, we are using for RBE build on GCP: `docker pull gcr.io/bazel-public/ubuntu2204-java17@latest`.\n\nSee also this change, where I removed our custom docker image and switched to using the bazel docker image on Ubuntu 22.04 with JDK 17 installed [2].\n\n[1]: https://gerrit.googlesource.com/gerrit/+/refs/heads/master/tools/bzl/junit.bzl#97\n[2]: https://gerrit-review.googlesource.com/c/gerrit/+/392681",
      "parentUuid": "780a44bf_647a2045",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d2043252_a245a3eb",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-12-11T17:18:45Z",
      "side": 1,
      "message": "\u003e Could we use exactly the same base docker image, we are using for RBE build on GCP: docker pull gcr.io/bazel-public/ubuntu2204-java17@latest.\n\nI have been able to remove the BuildBuddy tool chain that BuildBuddy provides (`buildbuddy_toolchain`) and I have used the same tool chain as we do for RBE GCP (`ubuntu2204_jdk17`). All the test passed *successfully* apart from the one mentioned above. I was expecting that test failing because in GCP RBE is not failing. if I apply `dockerUser\u003dnobody` as I mentioned before the test passes. I guess that I am missing something.",
      "parentUuid": "21781f51_4be71fd9",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "60172898_4b32b01e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-12-11T17:31:32Z",
      "side": 1,
      "message": "I wonder in GCP RBE which user is running the tests? The default user of the image that you mentioned `gcr.io/bazel-public/ubuntu2204-java17@latest` is ROOT, and with that user the test should fail using GCP RBE.",
      "parentUuid": "d2043252_a245a3eb",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a2af279c_c0a72a85",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 17
      },
      "lineNbr": 0,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2023-12-12T19:54:13Z",
      "side": 1,
      "message": "\u003e I have been able to remove the BuildBuddy tool chain that BuildBuddy provides (buildbuddy_toolchain) and I have used the same tool chain as we do for RBE GCP (ubuntu2204_jdk17). \n\nThose are great news! Thanks for this great simplification and harmonization of both RBE providers. 🎉\n\n\u003e All the test passed successfully apart from the one mentioned above.\n\nI can reproduce the problem with the docker image `gcr.io/bazel-public/ubuntu2204-java17@latest`, that is using `root` user per default:\n\nI run the docker image and then clone gerrit recursively and then rune the test:\n\n```bash\n $\u003e bazel test plugins/delete-project:delete-project_tests\n//plugins/delete-project:delete-project_tests                            FAILED in 61.0s\n  /root/.cache/bazel/_bazel_root/4198cff55ec080b15cc0805ba32b9d92/execroot/gerrit/bazel-out/k8-fastbuild/testlogs/plugins/delete-project/delete-project_tests/test.log\n```\n\nNote, that no RBE involved here.\n\nHowever, I cannot reproduce the problem with RBE@GCP:\n\n```bash\n $\u003e bazel test --config\u003dremote --remote_instance_name\u003d$PROJECT plugins/delete-project/...\n[...]\nINFO: Found 1 test target...\nTarget //plugins/delete-project:delete-project_tests up-to-date:\n  bazel-bin/plugins/delete-project/delete-project_tests\n  bazel-bin/plugins/delete-project/delete-project_tests.jar\nINFO: Elapsed time: 252.084s, Critical Path: 236.22s\nINFO: 520 processes: 24 remote cache hit, 13 internal, 483 remote.\nINFO: Build completed successfully, 520 total actions\n//plugins/delete-project:delete-project_tests                            PASSED in 61.1s\n```\n\nLooking at the failing test, I don\u0027t think it\u0027s of any value, I\u0027m going to propose to just remove it, to avoid complication of our build toolchain.",
      "parentUuid": "60172898_4b32b01e",
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "92e64d45_1d0ea787",
        "filename": "tools/remote-bazelrc",
        "patchSetId": 17
      },
      "lineNbr": 63,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2023-11-28T09:02:56Z",
      "side": 1,
      "message": "Nit: blank after # character, like in all comment lines below.",
      "range": {
        "startLine": 63,
        "startChar": 0,
        "endLine": 63,
        "endChar": 14
      },
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9b16b1e8_a870a073",
        "filename": "tools/remote-bazelrc",
        "patchSetId": 17
      },
      "lineNbr": 63,
      "author": {
        "id": 1149185
      },
      "writtenOn": "2023-11-28T10:47:44Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "92e64d45_1d0ea787",
      "range": {
        "startLine": 63,
        "startChar": 0,
        "endLine": 63,
        "endChar": 14
      },
      "revId": "6f0979980f916199a5065cea2d3c6fca4a66466b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}