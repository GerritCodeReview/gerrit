{
  "comments": [
    {
      "key": {
        "uuid": "9602d98b_e69fde8c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 34
      },
      "lineNbr": 33,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-28T15:13:07Z",
      "side": 1,
      "message": "related",
      "range": {
        "startLine": 33,
        "startChar": 41,
        "endLine": 33,
        "endChar": 48
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b07555_515f544f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 34
      },
      "lineNbr": 33,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T06:28:41Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9602d98b_e69fde8c",
      "range": {
        "startLine": 33,
        "startChar": 41,
        "endLine": 33,
        "endChar": 48
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_8f1fd5a4",
        "filename": "/COMMIT_MSG",
        "patchSetId": 34
      },
      "lineNbr": 38,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-28T15:13:07Z",
      "side": 1,
      "message": "It also does the data migration from db to git, doesn\u0027t it? At least for the open source Gerrit version.",
      "range": {
        "startLine": 38,
        "startChar": 2,
        "endLine": 38,
        "endChar": 21
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_af957940",
        "filename": "/COMMIT_MSG",
        "patchSetId": 34
      },
      "lineNbr": 38,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T06:28:41Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b6ba7d35_8f1fd5a4",
      "range": {
        "startLine": 38,
        "startChar": 2,
        "endLine": 38,
        "endChar": 21
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_6f09d16d",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 49,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-28T15:13:07Z",
      "side": 1,
      "message": "This must be Provider\u003cMetaDataUpdate.User\u003e.\nOtherwise if an instance of MetaDataUpdate.User is kept in a singleton this will lead to wrong timestamps for the commits done by this instance (see [1] for details).\n\n[1] https://gerrit-review.googlesource.com/69265",
      "range": {
        "startLine": 49,
        "startChar": 16,
        "endLine": 49,
        "endChar": 35
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b07555_b12cc0d0",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 49,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T06:28:41Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b6ba7d35_6f09d16d",
      "range": {
        "startLine": 49,
        "startChar": 16,
        "endLine": 49,
        "endChar": 35
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_4f068d5f",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 148,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-28T15:13:07Z",
      "side": 1,
      "message": "This looks wrong to me.\n\nFields should only be set if they are non-null in the input (like it was in the old code).\n\nE.g. if I send the following DiffPreferencesInfo:\n\n  {\n    \"show_line_endings\": true\n  }\n\nit means only this one setting should be updated and all other settings should stay unmodified. If I understand the new code correctly it would e.g. set all other booleans to false, what it is not intended.",
      "range": {
        "startLine": 124,
        "startChar": 4,
        "endLine": 148,
        "endChar": 63
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b07555_9131bc28",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 148,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T06:28:41Z",
      "side": 1,
      "message": "| it means only this one setting should be updated and all other settings should stay unmodified\n\nI don\u0027t think this is how old code worked. I havn\u0027t checked, but my understanding of gwtorm code is that the update statement isn\u0027t optimized. And always all columns are updated. So in your example above even when only one field was changed:\n\n  {\n      \"show_line_endings\": true\n  }\n\nand passed in input, the AccountDiffPreference is filled  (as it has non nullable types: boolean and not Boolean, int and not Interger), so that full database update is executed.",
      "parentUuid": "b6ba7d35_4f068d5f",
      "range": {
        "startLine": 124,
        "startChar": 4,
        "endLine": 148,
        "endChar": 63
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b07555_5191144b",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 148,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-29T09:53:37Z",
      "side": 1,
      "message": "You almost made me believe it :D \nI just tried it out and with the example above the old code just updates this one setting, but with the new code other settings may be modified too.",
      "parentUuid": "f6b07555_9131bc28",
      "range": {
        "startLine": 124,
        "startChar": 4,
        "endLine": 148,
        "endChar": 63
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_eff14196",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 148,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T10:19:45Z",
      "side": 1,
      "message": "| I just tried it out and with the example above the old code just updates this one setting\n\nJust to make sure we aren\u0027t talking past each other (i haven\u0027t tested gwtorm code myself): do you mean setting the values in AccountDiffPreference instance or actually SQL update statement, issued by gwtorm? Have you put a breakpoint in upsert() method in gwtorm code and verified that one single column was updated:\n\n  UPDATE account_diff_preferences set show_line_endings \u003d true where ...\n\n?",
      "parentUuid": "f6b07555_5191144b",
      "range": {
        "startLine": 124,
        "startChar": 4,
        "endLine": 148,
        "endChar": 63
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_8f151558",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 148,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-29T10:44:04Z",
      "side": 1,
      "message": "I didn\u0027t look on this level, but I did a simple integration test.\n\nTest Plan:\n1. Set all diff preferences to \u0027Hide\u0027 as shown in this screenshot [1].\n2. Set only \"show_tabs\" to true, done by curl [2]\n\nResult with old code:\nOnly the \"show_tabs\" setting is updated (see screenshot [3]):\n\n  $ curl --user admin:secret --digest -X PUT -d \u0027{\"show_tabs\": true}\u0027 --header \"Content-Type: application/json\" http://localhost:8080/a/accounts/self/preferences.diff\n  )]}\u0027\n  {\n    \"context\": 10,\n    \"ignore_whitespace\": \"IGNORE_NONE\",\n    \"line_length\": 100,\n    \"show_tabs\": true,\n    \"hide_top_menu\": true,\n    \"auto_hide_diff_table_header\": true,\n    \"hide_line_numbers\": true,\n    \"hide_empty_pane\": true,\n    \"tab_size\": 8,\n    \"theme\": \"DEFAULT\"\n  }\n\nResult with new code (this change):\nAlso other settings are updated (see screenshot [4]):\n\n  $ curl --user admin:secret --digest -X PUT -d \u0027{\"show_tabs\": true}\u0027 --header \"Content-Type: application/json\" http://localhost:8080/a/accounts/self/preferences.diff\n  )]}\u0027\n  {\n    \"context\": 10,\n    \"tab_size\": 8,\n    \"line_length\": 100,\n    \"intraline_difference\": true,\n    \"show_line_endings\": true,\n    \"show_tabs\": true,\n    \"show_whitespace_errors\": true,\n    \"syntax_highlighting\": true,\n    \"auto_hide_diff_table_header\": true,\n    \"theme\": \"DEFAULT\",\n    \"ignore_whitespace\": \"IGNORE_NONE\"\n  }\n\n\n[1] http://i.imgur.com/T7NN71A.png\n\n[2] curl --user admin:secret --digest -X PUT -d \u0027{\"show_tabs\": true}\u0027 --header \"Content-Type: application/json\" http://localhost:8080/a/accounts/self/preferences.diff\n\n[3] http://i.imgur.com/MmvBUTf.png\n\n[4] http://i.imgur.com/uazRHu2.png",
      "parentUuid": "b6ba7d35_eff14196",
      "range": {
        "startLine": 124,
        "startChar": 4,
        "endLine": 148,
        "endChar": 63
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "16342adb_6c9fdb76",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/account/SetDiffPreferences.java",
        "patchSetId": 34
      },
      "lineNbr": 148,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T20:49:32Z",
      "side": 1,
      "message": "Thanks for the detailed test case description. I missed the fact, that we support that only one single attribute can be passed. This code is broken in this case. The same is valid for GET/PUT EditPreferencesInfo REST handlers. Before write to git/db, first the record should be read from the backend, merged with nullable input record, and only then written back. The merge step was omitted, as I erroneously assumed, that the complete input is always passed, with only false values set to null.",
      "parentUuid": "b6ba7d35_8f151558",
      "range": {
        "startLine": 124,
        "startChar": 4,
        "endLine": 148,
        "endChar": 63
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_0f0c857d",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListKey.java",
        "patchSetId": 34
      },
      "lineNbr": 37,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-28T15:13:07Z",
      "side": 1,
      "message": "Do we need to update this when we modify the way how Whitespace is persisted in writeObject below?",
      "range": {
        "startLine": 37,
        "startChar": 20,
        "endLine": 37,
        "endChar": 42
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_8f9a356c",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListKey.java",
        "patchSetId": 34
      },
      "lineNbr": 37,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T06:28:41Z",
      "side": 1,
      "message": "I updated serialVersionUID in previous patch set, but reverted the update. See Dave\u0027s comment why: [1].\n\n* [1] https://gerrit-review.googlesource.com/#/c/61604/30/gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListKey.java@37",
      "parentUuid": "b6ba7d35_0f0c857d",
      "range": {
        "startLine": 37,
        "startChar": 20,
        "endLine": 37,
        "endChar": 42
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b07555_b17e809c",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListKey.java",
        "patchSetId": 34
      },
      "lineNbr": 37,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-29T09:53:37Z",
      "side": 1,
      "message": "Thanks for the pointer :-) I trust in Dave then.",
      "parentUuid": "b6ba7d35_8f9a356c",
      "range": {
        "startLine": 37,
        "startChar": 20,
        "endLine": 37,
        "endChar": 42
      },
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6ba7d35_cf19ddc0",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListLoader.java",
        "patchSetId": 34
      },
      "lineNbr": 24,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2015-10-28T15:13:07Z",
      "side": 1,
      "message": "unused import",
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b07555_f12648ee",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListLoader.java",
        "patchSetId": 34
      },
      "lineNbr": 24,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-29T06:28:41Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b6ba7d35_cf19ddc0",
      "revId": "6f2678a1d44006b299a543be1a21622ee8ba548b",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}