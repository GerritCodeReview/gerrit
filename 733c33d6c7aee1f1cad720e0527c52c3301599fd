{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "de7d1b0c_62280c28",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2024-01-11T13:52:20Z",
      "side": 1,
      "message": "Can you please elaborate on why not?\n\nAre you importing the cache state as well to save the recompute?\n\nIf the change notes are parsed and the cache state is constructed, we should do the right thing.",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 15,
        "endChar": 38
      },
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2b6b39eb_f9bfd3ab",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T14:27:03Z",
      "side": 1,
      "message": "\u003e Can you please elaborate on why not?\n\nSure, let\u0027s follow the code starting from `ChangeNoteCache.Loder` class and the `call` method. We use here the `ChangeNotesParser#parseAll()`, which is then calling the private `parseNotes()` method. Here in lines 894-896, we use `NoteDbUtil.pasrseIndent` to map the comment author ID using the `external-ids` cache. This is to link comments created on the other server instance, that used different account IDs to the current server instance account IDs. This means that we not only \"read and parse\" the data, but also compute _some_ of the values.\n\nThat mapping was introduced in change 376516, to facilitate importing projects (including review data) from other Gerrit instances.\n\nThe cache contract stays the same for the projects that were always hosted on that server instance. But, as we\u0027re right now dealing with the imported projects (after JGit and EGit projects code review was moved to eclipse.gerrithub.io) the contract is broken for them. This is nuanced and has multiple preconditions that need to be met before it occurs.\n\n\u003e Are you importing the cache state as well to save the recompute?\n\nSorry, I don\u0027t get what you mean, could you please elaborate?\n\n\u003e If the change notes are parsed and the cache state is constructed, we should do the right thing.\n\nI agree with this statement and do think that we are doing the _right thing_ right now, which is to map the comment author ID and store the mapped value in the cache. With this approach, we save a lot of code like \"is this my account id? if not, remap it to mine\".\n\nThe problem here is that in a very special case, we have used the cached (computed) value as a base for the `meta` branch update. Which leads to data corruption. This change removes that special case and always reads the base data for the `meta` update from the same branch.",
      "parentUuid": "de7d1b0c_62280c28",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 15,
        "endChar": 38
      },
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "78868493_37f70444",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-11T14:56:36Z",
      "side": 1,
      "message": "I believe there is a bug in the way we parse the change notes, because we end up with the account-id in the _home_ serverId but we leave the original `serverId` in `HumanComment`. See https://gerrit-review.googlesource.com/c/gerrit/+/376516/comment/eea9984a_401f2e38/",
      "parentUuid": "2b6b39eb_f9bfd3ab",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 15,
        "endChar": 38
      },
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a83de0cc_31836db7",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T15:08:08Z",
      "side": 1,
      "message": "Let\u0027s step back and rethink what we\u0027re trying to achieve here.\n\nFirst of all, this is a fix for a pending bug. Let\u0027s focus on getting that fixed and refrain from solving other _potential_ problems with caches/mapping/importing.\n\nSecondly, more \"mutations\" of data would not fix this problem, it will just make the diff bigger when bugs like this one occur.\n\nI do see two \"general\" solutions:\n1. Don\u0027t use cached values when writing data back to `meta` branch\n2. \"Migrate\" the data when they are imported, create a proper commit that would store \"previous server ID\" and \"previous account id\" in a list, then override those with current server data.\n\nHappy to discuss those separately.",
      "parentUuid": "78868493_37f70444",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 15,
        "endChar": 38
      },
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf99cca7_74316433",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 22,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2024-01-11T13:52:20Z",
      "side": 1,
      "message": "subtle",
      "range": {
        "startLine": 22,
        "startChar": 21,
        "endLine": 22,
        "endChar": 27
      },
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e69352a4_7cd9f9c4",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 22,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T14:27:03Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "cf99cca7_74316433",
      "range": {
        "startLine": 22,
        "startChar": 21,
        "endLine": 22,
        "endChar": 27
      },
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8a39421a_7a7ba709",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 44,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-11T11:55:54Z",
      "side": 1,
      "message": "Missing `Release-Notes` footer",
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "daa65cc5_380482c2",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 44,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T14:29:51Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8a39421a_7a7ba709",
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a5d56cbb_0bf0abad",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-11T11:55:54Z",
      "side": 1,
      "message": "Apart from the implications with the imported changes, I am concerned on the other side effects that this bug may have had with other parts of Gerrit. \n\nI see that the notes map was stored as instance variable in the cache loader and then reused ðŸ˜®",
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9404afa0_b8433313",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-01-11T12:21:48Z",
      "side": 1,
      "message": "I\u0027m not that much concerned, as this was the only usage of the \"mutable loader property\" so other parts should not be affected by this.\n\nUnless the same pattern was used in other places, then yes, we\u0027d still have similar issues.\n\nThis is self-contained and does not affect other parts of Gerrit.",
      "parentUuid": "a5d56cbb_0bf0abad",
      "revId": "733c33d6c7aee1f1cad720e0527c52c3301599fd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}