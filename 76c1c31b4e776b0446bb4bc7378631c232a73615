{
  "comments": [
    {
      "key": {
        "uuid": "2aa9c35f_44108e9f",
        "filename": "lib/js.defs",
        "patchSetId": 1
      },
      "lineNbr": 147,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2015-12-28T21:15:14Z",
      "side": 1,
      "message": "I think a better fix is to use $TMPDIR instead of $SRCDIR here (and below), since I believe that is guaranteed to be empty when the command runs.",
      "revId": "76c1c31b4e776b0446bb4bc7378631c232a73615",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aaa4d3ba_d061dc10",
        "filename": "lib/js.defs",
        "patchSetId": 1
      },
      "lineNbr": 147,
      "author": {
        "id": 1013702
      },
      "writtenOn": "2015-12-29T18:54:44Z",
      "side": 1,
      "message": "I do not get it working with $TMPDIR since it looks to be undefined in this place (not absolutely sure). I do not feel good changing here since I do not really understand the whole code at the moment. Would be great if somebody with better knowledge here could look into it.",
      "parentUuid": "2aa9c35f_44108e9f",
      "revId": "76c1c31b4e776b0446bb4bc7378631c232a73615",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "eac16b6d_3ab981eb",
        "filename": "lib/js.defs",
        "patchSetId": 1
      },
      "lineNbr": 147,
      "author": {
        "id": 1001240
      },
      "writtenOn": "2015-12-31T05:32:46Z",
      "side": 1,
      "message": "$TMP not $TMPDIR. See $TMP in the genrule() just a few lines down.",
      "parentUuid": "aaa4d3ba_d061dc10",
      "revId": "76c1c31b4e776b0446bb4bc7378631c232a73615",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aaa4d3ba_f0b260ac",
        "filename": "lib/js.defs",
        "patchSetId": 1
      },
      "lineNbr": 147,
      "author": {
        "id": 1013702
      },
      "writtenOn": "2016-01-03T11:43:21Z",
      "side": 1,
      "message": "When I replace the $SRCDIR in this line with $TMP, build does not fail. If I also replace the $SRCDIR on line 151, it fails, see message below.\n\nI do not feel good just to blindly replace this since I do not understand what is done here exactly...\n\nERROR finding /my_gerrit_checkout_folder/buck-out/gen/polygerrit-ui/app/gr-app__vulcanized__tmp/elements/gr-app.html\n{ [Error: ENOENT, open \u0027/my_gerrit_checkout_folder/buck-out/gen/polygerrit-ui/app/gr-app__vulcanized__tmp/elements/gr-app.html\u0027]\n  errno: -2,\n  code: \u0027ENOENT\u0027,\n  path: \u0027/my_gerrit_checkout_folder/buck-out/gen/polygerrit-ui/app/gr-app__vulcanized__tmp/elements/gr-app.html\u0027 }Traceback (most recent call last):\n  File \"/my_gerrit_checkout_folder/buck-out/gen/tools/js/run_npm_binary.pex/.bootstrap/_twitter_common_python/pex.py\", line 223, in execute\n    self.execute_entry(entry_point, args)\n  File \"/my_gerrit_checkout_folder/buck-out/gen/tools/js/run_npm_binary.pex/.bootstrap/_twitter_common_python/pex.py\", line 271, in execute_entry\n    runner(entry_point)\n  File \"/my_gerrit_checkout_folder/buck-out/gen/tools/js/run_npm_binary.pex/.bootstrap/_twitter_common_python/pex.py\", line 288, in execute_module\n    runpy.run_module(module_name, run_name\u003d\u0027__main__\u0027)\n  File \"/usr/lib/python2.7/runpy.py\", line 180, in run_module\n    fname, loader, pkg_name)\n  File \"/usr/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"tools/js/run_npm_binary.py\", line 91, in \u003cmodule\u003e\n  File \"tools/js/run_npm_binary.py\", line 87, in main\n  File \"/usr/lib/python2.7/subprocess.py\", line 540, in check_call\n    raise CalledProcessError(retcode, cmd)\nCalledProcessError: Command \u0027[\u0027/my_gerrit_checkout_folder/buck-out/gen/lib/js/vulcanize/vulcanize@1.14.0-91eac280d031b5bbcafb5f86bb6ed30515fa2564/package/bin/vulcanize\u0027, \u0027--inline-scripts\u0027, \u0027--inline-css\u0027, \u0027--strip-comments\u0027, \u0027--out-html\u0027, \u0027/my_gerrit_checkout_folder/buck-out/gen/polygerrit-ui/app/gr-app__vulcanized/gr-app.vulcanized.html\u0027, \u0027/my_gerrit_checkout_folder/buck-out/gen/polygerrit-ui/app/gr-app__vulcanized__tmp/elements/gr-app.html\u0027]\u0027 returned non-zero exit status 1",
      "parentUuid": "eac16b6d_3ab981eb",
      "revId": "76c1c31b4e776b0446bb4bc7378631c232a73615",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "eac16b6d_9a9bed5a",
        "filename": "lib/js.defs",
        "patchSetId": 1
      },
      "lineNbr": 147,
      "author": {
        "id": 1001240
      },
      "writtenOn": "2016-01-03T16:37:26Z",
      "side": 1,
      "message": "Right, sorry. I failed to read the old version. Someone else wrote to $SRCDIR in the genrule().\n\nIts not OK to write to $SRCDIR in a genrule(). You can only write to $TMP and $OUT. $SRCDIR is supposed to be an immutable collection of input files given to you from the srcs list. The fact that this rule writes to $SRCDIR is bad.\n\nIt looks like the second part run_npm_binary() fails because it needs the contents of $TMP and $SRCDIR merged together in the same directory tree.\n\nThe correct way to do that is copy $SRCDIR contents recursively into $TMP to merge with the output of the unzip in $TMP, and then start run_npm_binary() on $TMP.\n\nMaybe:\n\n  cmd \u003d \u0027 \u0027.join([\n      \u0027(cd $SRCDIR; tar c .) | (cd $TMP; tar x)\u0027,\n      \u0027\u0026\u0026\u0027, \u0027unzip -qd $TMP $(location %s)\u0027 % components,\n      \u0027\u0026\u0026\u0027, run_npm_binary(\u0027//lib/js:vulcanize\u0027)\n    ] + VULCANIZE_FLAGS + extra_flags + [\n      \u0027--out-html\u0027, \u0027$OUT\u0027,\n      \u0027$TMP/%s\u0027 % app,\n    ]),",
      "parentUuid": "aaa4d3ba_f0b260ac",
      "revId": "76c1c31b4e776b0446bb4bc7378631c232a73615",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}