{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "33105f42_c051b026",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 26,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "nit: `s/getarevisionNoteMap/getRevisionNoteMap`",
      "range": {
        "startLine": 26,
        "startChar": 38,
        "endLine": 26,
        "endChar": 57
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bc7eea7b_520c0561",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 35,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "nit: `s/id\u0027s/ids`",
      "range": {
        "startLine": 35,
        "startChar": 0,
        "endLine": 35,
        "endChar": 4
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fd12e4f7_9f57e90f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 38,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "nit: `s/id\u0027s/ids`",
      "range": {
        "startLine": 38,
        "startChar": 8,
        "endLine": 38,
        "endChar": 12
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "52adb4e5_06d5411c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 65,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "nit: `s/or/of`",
      "range": {
        "startLine": 65,
        "startChar": 68,
        "endLine": 65,
        "endChar": 70
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "243909d4_e26f9458",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 65,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "nit: `s/ChangeanotesaonlineMigrator/ChangeNotesOnlineMigrator`",
      "range": {
        "startLine": 65,
        "startChar": 14,
        "endLine": 65,
        "endChar": 41
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "98631554_39a18879",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 66,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "nit: `s/branch/ref`",
      "range": {
        "startLine": 66,
        "startChar": 41,
        "endLine": 66,
        "endChar": 47
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "22c1f4e0_98433de0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-02-17T02:41:37Z",
      "side": 1,
      "message": "Have you assessed the performance improvement introduced by this change my migrating the change vs. a non-migrated change?\n\nIt looks quite a complex solution, is this really worth the optimisation provided?",
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "024726af_725b39e9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "There are also tests failures",
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "12b6a8f7_713c19bc",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-02-20T09:43:20Z",
      "side": 1,
      "message": "yes, before I fix all of the test failures I wanted the approach make sense and could potentially be accepted.",
      "parentUuid": "024726af_725b39e9",
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d83c147a_67a6b1cd",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-02-20T09:43:20Z",
      "side": 1,
      "message": "It\u0027s not only the performance optimization but most importantly the \"consistency and predictability\" of NoteDb changes.\n\nFor me, the potential performance improvements are just a side effect. Keeping the commits in NoteDb predictable and always describing what they are changing IMO is more important.\n\nHaving said that, let me run the measurements locally. Bear in mind that any results are tightly coupled to the data stored in Gerrit, meaning, more \"external ID mappings\" will result in more time taken by the mapping and more savings after the migration.",
      "parentUuid": "22c1f4e0_98433de0",
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a003b026_38cb867f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-02-20T10:17:04Z",
      "side": 1,
      "message": "I did a simple performance test locally using `wrk` and `ported_commments/` REST endpoint, on my m1 air, with disabled `change_notes` cache (`memoryLimit \u003d 1` and `maxAge \u003d 1`), with only **two** imported account.\n\nBefore \"on-line\" migration:\n```\n  5 threads and 10 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency    33.08ms   41.23ms 494.40ms   88.19%\n    Req/Sec    90.39     40.20   257.00     66.14%\n  53687 requests in 2.00m, 321.38MB read\nRequests/sec:    447.00\nTransfer/sec:      2.68MB\n```\n\nAfter \"on-line\" migration:\n```\n  5 threads and 10 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency    26.91ms   33.03ms 368.54ms   87.29%\n    Req/Sec   113.68     48.89   330.00     68.76%\n  67803 requests in 2.00m, 405.88MB read\nRequests/sec:    564.55\nTransfer/sec:      3.38MB\n```\n\nFrom the above, it looks that after migrating the imported change average latency went down about 18% and overall _Request/sec_ went up for about 20%. We\u0027re looking on a measurable performance improvement even when only a **two** accounts are mapped.",
      "parentUuid": "d83c147a_67a6b1cd",
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3e01ec39_3e4f8a29",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesOnlineMigrator.java",
        "patchSetId": 2
      },
      "lineNbr": 95,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "nit: TBH `Persist mutations to notes` could mean anything 😊 how about stating that account ids migration was performed?",
      "range": {
        "startLine": 95,
        "startChar": 19,
        "endLine": 95,
        "endChar": 45
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "15a98ad9_f4f2cac7",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesOnlineMigrator.java",
        "patchSetId": 2
      },
      "lineNbr": 95,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-02-20T12:58:25Z",
      "side": 1,
      "message": "With the current implementation we don\u0027t know what is migrated, we get the already migrated output from `ChangeNotesParser` that migrates the notes.\n\nCurrently we assume that the account IDs are migrated, but this may change in the future.",
      "parentUuid": "3e01ec39_3e4f8a29",
      "range": {
        "startLine": 95,
        "startChar": 19,
        "endLine": 95,
        "endChar": 45
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9920d894_9d79106b",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesOnlineMigrator.java",
        "patchSetId": 2
      },
      "lineNbr": 95,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-22T06:55:46Z",
      "side": 1,
      "message": "\u003e With the current implementation we don\u0027t know what is migrated (...)\n\nTrue but OTOH this class is called `ChangeNotesOnlineMigrator`, IMHO `migration` should be reflected in the commit message 😊 the other option is to get info about what was modified from the `parser` to take the informed decision, WDYT?",
      "parentUuid": "15a98ad9_f4f2cac7",
      "range": {
        "startLine": 95,
        "startChar": 19,
        "endLine": 95,
        "endChar": 45
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6f507558_9d4ed66b",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesOnlineMigrator.java",
        "patchSetId": 2
      },
      "lineNbr": 95,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-02-22T10:07:30Z",
      "side": 1,
      "message": "Sure, we can keep track of the account IDs mapping in the parser, but:\n* it will be _computed_ on every read of every change (which feels a bit too much),\n* will be used only once when (eventually) the mutations will be persisted,\n* the _parser_ feels like the wrong place for such a thing.\n\nI don\u0027t think that we should list all of the migrated account IDs in the commit message, that information can be _easily_ found in the diff. We can probably mention the overall count, but I\u0027m not sure if that information will be meaningful.",
      "parentUuid": "9920d894_9d79106b",
      "range": {
        "startLine": 95,
        "startChar": 19,
        "endLine": 95,
        "endChar": 45
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "64efd221_4fbdac3c",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesParser.java",
        "patchSetId": 2
      },
      "lineNbr": 209,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-20T08:06:43Z",
      "side": 1,
      "message": "`boolean`? so that `firstNonNull` is not needed in line `#323`? and then condition check in line `#969` could be changed from `mutated \u003d\u003d null` to `!mutated`",
      "range": {
        "startLine": 209,
        "startChar": 10,
        "endLine": 209,
        "endChar": 17
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8ad4b004_a52b5359",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesParser.java",
        "patchSetId": 2
      },
      "lineNbr": 209,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-02-20T09:43:20Z",
      "side": 1,
      "message": "I\u0027ve followed the pattern with other boolean values in this file, see lines #196-199",
      "parentUuid": "64efd221_4fbdac3c",
      "range": {
        "startLine": 209,
        "startChar": 10,
        "endLine": 209,
        "endChar": 17
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fad9e9d7_7249aa2e",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesParser.java",
        "patchSetId": 2
      },
      "lineNbr": 209,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-22T06:55:46Z",
      "side": 1,
      "message": "Yes and no 😊 the other booleans describe the change _features_ whereas `mutated` is pure technical marker that indicates if notes were modified. Having said that I will leave it up to you decide.",
      "parentUuid": "8ad4b004_a52b5359",
      "range": {
        "startLine": 209,
        "startChar": 10,
        "endLine": 209,
        "endChar": 17
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d53ec414_f562604d",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesParser.java",
        "patchSetId": 2
      },
      "lineNbr": 472,
      "author": {
        "id": 1010134
      },
      "writtenOn": "2024-02-20T12:58:25Z",
      "side": 1,
      "message": "using server identifier can be potentially problematic for two reasons:\n* server identifier can be changed\n* when migrating to another instance the server identifier will definitely be different\n\nWhen the server identity will not match, it will result in a parse error.\n\nInstead, we can use a commit footer, something like `Data-Migration-Commit`, WDYT?",
      "range": {
        "startLine": 472,
        "startChar": 8,
        "endLine": 472,
        "endChar": 49
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "11fd67ef_129342bd",
        "filename": "java/com/google/gerrit/server/notedb/ChangeNotesParser.java",
        "patchSetId": 2
      },
      "lineNbr": 472,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2024-02-22T06:55:46Z",
      "side": 1,
      "message": "👍",
      "parentUuid": "d53ec414_f562604d",
      "range": {
        "startLine": 472,
        "startChar": 8,
        "endLine": 472,
        "endChar": 49
      },
      "revId": "78f266c75381c4902094cf8e1369835a7232d58a",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}