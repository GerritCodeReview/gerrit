{
  "comments": [
    {
      "key": {
        "uuid": "10cb2096_5391c459",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/TestSubmitType.java",
        "patchSetId": 2
      },
      "lineNbr": 60,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-10-14T06:21:34Z",
      "side": 1,
      "message": "In second thought leaking OrmException from SRE is, well, unfortunate. It\u0027s only needed to construct/retrieve ChangeControl. Looks like we could easily avoid this ugliness. Number of different approaches:\n\n* we could construct ChangeData with ChangControl, and provide another interface for ChangeData.changeControl() throws OrmException; that doesn\u0027t throw anything, say changeControlExists(). We could even checkNotNull() in this implementation. Justification: we have AssistedInject constructor that accepts ChangeControl and initilizes this instance in the ctor.\n* we could pass ChangeControl instance (that we have in all caller places) in SRE constructor and not bother to retrieve it from ChangeData at all.\n* Use a combintaion of two approaches above, something like this [1].\n\n [1] http://paste.openstack.org/show/120907",
      "range": {
        "startLine": 60,
        "startChar": 49,
        "endLine": 60,
        "endChar": 61
      },
      "revId": "7c7122e2df2444a74bf44083244a507fe953bf91",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "70d9bc6e_aeef7714",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/TestSubmitType.java",
        "patchSetId": 2
      },
      "lineNbr": 60,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2014-10-14T17:42:12Z",
      "side": 1,
      "message": "This is the kind of thing I\u0027ve literally wasted days or weeks trying to get things ready for notedb. If there\u0027s one thing I\u0027ve learned, it\u0027s if you can initialize something in two ways, and you assume it\u0027s been initialized in one way, you are guaranteed to find some call path where it\u0027s initialized the wrong way.\n\nBelieve me, I wish we could guarantee a ChangeData was always constructed with a ChangeControl. The 3 @AssistedInject methods in ChangeData are already pretty ugly. But in this case, I know off the top of my head the reason we can\u0027t guarantee a ChangeData comes with a ChangeControl is in the search code path you just get Change.Ids back from the index. (Actually schema versions \u003e\u003d 2 have a serialized Change in the index, but still no ChangeControl. I digress.)\n\nThrowing OrmException from SubmitRuleEvaluator methods is unfortunate, yes, but how bad is it really? Some errors get converted to error records, some result in thrown exceptions. This is true even if we work to convert this one more OrmException case to a record.\n\nAlso, if we forced callers to construct a ChangeControl when they didn\u0027t have one, and the database were corrupt in such a way that that operation would generate an OrmException, it _still_ wouldn\u0027t get converted to an error record, because the OrmException would get thrown before the ChangeControl ever got constructed.\n\nSo it seems to me we\u0027re just left with the ugliness of one more extra exception thrown from this handler, which I\u0027m not too worried about considering its signature already.",
      "parentUuid": "10cb2096_5391c459",
      "range": {
        "startLine": 60,
        "startChar": 49,
        "endLine": 60,
        "endChar": 61
      },
      "revId": "7c7122e2df2444a74bf44083244a507fe953bf91",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "10cb2096_73c96062",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/TestSubmitType.java",
        "patchSetId": 2
      },
      "lineNbr": 60,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-10-14T19:09:44Z",
      "side": 1,
      "message": "Two points:\n\n1. One reason for all this reshuffling is to make it easier (if not to say possible) to use SRE in context of moving mergeable bits out of database to notedb. It\u0027s a bit ridiculus, that to make the code notedb ready, we have to add ORM exception to method signatures. Probably we need a generall replacement to rethrow a ORM exception if something unexpected happens. For example NotedbException. We ca do this later.\n\n2. I\u0027m kind of concerned about the performance along the notedb conversion way. You mentioned this too in other comments. For example you argued in this change to explicitly pass patch set to SRE to prevent unnecessary database lookup. OTOH here, in curernt patch set we make things worse by not passing already created change control instance in SRE and forcing to retrieve/create it again even though we have the instance and even though the ChangeData class has AssistedInject ctor that accepts change control instance. As shown in my prototype, on line 69 different ChangeData ctor should be used:\n\n  changeDataFactory.create(db.get(), rsrc.getControl())\n\nNote, that ChangeData in ChangControl is created this way  (when it\u0027s created there and not passed in already) passing existing ChangeControl instance (this):\n\n  changeDataFactory.create(db, this);",
      "parentUuid": "70d9bc6e_aeef7714",
      "range": {
        "startLine": 60,
        "startChar": 49,
        "endLine": 60,
        "endChar": 61
      },
      "revId": "7c7122e2df2444a74bf44083244a507fe953bf91",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "70d9bc6e_4e07f33d",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/TestSubmitType.java",
        "patchSetId": 2
      },
      "lineNbr": 60,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2014-10-14T19:44:46Z",
      "side": 1,
      "message": "\u003e Probably we need a generall replacement to rethrow a ORM exception if something unexpected happens.\n\nUndecided.\n\nI made notedb methods throw OrmException to avoid throwing two exception types from every utility class method during the transitional period.\n\nOnce reviewdb is gone, OrmException will no longer be overloaded, it will go back to meaning \"error reading from the database.\" (Ok, so OrmException is in gwtorm, and if we kill gwtorm we will have to use something else. But you see my point.)\n\nDefinitely unrelated to this change.\n\n\u003e we make things worse by not passing already created change control instance\n\nYes, there are likely lots of places we are calling the wrong factory method.\n\nMaybe we should revisit the ChangeData factory methods. Force everyone to provide a ChangeControl except in the search results case. Rename the method  to something like ChangeDataFactory.createNoReallyIOnlyHaveAChangeIdIPromise to make it obvious that \n\nAlso mostly unrelated to this change (although I will fix the instance below).\n\nI appreciate your input here, I really do, but if we stall incremental improvements with long discussions about sweeping API changes, nothing will get done. I know this from experience working on sweeping API changes for notedb :)",
      "parentUuid": "10cb2096_73c96062",
      "range": {
        "startLine": 60,
        "startChar": 49,
        "endLine": 60,
        "endChar": 61
      },
      "revId": "7c7122e2df2444a74bf44083244a507fe953bf91",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "10cb2096_53c66452",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/TestSubmitType.java",
        "patchSetId": 2
      },
      "lineNbr": 60,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-10-14T20:00:19Z",
      "side": 1,
      "message": "| I appreciate your input here, I really do, but if we stall incremental improvements with long discussions about sweeping API changes, nothing will get done.\n\nSo let\u0027s stop the discussion then, swap to another assisted inject ctor on line 69 and move forward with the life.",
      "parentUuid": "70d9bc6e_4e07f33d",
      "range": {
        "startLine": 60,
        "startChar": 49,
        "endLine": 60,
        "endChar": 61
      },
      "revId": "7c7122e2df2444a74bf44083244a507fe953bf91",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f0e5ac1c_12e7cce8",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/change/TestSubmitType.java",
        "patchSetId": 2
      },
      "lineNbr": 69,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2014-10-14T19:09:44Z",
      "side": 1,
      "message": "This should be:\n\n  changeDataFactory.create(db.get(), rsrc.getControl()));",
      "range": {
        "startLine": 69,
        "startChar": 8,
        "endLine": 69,
        "endChar": 62
      },
      "revId": "7c7122e2df2444a74bf44083244a507fe953bf91",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}