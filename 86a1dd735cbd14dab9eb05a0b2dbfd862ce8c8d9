{
  "comments": [
    {
      "key": {
        "uuid": "9bb15e9e_580e81c9",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2017-06-16T07:46:41Z",
      "side": 1,
      "message": "there is another side of this story - plugins that change configuration (alter All-Projects project for instance) upon start. They fail miserably with this change and cannot be properly started anymore.\n\nHaving said that I would say that we should revert this change (it brakes our integration :/) and address this problem differently:\n1. specify which plugins have to start prior or after index (this seems to be the simplest) and if not specified we could start them before (as it is with this change)\n2. develop and listen to indexes ready event so that plugins could postpone their configuration until it is possible\n3. ...",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "86ebf97b_da8a1b14",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2017-06-16T09:35:14Z",
      "side": 1,
      "message": "\u003e there is another side of this story - plugins that change configuration (alter All-Projects project for instance) upon start. They fail miserably with this change and cannot be properly started anymore.\n\nCan you provide more details on why do they fail and why they cannot be started anymore?\nEspecially I would like to understand why to they permanently fail to start even after\nGerrit server is fully started (indexes ready) and the plugin is reloaded after that.\n\n\u003e \n\u003e Having said that I would say that we should revert this change (it brakes our integration :/)\n\nDoes it only brake or does it break your integration ;-)\n\n\u003e and address this problem differently:\n\u003e 1. specify which plugins have to start prior or after index (this seems to be the simplest) and if not specified we could start them before (as it is with this change)\n\u003e 2. develop and listen to indexes ready event so that plugins could postpone their configuration until it is possible\n\nThe solution 2. sounds less intrusive to the Gerrit core code.\n\n\u003e 3. ...",
      "parentUuid": "9bb15e9e_580e81c9",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0be9d2c9_9d1c9f58",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2017-06-16T09:50:56Z",
      "side": 1,
      "message": "\u003eCan you provide more details on why do they fail and why they cannot be started anymore?\n\u003e Especially I would like to understand why to they permanently fail to start even after\n\u003e Gerrit server is fully started (indexes ready) and the plugin is reloaded after that.\n\nwe have a plugin that does both: implements auth/group backends and modifies All-Projects (it does couple of things there for instance remove anonymous access to projects, etc...) so it fails during All-Projects project modification (of course it all works nicely during close upgrade as everything is already modified and nothing needs to be changed ;)) and by that it fails to load which leads to inability to reload the plugin (user fails to authorise) which I would say doesn\u0027t look to good to me either ;)\n\n\u003e Does it only brake or does it break your integration ;-)\n\nIt brakes our integration. I understand that you may not be particularly interested in that ;) but if it breaks this plugin it may break the others but we don\u0027t know that yet. What is more I am not saying that we should get rid off this change. I understand the rationale behind it. I am trying to say that we should at least try to not break anything that was working so far by introducing it :)\n\n\u003e The solution 2. sounds less intrusive to the Gerrit core code.\n\nsolution 2 would require changes to Gerrit core anyway and it will be for sure far more more intrusive to plugin in question ;) whereas solution 1 (despite being less elegant) is pretty simple to implement in both plugins and Gerrit core :D",
      "parentUuid": "86ebf97b_da8a1b14",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4357ea4d_1109dd96",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2017-06-16T10:56:47Z",
      "side": 1,
      "message": "\u003e we have a plugin that does both: implements auth/group backends and modifies All-Projects (it does couple of things there for instance remove anonymous access to projects, etc...) so it fails during All-Projects project modification\n\nCan you also let us know what is causing the failure?\n\nI don\u0027t really intend to suggest any particular modifications to your plugin code but\nI guess that you had a good reason not to implement these All-Projects adaption as\nan init-step contributed by your plugin? After all, you want to run this adaption only\nonce, not every time when the plugin is started.\n\n\u003e (of course it all works nicely during close upgrade as everything is already modified and nothing needs to be changed ;)) and by that it fails to load which leads to inability to reload the plugin (user fails to authorise) which I would say doesn\u0027t look to good to me either ;)\n\nWould reloading by touching the plugin jar (at the server side) work?\nNot that I am suggesting this as solution, just to understand how persistent your issue\nwith plugin loading is.\n\n\n\u003e \n\u003e \u003e The solution 2. sounds less intrusive to the Gerrit core code.\n\u003e \n\u003e solution 2 would require changes to Gerrit core anyway and it will be for sure far more more intrusive to plugin in question ;) whereas solution 1 (despite being less elegant) is pretty simple to implement in both plugins and Gerrit core :D\n\nSolution 1, has IMHO, one disadvantage: it considers plugin loading order based on\none criteria: before/after indexes are available but it doesn\u0027t propose how such approach\nwould evolve in future.\nWhat if, in future, we need to support yet another before/after policy.\nWhat if plugin A needs to be loaded before X is available but also after Y is available and Y is available after X is available?",
      "parentUuid": "0be9d2c9_9d1c9f58",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "71e93c77_84ebaaa7",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2017-06-16T12:18:40Z",
      "side": 1,
      "message": "Not clear to me how it may break during reload. If you share the code we can help out.",
      "parentUuid": "4357ea4d_1109dd96",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "tag": "mailMessageId\u003d\u003c93F575DD-0028-47F9-9322-77BE9B59B09F@gmail.com\u003e",
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "74d4442d_d6a1fa04",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2017-06-16T12:18:40Z",
      "side": 1,
      "message": "Can you share the code of the plugin? I am assuming it is based in the start() method to work on the Lucene index assuming that it is ready at startup, which is exactly what here we are trying to fix",
      "parentUuid": "4357ea4d_1109dd96",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "tag": "mailMessageId\u003d\u003c93F575DD-0028-47F9-9322-77BE9B59B09F@gmail.com\u003e",
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "43c68c02_408839ee",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2017-06-19T07:06:17Z",
      "side": 1,
      "message": "Unfortunately I can\u0027t share the code :/ but I can share what and why is failing. Your assumptions are correct it all happens in start and fails particularly with account creation (as account index is not yet ready):\n\nCaused by: java.lang.NullPointerException: no active search index configured for accounts\nat com.google.common.base.Preconditions.checkNotNull(Preconditions.java:787)\nat com.google.gerrit.server.index.account.AccountIndexRewriter.rewrite(AccountIndexRewriter.java:45)\nat com.google.gerrit.server.query.QueryProcessor.query(QueryProcessor.java:173)\nat com.google.gerrit.server.query.QueryProcessor.query(QueryProcessor.java:135)\nat com.google.gerrit.server.query.QueryProcessor.query(QueryProcessor.java:122)\nat com.google.gerrit.server.query.InternalQuery.query(InternalQuery.java:71)\nat com.google.gerrit.server.query.account.InternalAccountQuery.byExternalId(InternalAccountQuery.java:80)\nat com.google.gerrit.server.query.account.InternalAccountQuery.oneByExternalId(InternalAccountQuery.java:92)\nat com.google.gerrit.server.account.AccountManager.findExternalId(AccountManager.java:174)\nat com.google.gerrit.server.account.AccountManager.create(AccountManager.java:140)",
      "parentUuid": "74d4442d_d6a1fa04",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "42eda20b_847e6816",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2017-06-19T07:06:17Z",
      "side": 1,
      "message": "In order to reload over SSH one needs to authorise itself. It is not possible anymore if authorising plugin fails to start (this is our case). Touching the jar file works but I can\u0027t imagine this is production solution ;)",
      "parentUuid": "71e93c77_84ebaaa7",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "5a763f56_1406d629",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2017-06-19T07:06:17Z",
      "side": 1,
      "message": "\u003e I don\u0027t really intend to suggest any particular modifications to your plugin code but\nI guess that you had a good reason not to implement these All-Projects adaption as\nan init-step contributed by your plugin? After all, you want to run this adaption only\nonce, not every time when the plugin is started.\n\nIn theory (and in day to day practice) those modifications are done once (when Gerrit is started for the very first time) but in case one misconfigures instance it fixes itself during next reboot (or plugin reload to be precise) which is way faster and less scary than call to gerrit init. See my answer to Luca what is actually failing and why.\n\n\u003e Solution 1, has IMHO, one disadvantage: it considers plugin loading order based on\none criteria: before/after indexes are available but it doesn\u0027t propose how such approach\nwould evolve in future.\nWhat if, in future, we need to support yet another before/after policy.\nWhat if plugin A needs to be loaded before X is available but also after Y is available and Y is available after X is available?\n\nProperly written plugin dependencies should solve the problem right? But it is being raised multiple times time already ;)",
      "parentUuid": "4357ea4d_1109dd96",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "524f10df_fc31affc",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2017-06-19T07:32:04Z",
      "side": 1,
      "message": "I see, so you would need a way to know when Gerrit is ready and have your plugin activated at *that* time. Why don\u0027t we just define a new event for that? The start() of the lifecycle listener isn\u0027t the right place anyway, because you may have other plugins that are crucial for Gerrit authentication (e.g. OAuth) and you cannot assume that everything is up-and-running at the lifecycle listener start().\n\nIMHO you were making a too optimistic assumption on your plugin :-)",
      "parentUuid": "5a763f56_1406d629",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "16553569_8f3f60dc",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2017-06-19T09:15:53Z",
      "side": 1,
      "message": "\u003e Properly written plugin dependencies should solve the problem\n \u003e right? But it is being raised multiple times time already ;)\n\nThis issue is not (only) about plugin dependencies but also about plugins depending on Gerrit core lifecycle events. AFAIK, Gerrit doesn\u0027t\ndocument when a plugins LifecycleListener.start() method will be called\nand which Gerrit core components are guaranteed to be started at that time.",
      "parentUuid": "5a763f56_1406d629",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7897772c_e45fd57e",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2017-06-19T09:15:53Z",
      "side": 1,
      "message": "\u003e I see, so you would need a way to know when Gerrit is ready and\n \u003e have your plugin activated at *that* time. Why don\u0027t we just define\n \u003e a new event for that?\n\n+1\nHowever, just we should in that case also improve the documentation\nand explain the difference between the LifecycleListener.start() and the (new) onGerritReady event.\n\n\u003e The start() of the lifecycle listener isn\u0027t\n \u003e the right place anyway, because you may have other plugins that are\n \u003e crucial for Gerrit authentication (e.g. OAuth) and you cannot\n \u003e assume that everything is up-and-running at the lifecycle listener\n \u003e start().\n \u003e \n \u003e IMHO you were making a too optimistic assumption on your plugin :-)\n\nWell, one could also say that the site indexer also made a too optimistic assumption that all plugins were loaded when it started. It could also have waited until the (new) onGerritReady event.",
      "parentUuid": "524f10df_fc31affc",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8393353c_383316f5",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2017-06-19T09:25:49Z",
      "side": 1,
      "message": "Yeap, if documentation is not precise one creates solution that works not necessary the optimal one ;)",
      "parentUuid": "16553569_8f3f60dc",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8d78207f_6ca5ab5c",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1025452
      },
      "writtenOn": "2017-06-19T09:25:49Z",
      "side": 1,
      "message": "\u003e I see, so you would need a way to know when Gerrit is ready and have your plugin activated at *that* time. Why don\u0027t we just define a new event for that?\n+1\n\nThat sounds OK but it would be also good to have some sort of status to check in case plugin is reloaded...",
      "parentUuid": "7897772c_e45fd57e",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8b957602_dca4af17",
        "filename": "gerrit-pgm/src/main/java/com/google/gerrit/pgm/Daemon.java",
        "patchSetId": 7
      },
      "lineNbr": 368,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2017-06-19T09:43:51Z",
      "side": 1,
      "message": "\u003e \u003e IMHO you were making a too optimistic assumption on your plugin\n \u003e :-)\n \u003e \n \u003e Well, one could also say that the site indexer also made a too\n \u003e optimistic assumption that all plugins were loaded when it started.\n \u003e It could also have waited until the (new) onGerritReady event.\n\nThis is subtle what onGerritReady actually means, and whether one single event will be sufficient:\n\n* 1. PluginsLoadReady\n* 2. SiteIndexerReady\n\nNow some specific plugins can listen to SiteIndexerReady event and perform their initialisation work the depends on indexes to be available.",
      "parentUuid": "7897772c_e45fd57e",
      "range": {
        "startLine": 368,
        "startChar": 4,
        "endLine": 368,
        "endChar": 36
      },
      "revId": "86a1dd735cbd14dab9eb05a0b2dbfd862ce8c8d9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}