{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "8d7c8f5c_c7515de2",
        "filename": "java/com/google/gerrit/server/restapi/project/ListProjects.java",
        "patchSetId": 1
      },
      "lineNbr": 586,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2021-10-01T14:49:14Z",
      "side": 0,
      "message": "This is a magic permission that should check if the user was granted\n\nread refs/*\n\nwith no active block permission.\n\nIt should not actually check all refs (if it would, that\u0027d be a regression/bug).\n\nThis is basically a shortcut where we spare further permission checks if the user has broad read permissions.",
      "range": {
        "startLine": 586,
        "startChar": 8,
        "endLine": 586,
        "endChar": 98
      },
      "revId": "88ab2404c2ae42ad8c30546b4565bb66b4cb1bf8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4a2f4d46_2a46eab7",
        "filename": "java/com/google/gerrit/server/restapi/project/ListProjects.java",
        "patchSetId": 1
      },
      "lineNbr": 586,
      "author": {
        "id": 1118500
      },
      "writtenOn": "2021-10-01T15:38:26Z",
      "side": 0,
      "message": "Thank you for the poiner.\nLooks like it would check permission for each ref pattern that has \u0027read\u0027 permission block[1] in project.config\n\nWhich probably just does not scale if there are many read blocks in the config.\n\nFor large project.config with many per-ref overrides, this could be problematic.\n\n[1]https://gerrit.googlesource.com/gerrit/+/refs/heads/master/java/com/google/gerrit/server/permissions/ProjectControl.java#293",
      "parentUuid": "8d7c8f5c_c7515de2",
      "range": {
        "startLine": 586,
        "startChar": 8,
        "endLine": 586,
        "endChar": 98
      },
      "revId": "88ab2404c2ae42ad8c30546b4565bb66b4cb1bf8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b224a006_c53d690d",
        "filename": "java/com/google/gerrit/server/restapi/project/ListProjects.java",
        "patchSetId": 1
      },
      "lineNbr": 586,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2021-10-04T07:43:20Z",
      "side": 0,
      "message": "The logs you pasted internally, show that the shortcut itself is not used (we evaluate the permissions ref-by-ref in l.721 as far as I can see from the logs. So we then do ref-by-ref permission evaluations.\n\nBesides that, the shortcut is checked only once per project, so I don\u0027t think it\u0027s the culprit of slowness here.\n\nOther than that, what confuses me a bit is that the user is asking for a single branch specifically with the \"b\" query option, but the logs look like we evaluate other branches as well? That would make it unnecessary complex by an order of magnitude (do we pass in more branches than are given by the -b option to this code?) :-) Have you already looked into that?",
      "parentUuid": "4a2f4d46_2a46eab7",
      "range": {
        "startLine": 586,
        "startChar": 8,
        "endLine": 586,
        "endChar": 98
      },
      "revId": "88ab2404c2ae42ad8c30546b4565bb66b4cb1bf8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fac96af5_effbc234",
        "filename": "java/com/google/gerrit/server/restapi/project/ListProjects.java",
        "patchSetId": 1
      },
      "lineNbr": 586,
      "author": {
        "id": 1118500
      },
      "writtenOn": "2021-10-04T08:35:05Z",
      "side": 0,
      "message": "I confirmed the problem is with the specific project.config. That project.config had \u003e70 read blocks which makes the shortcut not really a shortcut.\nFor this specific endpoint, I think it would make more sense to check permissions per-branch, since it is expected that N of branches in the query is small.\n\nWhat do you think?",
      "parentUuid": "4a2f4d46_2a46eab7",
      "range": {
        "startLine": 586,
        "startChar": 8,
        "endLine": 586,
        "endChar": 98
      },
      "revId": "88ab2404c2ae42ad8c30546b4565bb66b4cb1bf8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8f04c946_34187d7c",
        "filename": "java/com/google/gerrit/server/restapi/project/ListProjects.java",
        "patchSetId": 1
      },
      "lineNbr": 586,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2021-10-04T09:58:03Z",
      "side": 0,
      "message": "Thank you. For context, Maria investigated the issue more and has logs and a unit test that show that we evaluate every access pattern for the READ check on the repo. For some of our complicated repos, that is over 70 checks (number of access patterns).\n\nI was originally concerned that just removing this shortcut will cause a performance degradation. I checked when it was added and the change [1] that added it replaced an earlier shortcut that checked if the user is a repo owner. Repo owners present the minority of users. The repo owner check is cheaper as it doesn\u0027t cause us to go through the full list of access patterns. So I am less concerned now, actually :-) Let\u0027s try and see if this helps. Sorry for the noise!\n\n[1] https://gerrit-review.googlesource.com/c/gerrit/+/131811/9/gerrit-server/src/main/java/com/google/gerrit/server/project/ListProjects.java",
      "parentUuid": "fac96af5_effbc234",
      "range": {
        "startLine": 586,
        "startChar": 8,
        "endLine": 586,
        "endChar": 98
      },
      "revId": "88ab2404c2ae42ad8c30546b4565bb66b4cb1bf8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}