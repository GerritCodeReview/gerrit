{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "7112693d_f52709d8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 13,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-05-30T20:43:47Z",
      "side": 1,
      "message": "gracefulStopTimeout",
      "range": {
        "startLine": 13,
        "startChar": 42,
        "endLine": 13,
        "endChar": 62
      },
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2c0dc92d_3c7e551a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 13,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-08T21:00:40Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "7112693d_f52709d8",
      "range": {
        "startLine": 13,
        "startChar": 42,
        "endLine": 13,
        "endChar": 62
      },
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d0cc31f1_436d2113",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2021-05-29T04:27:07Z",
      "side": 1,
      "message": "Just taking the timeout values configured in gerrit.config might not help in every case. Consider the case that the timeout is reached without all requests finished. In that case Gerrit will continue the shutdown after closing all connections. However, gerrit.sh would in this case still forcefully kill Gerrit at around this time. Thus, gerrit.sh would have to get some buffer on top of the configured value.",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9bd51b19_3ab73e63",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-05-30T20:43:47Z",
      "side": 1,
      "message": "This is a tradeoff between\n- being able to finish shutdown within a reasonable time\n- avoid killing requests in flight\n\nCloning a large repository can take half an hour, using a timeout of 30min would mean that a rolling restart of a 3 node cluster could take up to 90min hence I\u0027d go for a timeout of something like 5min and expect clients to retry failed requests.",
      "parentUuid": "d0cc31f1_436d2113",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "76077500_50dad4c6",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-08T21:00:40Z",
      "side": 1,
      "message": "Killing an in-flight clone isn\u0027t a problem, but killing an in-flight push *IS* a big problem because it may left behind locks on the filesystem.\n\nThere is already tolerance of a few seconds in the gerrit.sh script before killing, but are you suggesting yet another timeout configuration in gerrit.config for the graceful stop of the forced shutdown? I believe it would be a bit overkill for that.\n\nWDYT?",
      "parentUuid": "9bd51b19_3ab73e63",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1d7ca9ef_4aa2a37e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-06-09T11:28:27Z",
      "side": 1,
      "message": "Maybe we should detect and auto-cleanup stale locks during start ?\n\nI wouldn\u0027t add another timeout option for the startup script.",
      "parentUuid": "76077500_50dad4c6",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "907c93bd_d5d02fa1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-06-09T16:16:51Z",
      "side": 1,
      "message": "\u003e Maybe we should detect and auto-cleanup stale locks during start ?\n\nWe\u0027re getting off topic for this change, but... ðŸ˜Š\n\nDefining \"stale\" is challenging here, especially with multi-primary setups. If we really want to solve this, I think it should be a discussion with the git community on transactional support for updates in git. I think we need it eventually (especially in cloud-native use cases) and that\u0027s going to be the only robust way to solve stale locks.\n\nYou can get by with some hacks where you use information from other processes in your cluster (or lack thereof) to do time-based staleness, but it\u0027s always going to be risky.",
      "parentUuid": "1d7ca9ef_4aa2a37e",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "58a37ed2_a4d29988",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-18T01:00:17Z",
      "side": 1,
      "message": "I believe the discussion is diverging :-) \nThis change is for fixing a serious bug we have at the moment: you request Gerrit to wait 15 minutes for incoming traffic to drain, but the process is killed with -9 after 30 seconds.\n\nWe had repos corruptions with files and locks left behind because of that, it would be useful to fix the issue and then making it even better and more clever.",
      "parentUuid": "907c93bd_d5d02fa1",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cb2f10b7_d5cd8bfb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-06-20T12:08:18Z",
      "side": 1,
      "message": "I agree, I think the change looks good. Though we should mitigate the situation Thomas mentioned. How about adding 10sec to the configured timeout for that ?",
      "parentUuid": "58a37ed2_a4d29988",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "51acca61_591923a3",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2021-06-23T07:22:23Z",
      "side": 1,
      "message": "The shutdown time of Gerrit might differ depending on the system. 10s might not always be enough. However, I definitely agree that we should avoid yet another timeout option. So adding a fixed delay would indeed be the easiest way to go. Why not keep the 30s used already?",
      "parentUuid": "cb2f10b7_d5cd8bfb",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "639fe4e2_e7724d88",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-23T19:16:06Z",
      "side": 1,
      "message": "\u003e The shutdown time of Gerrit might differ depending on the system. 10s might not always be enough. However, I definitely agree that we should avoid yet another timeout option. So adding a fixed delay would indeed be the easiest way to go. Why not keep the 30s used already?\n\nThe whole point is using what is configured and NOT an hardcoded value, such as 30s. Or do you mean adding 30s to the configured timeout?",
      "parentUuid": "51acca61_591923a3",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fc61a702_85b934f5",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-06-23T22:23:18Z",
      "side": 1,
      "message": "the idea is to add 30sec for the start script\u0027s timeout to prevent that the start scripts forcefully kills the Java process before the respective ssh/http daemon noticed that the gracetimeout expired and can gracefully close the connection",
      "parentUuid": "639fe4e2_e7724d88",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0d8bd4f6_7eb3c92c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 5
      },
      "lineNbr": 18,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2021-06-24T05:52:02Z",
      "side": 1,
      "message": "I indeed meant adding the 30s that were used so far as an additional wait time to the configured timeout value for the reason Matthias mentioned in his last comment.",
      "parentUuid": "fc61a702_85b934f5",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "816abdbf_1641be24",
        "filename": "resources/com/google/gerrit/pgm/init/gerrit.sh",
        "patchSetId": 5
      },
      "lineNbr": 352,
      "author": {
        "id": 1083454
      },
      "writtenOn": "2021-05-31T06:05:47Z",
      "side": 1,
      "message": "nit: this could be moved to a DEFAULT_TIMEOUT variable",
      "range": {
        "startLine": 352,
        "startChar": 91,
        "endLine": 352,
        "endChar": 93
      },
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "77b8c7b0_6d4176e2",
        "filename": "resources/com/google/gerrit/pgm/init/gerrit.sh",
        "patchSetId": 5
      },
      "lineNbr": 352,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-08T21:00:40Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "816abdbf_1641be24",
      "range": {
        "startLine": 352,
        "startChar": 91,
        "endLine": 352,
        "endChar": 93
      },
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1ad84546_2dab6c4a",
        "filename": "resources/com/google/gerrit/pgm/init/gerrit.sh",
        "patchSetId": 5
      },
      "lineNbr": 354,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-05-30T20:43:47Z",
      "side": 1,
      "message": "What\u0027s the purpose of having two separate options for configuring timeout for ssh and http ? It seems a single one would be sufficient since both http and ssh daemon run in the same process.",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c53dd04b_bfd73f45",
        "filename": "resources/com/google/gerrit/pgm/init/gerrit.sh",
        "patchSetId": 5
      },
      "lineNbr": 354,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-06-08T21:02:24Z",
      "side": 1,
      "message": "That is a very good point, nevertheless we have two options at the moment.\nCan you raise this as a separate bug so that we can trace it and fix it on master?\n\nOn stable-3.2 I wouldn\u0027t change the current configuration settings, but on master I am more than happy to review it.",
      "parentUuid": "1ad84546_2dab6c4a",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bbe8be26_805a03e0",
        "filename": "resources/com/google/gerrit/pgm/init/gerrit.sh",
        "patchSetId": 5
      },
      "lineNbr": 354,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-06-09T11:28:27Z",
      "side": 1,
      "message": "I filed\nhttps://bugs.chromium.org/p/gerrit/issues/detail?id\u003d14654\nto track this",
      "parentUuid": "c53dd04b_bfd73f45",
      "revId": "8edae984ac9b984eba0f2c387056eac26dfbe9bc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}