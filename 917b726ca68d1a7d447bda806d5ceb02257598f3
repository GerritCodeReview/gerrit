{
  "comments": [
    {
      "key": {
        "uuid": "3e55ad47_005bd63e",
        "filename": "gerrit-acceptance-tests/src/test/java/com/google/gerrit/acceptance/server/mail/EmailValidatorIT.java",
        "patchSetId": 5
      },
      "lineNbr": 53,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2017-04-26T15:55:13Z",
      "side": 1,
      "message": "How can this work if only the first call to DomainValidator.updateTLDOverride in any JVM invocation has an effect?",
      "revId": "917b726ca68d1a7d447bda806d5ceb02257598f3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7741bde3_c95c912c",
        "filename": "gerrit-acceptance-tests/src/test/java/com/google/gerrit/acceptance/server/mail/EmailValidatorIT.java",
        "patchSetId": 5
      },
      "lineNbr": 53,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2017-04-27T05:48:08Z",
      "side": 1,
      "message": "In the tests it works because the @After method uses reflection to clear DomainValidator\u0027s private \"inUse\" flag, which is what would normally prevent multiple invocations (throwing an IllegalStateException if inUse is set).\n\nIf you mean in a production server running multiple gerrit instances in a single JVM (i.e. googlesource\u0027s multi-tenant setup) then the problem is avoided by not calling updateTLDOVerride at all (by not setting any value for sendemail.allowTLD).  I was wondering if this should be documented, but AFAIK googlesource is the only setup that this would affect, and Patrick said in the earlier comments that it\u0027s OK to just not set allowTLD.\n\nNote that the multiple invocation of updateTldOverride was introduced in the preceding change where OutgoingEmailValidator was made into a Singleton [1].  In that change we avoid problems by catching and ignoring the ISE, which we assume (for the open source version) will only happen during tests.\n\n[1] https://gerrit-review.googlesource.com/?polygerrit\u003d0#/c/95715/15/gerrit-server/src/main/java/com/google/gerrit/server/mail/send/OutgoingEmailValidator.java",
      "parentUuid": "3e55ad47_005bd63e",
      "revId": "917b726ca68d1a7d447bda806d5ceb02257598f3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "847d46d7_aa9e1bbc",
        "filename": "gerrit-acceptance-tests/src/test/java/com/google/gerrit/acceptance/server/mail/EmailValidatorIT.java",
        "patchSetId": 5
      },
      "lineNbr": 53,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2017-04-27T07:27:00Z",
      "side": 1,
      "message": "Ok, now I see how it\u0027s supposed to work. There\u0027s still an issue though.\n\nI think we also need to call resetDomainValidator *before* the first test is run. If you run other tests in one JVM invocation and *then* run EmailValidatorIT, then the first one will fail, because DomainValidator.inUse is still true at the beginning of the method.\n\nYou can reproduce this by right-clicking the acceptance.server.mail package in Eclipse and running all the package tests. The first test method in this class will fail.",
      "parentUuid": "7741bde3_c95c912c",
      "revId": "917b726ca68d1a7d447bda806d5ceb02257598f3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "12c306d6_8843cf78",
        "filename": "gerrit-acceptance-tests/src/test/java/com/google/gerrit/acceptance/server/mail/EmailValidatorIT.java",
        "patchSetId": 5
      },
      "lineNbr": 53,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2017-04-27T07:39:41Z",
      "side": 1,
      "message": "Done in https://gerrit-review.googlesource.com/104810",
      "parentUuid": "847d46d7_aa9e1bbc",
      "revId": "917b726ca68d1a7d447bda806d5ceb02257598f3",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}