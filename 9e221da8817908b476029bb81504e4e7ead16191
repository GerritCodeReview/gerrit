{
  "comments": [
    {
      "key": {
        "uuid": "a53ddda0_0eb90b07",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListLoader.java",
        "patchSetId": 2
      },
      "lineNbr": 90,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2015-10-09T13:23:18Z",
      "side": 1,
      "message": "Shouldn\u0027t this lock be local to the PatchListLoader.load method?\n\nCorrect me if I am wrong but the way it is now, it will prevent to PatchListLoader from computing diff in parallel for 2 different repositories. \n\nMaybe we should synchronize on the repository object?",
      "range": {
        "startLine": 90,
        "startChar": 2,
        "endLine": 90,
        "endChar": 28
      },
      "revId": "9e221da8817908b476029bb81504e4e7ead16191",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ea0a4213_f885d109",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListLoader.java",
        "patchSetId": 2
      },
      "lineNbr": 90,
      "author": {
        "id": 1011123
      },
      "writtenOn": "2015-10-09T13:25:52Z",
      "side": 1,
      "message": "If so, it should be done on stable-2.10.",
      "parentUuid": "a53ddda0_0eb90b07",
      "range": {
        "startLine": 90,
        "startChar": 2,
        "endLine": 90,
        "endChar": 28
      },
      "revId": "9e221da8817908b476029bb81504e4e7ead16191",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6a665238_946b04df",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListLoader.java",
        "patchSetId": 2
      },
      "lineNbr": 90,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2015-10-09T13:49:20Z",
      "side": 1,
      "message": "| Correct me if I am wrong but the way it is now, it will prevent to PatchListLoader from computing diff in parallel for 2 different repositories.\n\nGerrit uses combination of guava cache mit home made H2 persistence backend (open source Gerrit version). For retrieval of values, in case of cache miss, a value loader is used: [1]. The value loader instance is passed to Cache\u0027s get() method: [2]. Check the implementation of PatchListCacheImpl, you can see, that fresh instance of the value loader is created every time (through the factory method) a value for patch list key is retrieved:\n\n  @Override\n  public PatchList get(PatchListKey key, Project.NameKey project)\n      throws PatchListNotAvailableException {\n    try {\n      return fileCache.get(key, fileLoaderFactory.create(key, project));\n    } catch (ExecutionException | LargeObjectException e) {\n      PatchListLoader.log.warn(\"Error computing \" + key, e);\n      throw new PatchListNotAvailableException(e.getCause());\n    }\n  }\n\n* [1] https://code.google.com/p/guava-libraries/wiki/CachesExplained#Population\n* [2] http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/cache/Cache.html#get(K,%20java.util.concurrent.Callable)",
      "parentUuid": "a53ddda0_0eb90b07",
      "range": {
        "startLine": 90,
        "startChar": 2,
        "endLine": 90,
        "endChar": 28
      },
      "revId": "9e221da8817908b476029bb81504e4e7ead16191",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6547653f_6cc0db5d",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListLoader.java",
        "patchSetId": 2
      },
      "lineNbr": 90,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2015-10-09T14:16:05Z",
      "side": 1,
      "message": "Thanks for the detailed answer and for fixing this issue.",
      "parentUuid": "6a665238_946b04df",
      "range": {
        "startLine": 90,
        "startChar": 2,
        "endLine": 90,
        "endChar": 28
      },
      "revId": "9e221da8817908b476029bb81504e4e7ead16191",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3744de87_bec89968",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/patch/PatchListLoader.java",
        "patchSetId": 2
      },
      "lineNbr": 90,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2016-05-18T12:36:14Z",
      "side": 1,
      "message": "better late than never...\n\nThe snippet of code you gave me here to prove that a fresh instance of PatchListLoader is used every time a patch is loaded in the cache is coming from 2.12.\n\nIn gerrit 2.11, a single instance of patchListLoader is used so this change is creating a bottle neck. Only one file header diff can be computed at the time across the entire server.\n\nI am working on a change to fix this.",
      "parentUuid": "6547653f_6cc0db5d",
      "range": {
        "startLine": 90,
        "startChar": 2,
        "endLine": 90,
        "endChar": 28
      },
      "revId": "9e221da8817908b476029bb81504e4e7ead16191",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}