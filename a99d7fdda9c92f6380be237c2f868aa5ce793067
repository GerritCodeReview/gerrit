{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "ebae2649_0dba856a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 15,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-17T09:45:50Z",
      "side": 1,
      "message": "The name doesn\u0027t really tell the whole story: duplicate accounts are always forbidden in Gerrit.\n\nThe point here is if we perform a case-sensitive or case-insensitive match of the account username.",
      "range": {
        "startLine": 15,
        "startChar": 2,
        "endLine": 15,
        "endChar": 27
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0bf19e9b_f6f96b57",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 15,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2021-03-17T12:39:02Z",
      "side": 1,
      "message": "How about `auth.caseInsensitiveAccountCreation`?",
      "parentUuid": "ebae2649_0dba856a",
      "range": {
        "startLine": 15,
        "startChar": 2,
        "endLine": 15,
        "endChar": 27
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d3b2d90f_907ca677",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-17T09:45:50Z",
      "side": 1,
      "message": "I believe this is creating more trouble rather than cleaning up the \"messy situation\" we have with lowercase vs. mixed-case accounts.\n\nI am in favour of resolving the mess and introduce a case-insensitive authentication for accounts, how can we make this less problematic? Why not simply changing the matching logic when resolving the external-id for the \u0027username:\u0027 scheme?",
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f98271f5_15f80605",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2021-03-17T12:39:02Z",
      "side": 1,
      "message": "Our aim with this change was to make sure that no more duplicates will be created, until a solution exists to have case insensitive authentication and a clean and consistent representation of the username / external ID.\nOur idea was (and we will hopefully soon have the promised design doc) that as a first step, we could make authentication case-agnostic, i.e. the user can use any capitalization of the user he/she wants and it will be matched. However, to achieve this, it has to be impossible to create such \"duplicate\" accounts. This would solve the issue without having to change existing data besides of removal of \"duplicate\" accounts. In a next step the repair of the existing accounts can be tackled, i.e. converting all usernames to lowercase and dealing with the user branches.",
      "parentUuid": "d3b2d90f_907ca677",
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "36ad96f9_d7c0000a",
        "filename": "java/com/google/gerrit/server/account/AccountManager.java",
        "patchSetId": 2
      },
      "lineNbr": 151,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-17T09:45:50Z",
      "side": 1,
      "message": "This is the key part: *IF* we perform a case insensitive check then we would need to just look if it exists with any capitalisation.\n\nP.S. I do see an issue here: the account resolver is based on indexes which may or may not be always up to date. Indexes should be used for searching quickly but never used during the authentication process.",
      "range": {
        "startLine": 151,
        "startChar": 16,
        "endLine": 151,
        "endChar": 84
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "97b7516d_89ad2523",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2021-03-17T09:46:13Z",
      "side": 1,
      "message": "Using accountResolver is maybe not a good idea:\n- it is searching over a number of account fields, e.g. it would also find accounts that contain username as part of their fullname\n- it filters out inactive and non-visible accounts\n- it may use the account index,that may contain stale entries\n\nAlso with doing the check here it\u0027s possible that there is a race between requests that create the usernames with different capitalisation and so that both succeed (maybe unlikely to happen but possible).",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ad092dd1_5ace3bb3",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-17T09:56:00Z",
      "side": 1,
      "message": "My comment was somehow related to yours: using the index is a bad idea.\n\nI believe that we need a bit of thinking on how to make a case-insensitive external-id resolution, *without* making use of indexes.",
      "parentUuid": "97b7516d_89ad2523",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "55cff7d5_ecf8400b",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2021-03-17T10:14:42Z",
      "side": 1,
      "message": "Yeah, I saw your comment only afterwards ðŸ˜Š\n\nI somehow like storing all usernames as lowercase only more, as then the storage layer prevents duplicates and races automatically.",
      "parentUuid": "ad092dd1_5ace3bb3",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a8907c53_604b1f52",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2021-03-17T10:17:34Z",
      "side": 1,
      "message": "One wild idea: the storage layer stores external IDs by their SHA1, this means external IDs that have the same SHA1 are duplicates, if usernames that only differ by case would have the same SHA1 they would be detected as duplicates too",
      "parentUuid": "55cff7d5_ecf8400b",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2546c547_4233dc60",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2021-03-17T10:29:18Z",
      "side": 1,
      "message": "\u003e One wild idea: the storage layer stores external IDs by their SHA1, this means external IDs that have the same SHA1 are duplicates, if usernames that only differ by case would have the same SHA1 they would be detected as duplicates too\n\nThat\u0027s a great idea: we just need to amend the way we calculate the SHA1 for it (lowercase first and then SHA1 on it)",
      "parentUuid": "a8907c53_604b1f52",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "38466d17_00a8de1f",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2021-03-17T10:34:34Z",
      "side": 1,
      "message": "Yeah, I think that would be in ExternalId.Key#sha1()",
      "parentUuid": "2546c547_4233dc60",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4c7521e1_c07e48e5",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1065256
      },
      "writtenOn": "2021-03-17T12:39:02Z",
      "side": 1,
      "message": "But this would not work for already existing accounts, would it? Or can they be migrated?\nI agree that the accountResolver is not a good fit. Thanks for explaining the side effects.",
      "parentUuid": "38466d17_00a8de1f",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cce2801b_c172eaa1",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2021-03-17T13:08:43Z",
      "side": 1,
      "message": "Yes, this would require migrating existing external IDs. Doing so is possible, but it definitely would produce churn for all Gerrit admins. This migration is definitely the biggest concern (and why I called it a \"wild idea\").",
      "parentUuid": "4c7521e1_c07e48e5",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "abf8da1f_204c5ed7",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2021-03-17T13:10:20Z",
      "side": 1,
      "message": "Especially the biggest challenge for the migration would be to handle external IDs that will be conflicting now.",
      "parentUuid": "cce2801b_c172eaa1",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2526d45a_87796180",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-03-17T13:10:57Z",
      "side": 1,
      "message": "This sounds like a nice way to implement this constraint.\n\nLooks like this way we could implement case-insensitive but case-preserving behaviour of user names. So a user name could be stored as \"JohnDoe\" but resolve to the same account if written in different case e.g. \"johndoe\". This is similar to how the serviceuser plugin handles user names for the additional metadata it stores in a git config file. The user name is stored as a sub-section name. Git config handles section and key names case-insensitive but case-preserving.\n\nThis approach would require to rewrite all existing keys which were created from user names which aren\u0027t all lower case. It seems ExternalIdNotes.replace() already provides a method which could be used to implement such migration.\n\nIs the key\u0027s sha1 also stored in other places which would need to be migrated as well ?",
      "parentUuid": "4c7521e1_c07e48e5",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "909a85fc_70d97c7d",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1004034
      },
      "writtenOn": "2021-03-17T13:29:31Z",
      "side": 1,
      "message": "I wrote a script [1] which finds the problematic duplicates which need to be cleaned up before we can switch an existing site to case-insensitive user names.\n\nConflicts induced by duplicate user names only differing in case could be cleaned up by\n- deleting all but one of the conflicting accounts\n- renaming user name(s) of the conflicting accounts\n\nOn one of our servers we have no duplicates for the gerrit scheme and a few dozens of duplicates in the username scheme. Most of the duplicates are technical user accounts conflicting with another technical account. A few are conflicts between an account of a human user and a technical user.\n\n[1] https://gerrit-review.googlesource.com/c/gerrit/+/300308",
      "parentUuid": "2526d45a_87796180",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e530d5b9_0494a85d",
        "filename": "java/com/google/gerrit/server/restapi/account/CreateAccount.java",
        "patchSetId": 2
      },
      "lineNbr": 134,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2021-03-17T13:57:16Z",
      "side": 1,
      "message": "\u003e Is the key\u0027s sha1 also stored in other places which would need to be migrated as well ?\n\nNot as far as I remember.\n\n\u003e deleting all but one of the conflicting accounts\n\nDeleting accounts may cause trouble, because account IDs are referenced from NoteDb, but just deleting the conflicting external ID from the account should be fine (and maybe marking the account as inactive).\n\n\u003e Looks like this way we could implement case-insensitive but case-preserving \n\u003e behaviour of user names. \n\nI only wonder if case-insensitivity is wanted for all kind of external IDs, e.g. what about mailto external IDs? IIRC emails are case-sensitive [1]. So you may want to be able to allow emails which only differ by capitalisation to be used by different users (but not sure if Gerrit needs to support this).\n\n[1] https://www.computerhope.com/issues/ch001081.htm#:~:text\u003dYes%2C%20according%20to%20RFC%202821,the%20server%2C%20and%20the%20administrator.",
      "parentUuid": "909a85fc_70d97c7d",
      "range": {
        "startLine": 134,
        "startChar": 36,
        "endLine": 134,
        "endChar": 69
      },
      "revId": "a99d7fdda9c92f6380be237c2f868aa5ce793067",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}