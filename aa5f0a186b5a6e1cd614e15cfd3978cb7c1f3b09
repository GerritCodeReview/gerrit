{
  "comments": [
    {
      "key": {
        "uuid": "bc0410b5_9a1f8d63",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 30,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-01-22T13:27:08Z",
      "side": 1,
      "message": "nit:\n\nFrom: https://stackoverflow.com/questions/1082050/linking-to-an-external-url-in-javadoc\n\n\u003ca href\u003d\"\u003ca href\u003d\"http://google.com\"\u003ehttp://google.com\u003c/a\u003e\"\u003e\u003ca href\u003d\"http://google.com\"\u003ehttp://google.com\u003c/a\u003e\u003c/a\u003e",
      "range": {
        "startLine": 30,
        "startChar": 3,
        "endLine": 30,
        "endChar": 59
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4e6a8328_c6321076",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 30,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2020-01-23T14:46:04Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "bc0410b5_9a1f8d63",
      "range": {
        "startLine": 30,
        "startChar": 3,
        "endLine": 30,
        "endChar": 59
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9d5274c9_24adfce6",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 33,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-01-22T13:27:08Z",
      "side": 1,
      "message": "nit: {@code refs/....}",
      "range": {
        "startLine": 33,
        "startChar": 3,
        "endLine": 33,
        "endChar": 4
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a5a36dfa_e995ae14",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 33,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2020-01-23T14:46:04Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9d5274c9_24adfce6",
      "range": {
        "startLine": 33,
        "startChar": 3,
        "endLine": 33,
        "endChar": 4
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8b0e9792_ba1d8799",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 39,
      "author": {
        "id": 1024147
      },
      "writtenOn": "2020-01-21T13:55:31Z",
      "side": 1,
      "message": "feels a little large. Maybe you can check our internal implementation, I think it has a smaller batch size.",
      "range": {
        "startLine": 39,
        "startChar": 31,
        "endLine": 39,
        "endChar": 36
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e6e1a07f_414a9ed7",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 39,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2020-01-22T12:02:18Z",
      "side": 1,
      "message": "I reduced the number to 100 instead of 10K, although I thought it would be too much logging given that 1 user (you) had ~7K zombie refs (as per your comment in b/142791341). Output anyway will look like this:\n\nFound 550 zombie draft refs in All-Users repo.\nDeleted 100/550 zombie draft refs (0 seconds)\nDeleted 200/550 zombie draft refs (0 seconds)\nDeleted 300/550 zombie draft refs (0 seconds)\nDeleted 400/550 zombie draft refs (0 seconds)\nDeleted 500/550 zombie draft refs (0 seconds)\nDeleted 550/550 zombie draft refs (0 seconds)\n\n\nI also added a new test for large refs cleanup.",
      "parentUuid": "8b0e9792_ba1d8799",
      "range": {
        "startLine": 39,
        "startChar": 31,
        "endLine": 39,
        "endChar": 36
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "11baf53a_de7d5dc9",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 39,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-01-22T13:27:08Z",
      "side": 1,
      "message": "nit: try to avoid abbreviations in names when not absolutely necessary (numX is a counter example to that, but SZ is not that common)",
      "range": {
        "startLine": 39,
        "startChar": 27,
        "endLine": 39,
        "endChar": 28
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5d95cedb_d6a6810a",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 39,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2020-01-23T14:46:04Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "e6e1a07f_414a9ed7",
      "range": {
        "startLine": 39,
        "startChar": 31,
        "endLine": 39,
        "endChar": 36
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "041434ee_a8e7d0da",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 39,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2020-01-23T14:46:04Z",
      "side": 1,
      "message": "I changed it to \"CHUNK_SIZE\". This means that each CHUNK_SIZE refs will be deleted in a single update (not the number of different chunks).\nI also log progress after each chunk is deleted.\nNUM_CHUNKS sounds more likely to be the number of chunks.",
      "parentUuid": "11baf53a_de7d5dc9",
      "range": {
        "startLine": 39,
        "startChar": 27,
        "endLine": 39,
        "endChar": 28
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "60a47fe7_bb933a63",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 63,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-01-22T13:27:08Z",
      "side": 1,
      "message": "Can we make this configurable?\n\nIn the program, we can accept a parameter (for reference, see Passwd). That we can pass into here. The background of my ask is that as an administrator, I\u0027d want to run this for just a single batch first. See how it goes and then continue from there. Deleting many refs at once could be a problem for replication, so admins might want to control this tightly.\n\nChunking up the list is a good idea when using BatchRefUpdate as you did in your new patch set. We could have the user provide a percentage instead as a parameter and process only that percentage.\n\nSo as an administrator, I would try out this program with 1%, increase it to 5%. Percentages are hard when the operation that you perform changes the data set (5% on the second run would be taken from all draft comments that exist at this point, neglecting the 1% that already happened).\n\nAn option to work around this limitation is using modulo on an input identifier as approximation.\n\nSo, the user specifies that they want to clean up 10% of draft comments and you process all zombies where\n\n(changeId % 100) \u003c 10\n\nThe next time around, they want to process 50%, so you process:\n\n(changeId % 100) \u003c 50.\n\nSo admins can run the program by increasing the number 1,5,20,50,100 or linearly as 1,10,20,30,...\n\nThe batch size could be 100 and we stop when we reached the percentage that the admin gave us.",
      "range": {
        "startLine": 63,
        "startChar": 24,
        "endLine": 63,
        "endChar": 41
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5fa99829_afd0f33a",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 63,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2020-01-23T14:46:04Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "60a47fe7_bb933a63",
      "range": {
        "startLine": 63,
        "startChar": 24,
        "endLine": 63,
        "endChar": 41
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "64210255_830eb709",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 73,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-01-22T13:27:08Z",
      "side": 1,
      "message": "\"allDraftRefs\"\n\nInitialize the size of the array list with a fraction of the overall number of drafts that we see as an upper bound on the number of zombies (for example 0.5 * allDraftRefs.size(). That avoids excessive copying.",
      "range": {
        "startLine": 72,
        "startChar": 34,
        "endLine": 73,
        "endChar": 45
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5edabea5_65209156",
        "filename": "java/com/google/gerrit/server/notedb/DeleteZombieCommentsRefs.java",
        "patchSetId": 5
      },
      "lineNbr": 73,
      "author": {
        "id": 1091982
      },
      "writtenOn": "2020-01-23T14:46:04Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "64210255_830eb709",
      "range": {
        "startLine": 72,
        "startChar": 34,
        "endLine": 73,
        "endChar": 45
      },
      "revId": "aa5f0a186b5a6e1cd614e15cfd3978cb7c1f3b09",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}