{
  "comments": [
    {
      "key": {
        "uuid": "f630555a_87a9e5a0",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 53,
      "author": {
        "id": 1086906
      },
      "writtenOn": "2019-10-31T15:49:51Z",
      "side": 1,
      "message": "seems quite a few restrictions here, maybe consider just pass the node name instead ? you can always create the element from it ? `document.createElement(wrapperNodeName)` ?",
      "range": {
        "startLine": 53,
        "startChar": 26,
        "endLine": 53,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fded24fc_d14b435b",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 53,
      "author": {
        "id": 1070860
      },
      "writtenOn": "2019-10-31T17:00:38Z",
      "side": 1,
      "message": "I thought the same, but the issue is that you may want to set attributes such as href on the wrapping anchor. So long as there is only one wrapper element, you could return the new element and let users of the API add the href afterwards, that\u0027s why I asked about the cloning below...",
      "parentUuid": "f630555a_87a9e5a0",
      "range": {
        "startLine": 53,
        "startChar": 26,
        "endLine": 53,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a400a516_524a5e90",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 53,
      "author": {
        "id": 1062212
      },
      "writtenOn": "2019-10-31T19:02:50Z",
      "side": 1,
      "message": "To Tao\u0027s question, we could take in an element name and a dictionary of attribute name-values, and create the element ourselves and put in the attributes.\nThat leaves the question of events, since event listeners don\u0027t go well with cloning (see reason for cloning in Ole\u0027s comment). We could:\n1. Expect clients to add listeners on a parent node (e.g. the lineEl, or gr-diff as a whole).\n2. Take a dictionary of event name-listeners, store it as a property on the node (e.g. __pgListeners), and each time we clone a node, reattach those listeners.\n3. Take a nodeFactory instead of a node, store it with the node, and call it for cloning.",
      "parentUuid": "fded24fc_d14b435b",
      "range": {
        "startLine": 53,
        "startChar": 26,
        "endLine": 53,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ebbf63e6_078c37cb",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 53,
      "author": {
        "id": 1086906
      },
      "writtenOn": "2019-11-06T10:05:43Z",
      "side": 1,
      "message": "I think returning the node or take a nodeFactory seems better and more flexible",
      "parentUuid": "a400a516_524a5e90",
      "range": {
        "startLine": 53,
        "startChar": 26,
        "endLine": 53,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fe1d2bf5_126a44c7",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 53,
      "author": {
        "id": 1062212
      },
      "writtenOn": "2019-11-12T00:12:40Z",
      "side": 1,
      "message": "After thinking a bit more, the best option to me seems to be the following:\n\nfunction annotateWithNode(parent, offset, length, tagName, attributes) {\n  ...\n}\n\nThis has the following advantages:\n- No need to validate the absence of child nodes. Using a factory would require validating the returned element.\n- No risk of event listeners being attached. If a factory is used, the factory can generate new nodes with correct event listeners, *but* we\u0027ll need to validate that each call to the factory returns a new node.\n- No need to add a \u0027private\u0027 property to the element to store its factory.\n- The splitting logic stays the same - element.cloneNode(), followed by splitting of contents.\n- No risk of leaking event listeners/memory. If a factory is used to generate elements, there should be a way to \u0027destroy\u0027 the node such that the caller can perform any cleanup necessary (e.g. removing listeners, cleaning cached references, etc.). This would require a significant refactor, in part because GrAnnotation is completely unaware of the logical concepts of diffs/layers/lines/etc., and so it doesn\u0027t know when a diff line is hidden/re-rendered.\n- Reduces security risk surface since elements will be created by the library, and it can invoke the sanitizer for attributes.",
      "parentUuid": "ebbf63e6_078c37cb",
      "range": {
        "startLine": 53,
        "startChar": 26,
        "endLine": 53,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8f06eb30_2197088a",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 53,
      "author": {
        "id": 1086906
      },
      "writtenOn": "2019-11-12T16:13:07Z",
      "side": 1,
      "message": "k, that sounds reasonable to me. \nOne suggestion if you decide to go with this will be wrap the last two parameters into an Object (with a typedef will be even better), so in case we need more, we don\u0027t necessarily need to add more parameters to this method.\n\nI guess you may need to use `setAttribute` to apply all attributes, then it may have some problems with attributes that associated with functions, like `onclick` etc, not sure what you expect it to do if people actually pass that to it ? i mean technically, this is valid js:\n\n```\nel.setAttribute(\u0027onclick\u0027,\u0027doSomething();\u0027)\n```",
      "parentUuid": "fe1d2bf5_126a44c7",
      "range": {
        "startLine": 53,
        "startChar": 26,
        "endLine": 53,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f42e872e_b1cc7087",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 53,
      "author": {
        "id": 1062212
      },
      "writtenOn": "2019-11-13T03:21:31Z",
      "side": 1,
      "message": "Added a wrapper type.\nRegarding the event attributes, it seems like the sanitizer removes them, so there\u0027s nothing special we need to do there.",
      "parentUuid": "8f06eb30_2197088a",
      "range": {
        "startLine": 53,
        "startChar": 26,
        "endLine": 53,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "71e45e6d_63b1a884",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 56,
      "author": {
        "id": 1070860
      },
      "writtenOn": "2019-10-31T15:32:52Z",
      "side": 1,
      "message": "In which case do you need to clone it?",
      "range": {
        "startLine": 56,
        "startChar": 56,
        "endLine": 56,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a8c0f10b_87c74155",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 56,
      "author": {
        "id": 1062212
      },
      "writtenOn": "2019-10-31T19:02:50Z",
      "side": 1,
      "message": "We\u0027ll need to clone this if/when we need to split this node. This will happen if another annotation needs to split our node. E.g.:\n\nhttps://example.org/i-searched-for-this and this\n------------LINK-----------------------\n                   ----highlight/etc------------",
      "parentUuid": "71e45e6d_63b1a884",
      "range": {
        "startLine": 56,
        "startChar": 56,
        "endLine": 56,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8775e7f6_81a439be",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 56,
      "author": {
        "id": 1086906
      },
      "writtenOn": "2019-11-06T10:05:43Z",
      "side": 1,
      "message": "not sure I follow this example here, which part will be cloned ? for the highlight part, won\u0027t it just split the text node inside of the `a` node and keep the `a` untouched ? will that cancel all the event listeners on a before ?",
      "parentUuid": "a8c0f10b_87c74155",
      "range": {
        "startLine": 56,
        "startChar": 56,
        "endLine": 56,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4278157f_a8fa51b8",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 56,
      "author": {
        "id": 1062212
      },
      "writtenOn": "2019-11-12T00:12:40Z",
      "side": 1,
      "message": "Ah you\u0027re right, highlights won\u0027t split the \u003ca\u003e.\nWhat I should\u0027ve said was: any other node annotation that does not fully contain the \u003ca\u003e will cause the \u003ca\u003e to be split.\nAlthough this is unlikely to happen with \u003ca\u003e, I\u0027m not sure we can count on this never happening once we add the API.",
      "parentUuid": "8775e7f6_81a439be",
      "range": {
        "startLine": 56,
        "startChar": 56,
        "endLine": 56,
        "endChar": 71
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "75c3b5dd_c31fadd6",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 58,
      "author": {
        "id": 1086906
      },
      "writtenOn": "2019-10-31T15:49:51Z",
      "side": 1,
      "message": "just curious, is this method added for future uses ? what are the use cases ?",
      "range": {
        "startLine": 58,
        "startChar": 4,
        "endLine": 58,
        "endChar": 20
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ba40e24f_0607db61",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 58,
      "author": {
        "id": 1070860
      },
      "writtenOn": "2019-10-31T17:00:38Z",
      "side": 1,
      "message": "This is for adding links, like when a comment contains a URL. It might also come in handy for cross references.",
      "parentUuid": "75c3b5dd_c31fadd6",
      "range": {
        "startLine": 58,
        "startChar": 4,
        "endLine": 58,
        "endChar": 20
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "636ef8ab_5756facd",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 58,
      "author": {
        "id": 1062212
      },
      "writtenOn": "2019-10-31T19:02:50Z",
      "side": 1,
      "message": "As Ole said, currently this is for links, but might aid in non-navigation use cases as well. E.g., while it\u0027s technically possible to do hovercards with class annotations, they might become easier if custom elements can be added.",
      "parentUuid": "ba40e24f_0607db61",
      "range": {
        "startLine": 58,
        "startChar": 4,
        "endLine": 58,
        "endChar": 20
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a9387a84_8a6c0cbe",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 58,
      "author": {
        "id": 1086906
      },
      "writtenOn": "2019-11-06T10:05:43Z",
      "side": 1,
      "message": "thanks! A few test cases will make it more obvious :)",
      "parentUuid": "636ef8ab_5756facd",
      "range": {
        "startLine": 58,
        "startChar": 4,
        "endLine": 58,
        "endChar": 20
      },
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6aeaa48b_4d2e6847",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 91,
      "author": {
        "id": 1086906
      },
      "writtenOn": "2019-10-31T15:49:51Z",
      "side": 1,
      "message": "maybe add some tests for this new method as well ?",
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ad643255_20547192",
        "filename": "polygerrit-ui/app/elements/diff/gr-diff-highlight/gr-annotation.js",
        "patchSetId": 2
      },
      "lineNbr": 91,
      "author": {
        "id": 1062212
      },
      "writtenOn": "2019-11-12T00:12:40Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6aeaa48b_4d2e6847",
      "revId": "abd1040b46cbed65e9371b2d07133df127f01614",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}