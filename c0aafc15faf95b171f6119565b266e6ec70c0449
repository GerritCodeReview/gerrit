{
  "comments": [
    {
      "key": {
        "uuid": "3d177732_2100fbed",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 190,
      "author": {
        "id": 1047383
      },
      "writtenOn": "2019-03-07T14:04:50Z",
      "side": 1,
      "message": "\"Number of changes of each type (create, replace, autoclose) uploaded in a single push. If a push has changes of multiple types, multiple events will be added to the histogram (one for each type).\"\n\n\u003c--- which also shows that we don\u0027t have a metric which tracks the number of changes in a push regardless of type. Despite the loss of information, WDYT about joining CREATE and REPLACE in this metric to make it more comparable to receivecommits/latency?",
      "range": {
        "startLine": 190,
        "startChar": 31,
        "endLine": 190,
        "endChar": 75
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4deabc54_e71e71b8",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 190,
      "author": {
        "id": 1024147
      },
      "writtenOn": "2019-03-07T18:06:47Z",
      "side": 1,
      "message": "I thought you got the number easily by specifying (type\u003d\u003dA||type\u003d\u003dB).\n\nBut I\u0027m fine with whatever you want.",
      "parentUuid": "3d177732_2100fbed",
      "range": {
        "startLine": 190,
        "startChar": 31,
        "endLine": 190,
        "endChar": 75
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "06d4eaf3_90c85450",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 190,
      "author": {
        "id": 1047383
      },
      "writtenOn": "2019-03-13T15:07:21Z",
      "side": 1,
      "message": "\u003e I thought you got the number easily by specifying (type\u003d\u003dA||type\u003d\u003dB).\n\nSadly, no. Distributions/histograms work differently. Suppose that a single push contains 3 CREATE (A) and 2 REPLACE (B) operations. In the split case:\n\n  .add(A, 3)\n  .add(B, 2)\n\nIf you select the mean of this distribution while having the filter type\u003d\u003dA||type\u003d\u003dB, you get:\n\n  DistributionMean\u003d(3+2)/2\u003d2.5\n\nConversely, in the joined case:\n\n  .add(A_and_B, 5)\n\nAnd the mean:\n\n  DistributionMean\u003d5",
      "parentUuid": "4deabc54_e71e71b8",
      "range": {
        "startLine": 190,
        "startChar": 31,
        "endLine": 190,
        "endChar": 75
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9c12dabf_7d036ad1",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 190,
      "author": {
        "id": 1024147
      },
      "writtenOn": "2019-03-13T15:20:43Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "06d4eaf3_90c85450",
      "range": {
        "startLine": 190,
        "startChar": 31,
        "endLine": 190,
        "endChar": 75
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "283d5ca7_223c6d54",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 197,
      "author": {
        "id": 1047383
      },
      "writtenOn": "2019-03-07T14:04:50Z",
      "side": 1,
      "message": "This is OK. What sounds even clearer to me is:\n\n  Processing delay per push divided by the number of changes in said push. (Only includes pushes which contain changes.)",
      "range": {
        "startLine": 197,
        "startChar": 50,
        "endLine": 197,
        "endChar": 74
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1896aa06_b83c40bc",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 197,
      "author": {
        "id": 1024147
      },
      "writtenOn": "2019-03-07T18:06:47Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "283d5ca7_223c6d54",
      "range": {
        "startLine": 197,
        "startChar": 50,
        "endLine": 197,
        "endChar": 74
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a49a4e66_10068ad1",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 370,
      "author": {
        "id": 1047383
      },
      "writtenOn": "2019-03-07T14:04:50Z",
      "side": 1,
      "message": "Is it legal for a push to be both `isMagicPush()` and `totalChanges \u003d\u003d 0`? Would it end up here?",
      "range": {
        "startLine": 368,
        "startChar": 0,
        "endLine": 370,
        "endChar": 5
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2c2d6276_e4991a00",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 370,
      "author": {
        "id": 1024147
      },
      "writtenOn": "2019-03-07T18:06:47Z",
      "side": 1,
      "message": "yes, that is possilbe:\n\n$ git push origin HEAD:refs/for/master\nEnumerating objects: 23, done.\nCounting objects: 100% (23/23), done.\nDelta compression using up to 12 threads\nCompressing objects: 100% (10/10), done.\nWriting objects: 100% (12/12), 1.41 KiB | 1.41 MiB/s, done.\nTotal 12 (delta 9), reused 0 (delta 0)\nremote: Resolving deltas: 100% (9/9)\nremote: Waiting for 2/2\nremote: Processing changes: refs: 1, done    \nTo https://gerrit.googlesource.com/gerrit\n ! [remote rejected]       HEAD -\u003e refs/for/master (no new changes)",
      "parentUuid": "a49a4e66_10068ad1",
      "range": {
        "startLine": 368,
        "startChar": 0,
        "endLine": 370,
        "endChar": 5
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7de959e2_868e3fb3",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 370,
      "author": {
        "id": 1047383
      },
      "writtenOn": "2019-03-13T15:07:21Z",
      "side": 1,
      "message": "So that would be `pushType \u003d \"NORMAL\"`. And it would be an error.\n\nIf it\u0027s an error, does it end up in these metrics?",
      "parentUuid": "2c2d6276_e4991a00",
      "range": {
        "startLine": 368,
        "startChar": 0,
        "endLine": 370,
        "endChar": 5
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a889af79_81dd175c",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 370,
      "author": {
        "id": 1024147
      },
      "writtenOn": "2019-03-13T15:20:18Z",
      "side": 1,
      "message": "if the destination is refs/for/XXX it is a magic push, so it is a CREATE_REPLACE pushType.\n\nWe don\u0027t consider it an error. It\u0027s just something that is effectively a NOP. Just as doing a fetch where you\u0027re up to date.\n\nthe effect would be to take decrease the average for changes processed in a push. I think we should still treat in the CREATE_REPLACE case, because we need to do administrative processing to verify that nothing changed.",
      "parentUuid": "7de959e2_868e3fb3",
      "range": {
        "startLine": 368,
        "startChar": 0,
        "endLine": 370,
        "endChar": 5
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "25f6ed7b_ff9ad4c7",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 370,
      "author": {
        "id": 1047383
      },
      "writtenOn": "2019-03-13T15:59:22Z",
      "side": 1,
      "message": "\u003e if the destination is refs/for/XXX it is a magic push, so it is a CREATE_REPLACE pushType.\n\nRight. Human code emulation failure.\n\n\u003e We don\u0027t consider it an error. It\u0027s just something that is effectively a NOP. Just as doing a fetch where you\u0027re up to date.\n\u003e \n\u003e the effect would be to take decrease the average for changes processed in a push. I think we should still treat in the CREATE_REPLACE case, because we need to do administrative processing to verify that nothing changed.\n\nI understand.\n\nSomething tells me that automated users, or users with scripts running in the background or people who forget the state of the remote branch are doing this often enough that it could impact the latencyPerPush metric. (I checked our metrics and the vast majority of REPLACE samples for the changes metric are in the bucket [0..1), meaning 0 changes.)\n\nMaybe it will be different once this change is submitted and we see CREATE_REPLACE together. Let\u0027s study the data and course adjust if necessary.\n\nOn a related note: the default bucketing schema (exponential) doesn\u0027t work well for the \"changes\" metric. Can we change that so it has the following buckets:\n\n [0,1)\n [1,2)\n [2,3)\n [3,4)\n [4,5)\n [5,6)\n [6,7)\n [7,8)\n [8,9)\n [9,10)\n [10,20)\n [20,30)\n [90,100)\n [100,+inf)\n\nThat would be both cheaper to store than the default and more useful for this set of data.",
      "parentUuid": "a889af79_81dd175c",
      "range": {
        "startLine": 368,
        "startChar": 0,
        "endLine": 370,
        "endChar": 5
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "494723ac_600fa637",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 373,
      "author": {
        "id": 1047383
      },
      "writtenOn": "2019-03-07T14:04:50Z",
      "side": 1,
      "message": "Suggestion: personally, I would postfix-comment each of the types as such:\n\n pushType \u003d \"CREATE_REPLACE\"; // A push with new and/or updated changes.\n pushType \u003d ResultChangeIds.Key.AUTOCLOSED.name();\n pushType \u003d \"NORMAL\"; // No changes in the push (regular git push).",
      "range": {
        "startLine": 373,
        "startChar": 6,
        "endLine": 373,
        "endChar": 26
      },
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c901db32_7413cd9b",
        "filename": "java/com/google/gerrit/server/git/receive/AsyncReceiveCommits.java",
        "patchSetId": 3
      },
      "lineNbr": 373,
      "author": {
        "id": 1024147
      },
      "writtenOn": "2019-03-07T18:06:47Z",
      "side": 1,
      "message": "I\u0027ll keep it like this.",
      "parentUuid": "494723ac_600fa637",
      "range": {
        "startLine": 373,
        "startChar": 6,
        "endLine": 373,
        "endChar": 26
      },
      "tag": "autogenerated:gerrit:newPatchSet",
      "revId": "c0aafc15faf95b171f6119565b266e6ec70c0449",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}