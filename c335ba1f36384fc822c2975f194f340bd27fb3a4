{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "8e2b1090_d7f4191e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1142970
      },
      "writtenOn": "2021-11-22T16:41:11Z",
      "side": 1,
      "message": "debug log: https://gist.github.com/andersbjht/d1e00a34a068bf896836bfb8bf33fa9e",
      "revId": "c335ba1f36384fc822c2975f194f340bd27fb3a4",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "566f5a01_720eb530",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1100310
      },
      "writtenOn": "2021-11-22T17:24:20Z",
      "side": 1,
      "message": "This is very strange (from your log):\n\n  send SSH_MSG_USERAUTH_PK_OK for key type\u003dsk-ecdsa-sha2-nistp256@openssh.com, fingerprint\u003dBufferException\n  \nThe fingerprint is certainly not \"BufferException\". Unfortunately Apache MINA sshd swallows the exception... :-( It most likely comes from [1], where there are two possibilities: unknown EC curve, or the putRawPublicKeyBytes() method cannot handle that sk-* key at all.\n\nIf you can give me that public key, I can try to do a little unit test for Apache MINA sshd to see what its problem with that key is. To me it looks as if something goes wrong with that authentication attempt, and the session is actually not authenticated.\n\n[1] https://github.com/apache/mina-sshd/blob/c7d83d0f/sshd-common/src/main/java/org/apache/sshd/common/util/buffer/Buffer.java#L965",
      "parentUuid": "8e2b1090_d7f4191e",
      "revId": "c335ba1f36384fc822c2975f194f340bd27fb3a4",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "137b6d3a_e32fd7c1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1100310
      },
      "writtenOn": "2021-11-22T17:55:56Z",
      "side": 1,
      "message": "Also, it looks as if that attempt 2/6 doesn\u0027t send a signature. It\u0027s the (optional) up-front check whether the server would accept the key. See RFC 4252, section 7.[1]\n\nIn light of this I just do not understand how that DatabasePubKeyAuth works. It appears to set a user on the session before even the signature is validated? (In line 164?) And on the second lookup (3/6 in your log) from the next SSH_MSG_USERAUTH_REQUEST (which is *expected*) it then fails because a user is already set? That looks fundamentally wrong.\n\nPublicKeyAuthenticator.authenticate() does not do the whole authentication. It cannot, because it doesn\u0027t have the signature. It only tells whether a particular username/key combination allows log-in at all. If not: game over. But if yes, then the framework additionally validates the signature sent in the request, and only if that check also passes the user is authenticated.\n\n[1] https://datatracker.ietf.org/doc/html/rfc4252#section-7",
      "parentUuid": "566f5a01_720eb530",
      "revId": "c335ba1f36384fc822c2975f194f340bd27fb3a4",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1d385ba3_a6109d1a",
        "filename": "java/com/google/gerrit/sshd/DatabasePubKeyAuth.java",
        "patchSetId": 1
      },
      "lineNbr": 115,
      "author": {
        "id": 1100310
      },
      "writtenOn": "2021-11-22T16:14:39Z",
      "side": 1,
      "message": "Why is this needed? As far as I see, the Apache MINA sshd framework should do this already in ServerUserAuthService[1], long before this code here is reached.\n\n[1] https://github.com/apache/mina-sshd/blob/c7d83d0f/sshd-core/src/main/java/org/apache/sshd/server/session/ServerUserAuthService.java#L210",
      "revId": "c335ba1f36384fc822c2975f194f340bd27fb3a4",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "85ece5c9_4de45214",
        "filename": "java/com/google/gerrit/sshd/DatabasePubKeyAuth.java",
        "patchSetId": 1
      },
      "lineNbr": 115,
      "author": {
        "id": 1142970
      },
      "writtenOn": "2021-11-22T16:36:42Z",
      "side": 1,
      "message": "As far as I can tell, the code is called twice (while it is still processing).\nI thought it was the touch interaction first, but same thing without it...",
      "parentUuid": "1d385ba3_a6109d1a",
      "revId": "c335ba1f36384fc822c2975f194f340bd27fb3a4",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}