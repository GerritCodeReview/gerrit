{
  "pushCert": "certificate version 0.1\npusher Dave Borowitz \u003cdborowitz@google.com\u003e 1544220437 -0800\nnonce AGLkUnCAHzgkzddyTLdvM+xj5Bis5FFwug2363+z9rxjKTLmQE2akCJ8sn3JgVP9JMyJAFpkZ9PY\n\n0000000000000000000000000000000000000000 d268796766e0f2c042cede62b4f8f582b95f8d7e refs/for/master\n-----BEGIN PGP SIGNATURE-----\n\niQJJBAABCgAzFiEEpPm/sOxWgSqG5grhX9fFmpoSiIwFAlwK7xUVHGRib3Jvd2l0\nekBnb29nbGUuY29tAAoJEF/XxZqaEoiMfrQQAM5gF96AJbadCohGlXAnUiHq+uNd\nPqADyCzanGcMWCtjtQmtIAwp7gRVOkuUDMhNeLAf/umVB9B6ug2f7jBuuhZ2aVo6\nwSuYLjl+2Hfhjva72OhV3gkTnzgIdnvwpz2fW0JQ85ZiIgSDI0j6+q4FwHISrAuo\nEG6fxKeKVG1DzhLRKlvPC2YLLkrfkByPf3cUlsRmokxD+whdZin7iT6JsebJcFX5\nlktsETVwBTV0T1hWGYbk6P6DGYutrjW94XcWDVzX7DVmarVzqNhhihMnQzGlvxQ9\ntpsPJrr90C4KNBy8ldFJXdF8GFkgsuqDofOKqC3fyZSr3dDDO1Z8u8hOOW2LvJY4\nocq9a5wzvN+I0IGPSTeSuSm0m3tpovvQKmfUEpLt+tUspOP1UMEr3Y9AHXWZ0356\n0TfZOdrzSvfYFdwl3e4pPKr/Uyq1HcOxGOExjnnj66Jf4WU5jzcNGRTCkS7sBAfz\ncnxDjprgACISGe4LQGemzuZl5Zu+8Lyjxxde/d+MLBtXi1XgDuYqOaZXuESUVHml\nQ9qsL+Pn6V1pOfKpux1YUKMKMcIdO54fto2MciGQ1fzgOlLB28TeGB+WbrDoOaKi\nVQMHL7NA0lzsCTZTJDlQ1M8dU8A6AQP+qGZxNp+AymxOfuSFL81C0hyQzds4KSAj\ni+y83/3LQnym0HYu\n\u003dI1EG\n-----END PGP SIGNATURE-----\n",
  "comments": [
    {
      "key": {
        "uuid": "3bae3dc5_38c65c4c",
        "filename": "java/com/google/gerrit/pgm/init/BaseInit.java",
        "patchSetId": 8
      },
      "lineNbr": 377,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-07T23:02:34Z",
      "side": 1,
      "message": "This is probably wrong to unconditionally create schema. In ReviewDb context, the call to:\n\n  noteDbSchemaUpdater.update(uiImpl);\n\nwas delegated to either updater or creator, depending on whether or version was existing or not:\n\n   public void update(UpdateUI ui) throws OrmException {\n      try (ReviewDb db \u003d ReviewDbUtil.unwrapDb(schema.open())) {\n  \n        final ReviewDbSchemaVersion u \u003d updater.get();\n        final CurrentSchemaVersion version \u003d getSchemaVersion(db);\n        if (version \u003d\u003d null) {\n          try {\n            creator.create(db);\n          } catch (IOException | ConfigInvalidException e) {\n            throw new OrmException(\"Cannot initialize schema\", e);\n          }\n  \n        } else {\n          try {\n            u.check(ui, version, db);\n          } catch (SQLException e) {\n            throw new OrmException(\"Cannot upgrade schema\", e);\n          }\n        }\n      }\n    }",
      "range": {
        "startLine": 373,
        "startChar": 6,
        "endLine": 377,
        "endChar": 7
      },
      "revId": "d268796766e0f2c042cede62b4f8f582b95f8d7e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "926da118_2d6a2d33",
        "filename": "java/com/google/gerrit/pgm/init/BaseInit.java",
        "patchSetId": 8
      },
      "lineNbr": 377,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2018-12-07T23:08:15Z",
      "side": 1,
      "message": "Yep, this is the cause of most of the remaining test failures. This change is still WIP but I\u0027m almost ready :)",
      "parentUuid": "3bae3dc5_38c65c4c",
      "range": {
        "startLine": 373,
        "startChar": 6,
        "endLine": 377,
        "endChar": 7
      },
      "revId": "d268796766e0f2c042cede62b4f8f582b95f8d7e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e5929089_0f1efc6d",
        "filename": "java/com/google/gerrit/pgm/init/BaseInit.java",
        "patchSetId": 8
      },
      "lineNbr": 377,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-07T23:22:52Z",
      "side": 1,
      "message": "I have an idea, how to address that, see my comment below. I guess you have a similar idea? ;-)",
      "parentUuid": "926da118_2d6a2d33",
      "range": {
        "startLine": 373,
        "startChar": 6,
        "endLine": 377,
        "endChar": 7
      },
      "revId": "d268796766e0f2c042cede62b4f8f582b95f8d7e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "96adc9f0_6867718d",
        "filename": "java/com/google/gerrit/pgm/init/BaseInit.java",
        "patchSetId": 8
      },
      "lineNbr": 403,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-12-07T23:22:52Z",
      "side": 1,
      "message": "One idea is to guess whether or not a site already exist and run updater.update() and if not run creator.create().\n\nThere is one complication: If refs/meta/version doesn\u0027t exist, there are two possibilities:\n\n* 1. We have a new site\n* 2. We are migrating from 2.16 to 3.0\n\nLuckily, we can differentiate whether or not All-Projects exists or not. So remove the unconditional cal to schemaCreator.create(); on line 374 above, and do here something like this instead:\n\n  try {\n        versionManager.read();\n        noteDbSchemaUpdater.update(uiImpl);\n      } catch (OrmException ignore) {\n        // No All-Projects: we are on new site, run schema creator\n        try {\n          schemaCreator.create();\n        } catch (IOException | ConfigInvalidException e) {\n          throw new OrmException(\"Cannot init gerrit site\", e);\n        }\n      }",
      "range": {
        "startLine": 403,
        "startChar": 6,
        "endLine": 403,
        "endChar": 41
      },
      "revId": "d268796766e0f2c042cede62b4f8f582b95f8d7e",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}