{
  "pushCert": "certificate version 0.1\npusher A0D0EF51 1498135019 +0200\nnonce AH5c86B11zlihHFAb8RGjraUYrQee9IB+gLfeKe9qClH/XagHoNU3j3frUGBDSlxqolAYyi1Ly6n\n\n0000000000000000000000000000000000000000 8627eb888672b97dd3b79aef7f86f528f441db64 refs/for/master\n-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v1\n\niQEcBAABAgAGBQJZS7nrAAoJEFG1/Zeg0O9RU6AIAKHCX+dwB9S3ylp2Bb9G9nRB\ndmrki6Krw06WawG/cBWED3lsCEgzQ/JEifZ33ssoPhOWlY1n++heCJbe03VKeDkY\nNW8qPt2qFU/c01H6eZ3ftswIIwlMoFXDVon7x6G9BTy+2Rk58F7eUSwsbIXE80tT\nuwnEF6vd4oC9y+8/NUww4JwEiOIEODCIRTJIL1pG92CVI7UkQM/FxZhAzA/HfWgA\n/830+u8+1+lgGO6WivuJnCf/6Ou5oMGqgG8xjCvUHiMy9vCXd9CKwVQu9CfbyY2C\noWdw98N1dfbnlaBSoplhT+I9b37XS0gb7wUT9VSefx9nr9wBIChm1LjJoW0Q97w\u003d\n\u003dVxr6\n-----END PGP SIGNATURE-----\n",
  "comments": [
    {
      "key": {
        "uuid": "ca5e5bb8_9d9dd577",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 711,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2017-06-22T13:02:36Z",
      "side": 1,
      "message": "Is this true? We don\u0027t allow them on change meta refs because we depend on parsing commit messages in order, but that issue doesn\u0027t apply to accounts.",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e4184dfe_7ab43b8a",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 711,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-06-22T13:07:53Z",
      "side": 1,
      "message": "Hmm, if there are several parents, how would we know which parent represents the old account state? So that we can verify it wasn\u0027t modified by the new commit?",
      "parentUuid": "ca5e5bb8_9d9dd577",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ab56985d_b1fad6b4",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 711,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2017-06-22T13:38:52Z",
      "side": 1,
      "message": "ISTM you should be comparing against the current tip of the branch, not against a parent of the tip of the push. In theory the user could push multiple commits, tip \u003c- A \u003c- B, where A is a different state, but B reverts it back to the state at the tip. This is arguably valid, because the account hasn\u0027t changed, and we don\u0027t generally care about the old history.\n\nI guess I could also see the argument that you only want to allow pushing one commit at a time, but in that case you would want to check that there is only one parent and it equals the tip.",
      "parentUuid": "e4184dfe_7ab43b8a",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a1c50402_688f6445",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 711,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-06-22T14:11:35Z",
      "side": 1,
      "message": "If multiple commits are pushed this validator is invoked multiple times, once for each of the new commits. However in between the branch is not updated.\n\nI think I found another reason why comparing against the parent is wrong. If this is a force push of a commit which is based on an older commit in the history it can overwrite the current HEAD and hence undo account modifications that have been done:\n\n  C  D \u003c-- HEAD of the user branch\n  | /\n  |/\n  B\n  |\n  |\n  A\n\n\nIf D was created by Gerrit, e.g. because the user changed its account status through a REST endpoint, then the status differs between B and D. If C has the same account state as B and is force pushed, then comparing C against its parent B would show no modification and we would allow the commit. But this undos the modifications from D.\n\nSo I will change the code to do the check against the current HEAD, but also this is not 100% safe, as the current HEAD can be changed by a racing request, and then a force push could still overwrite these modifications. But that\u0027s quite unlikely especially since we don\u0027t expect many pushes to the user branches.",
      "parentUuid": "ab56985d_b1fad6b4",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "be3d9c98_cf713b09",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 711,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-06-22T14:16:18Z",
      "side": 1,
      "message": "Ah, actually I think I can get the old SHA1 by receiveEvent.command.getOldId()",
      "parentUuid": "a1c50402_688f6445",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a476d066_7aabfd92",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 711,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-06-22T14:57:16Z",
      "side": 1,
      "message": "receiveEvent.command.getOldId() only works for direct pushes, when pushing for code review receiveEvent.command is a CreateCommand with the zero ID as old ID. This is fine, but it means we should prevent submitting changes to user branches which modify the account.config file. The only way for this is implementing a MergeValidationListener, but this doesn\u0027t provide us the old ID *sigh*\n\nNot sure how to solve this. Maybe nobody would notice if we disable submitting changes to user branches until we are done with migrating accounts to NoteDb?",
      "parentUuid": "be3d9c98_cf713b09",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "77542403_9556f94c",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 722,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2017-06-22T13:02:36Z",
      "side": 1,
      "message": "Can\u0027t you just compare the blob SHA-1s (from a TreeWalk.forPath or whatever) rather than reading the bytes?",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1201590f_934709be",
        "filename": "gerrit-server/src/main/java/com/google/gerrit/server/git/validators/CommitValidators.java",
        "patchSetId": 1
      },
      "lineNbr": 722,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-06-22T13:24:21Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "77542403_9556f94c",
      "revId": "d4af5ad1727fdc2a5bb0e5266e1983d005e35209",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}