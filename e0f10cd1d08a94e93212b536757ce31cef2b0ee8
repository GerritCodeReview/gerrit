{
  "comments": [
    {
      "key": {
        "uuid": "2f3008cd_87ade6a0",
        "filename": "lib/lucene/BUILD",
        "patchSetId": 14
      },
      "lineNbr": 9,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2016-06-12T20:18:53Z",
      "side": 1,
      "message": "We have to create java_binary targets to access the whole content of the JARs from the command line (to merge maven files with help of merge_jars.py)? If I\u0027m trying to do the same with java_library, the only content I get is META-INF/MANIFEST.MF file:\n\n  $ bazel build //lib/lucene:backward-codecs_jar\n  bazel-bin/lib/lucene/libbackward-codecs_jar.jar\n\nBut\n\n  $ unzip -t bazel-bin/lib/lucene/libbackward-codecs_jar.jar\n  Archive:  bazel-bin/lib/lucene/libbackward-codecs_jar.jar\n    testing: META-INF/                OK\n    testing: META-INF/MANIFEST.MF     OK\n\nThis raises the question, how to gather the WAR archive with regular java_library targets? For example current pack_war.py file is getting \"$(classpath :foo)\" as the needed input JARs for some target :foo and then access all transitive dependencies from :foo as regular java_libary target (and _not_ java_binary) to construct the gerrit.war file, by linking the actual output java libraries on the file system to some temporary direcory. After the linking the WAR archive is created.\n\nComapring with the backward-codecs_jar output library in Buck tool chain, we get:\n\n  $ buck build --deep //lib/lucene:backward-codecs_jar\n  $ buck targets --show_output //lib/lucene:backward-codecs_jar | awk \u0027{print $2}\u0027\n  [-] PARSING BUCK FILES...FINISHED 0.0s\n  buck-out/gen/lib/lucene/backward-codecs_jar.jar\n\nAnd\n\n  $ unzip -t buck-out/gen/lib/lucene/backward-codecs_jar.jar\n\nproduces this output: [1].\n\n* [1] http://paste.openstack.org/show/510959",
      "range": {
        "startLine": 8,
        "startChar": 4,
        "endLine": 9,
        "endChar": 37
      },
      "revId": "e0f10cd1d08a94e93212b536757ce31cef2b0ee8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2f3008cd_87224605",
        "filename": "lib/lucene/BUILD",
        "patchSetId": 14
      },
      "lineNbr": 9,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2016-06-13T05:43:26Z",
      "side": 1,
      "message": "Never mind. I compared apples and oranges here: prebuilt_jar() (that corresponds to java_library() in Bazel) in Buck with java_library() with exports only in Bazel.\n\nHowever, the answer to my question to package WAR archive and being able to specify every single (Maven Artifact) dependency in its own file (with the content) requires to specify all Maven artifacts as java_binary() and not java_library() rules.\n\nTo better understand what I\u0027m trying to say, I patched pack_war.py file: [1] and here is the output of `buck build --deep gerrit` command: [2].\n\n* [1] http://paste.openstack.org/show/512549\n* [2] http://paste.openstack.org/show/512550",
      "parentUuid": "2f3008cd_87ade6a0",
      "range": {
        "startLine": 8,
        "startChar": 4,
        "endLine": 9,
        "endChar": 37
      },
      "revId": "e0f10cd1d08a94e93212b536757ce31cef2b0ee8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0f27c499_86fb2a85",
        "filename": "lib/lucene/BUILD",
        "patchSetId": 14
      },
      "lineNbr": 9,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2016-06-13T05:46:29Z",
      "side": 1,
      "message": "Opps, the statement:\n\n  \"[...] prebuilt_jar() (that corresponds to java_library() in Bazel)\"\n\nis wrong, it should be:\n\n  \"[...] prebuilt_jar() (that corresponds to java_binary() in Bazel)\"",
      "parentUuid": "2f3008cd_87224605",
      "range": {
        "startLine": 8,
        "startChar": 4,
        "endLine": 9,
        "endChar": 37
      },
      "revId": "e0f10cd1d08a94e93212b536757ce31cef2b0ee8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0f27c499_c6f5228f",
        "filename": "lib/lucene/BUILD",
        "patchSetId": 14
      },
      "lineNbr": 9,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2016-06-13T06:40:02Z",
      "side": 1,
      "message": "Well, \"All good things come in threes\" :)\n\n  \"[...] prebuilt_jar() (that corresponds to java_library() in Bazel)\"\n\nis wrong, it should be:\n\n  \"[...] prebuilt_jar() (that corresponds to java_import() in Bazel)\"\n\nHowever, when I\u0027m trying to java_import a rule that depends on maven_jar, I\u0027m getting this error:\n\n  java_import(\n    name \u003d \u0027java_runtime\u0027,\n    jars \u003d [\u0027@java_runtime//jar\u0027],\n    visibility \u003d [\u0027//visibility:public\u0027],\n  )\n  ERROR: /home/davido/projects/gerrit/lib/antlr/BUILD:12:10: \\\n  in jars attribute of java_import rule \\\n  //lib/antlr:java_runtime: should not refer to Java rules.\n\nHowever, java_binary is not allowed as deps for java_library:\n\n  java_binary(\n    name \u003d \u0027java_runtime\u0027,\n    main_class \u003d \u0027Dummy\u0027,\n    runtime_deps \u003d [\u0027:java_runtime__library\u0027],\n    visibility \u003d [\u0027//visibility:public\u0027],\n  )\n  java_library(\n    name \u003d \u0027java_runtime__library\u0027,\n    exports \u003d [\u0027@java_runtime//jar\u0027],\n  )\n\nWith this error:\n\n  $ bazel build gerrit-server:server\n  ERROR: /home/davido/projects/gerrit/lib/antlr/BUILD:32:18: \\\n  in runtime_deps attribute of java_library rule \\\n  //lib/antlr:tool: java_binary rule \\\n  \u0027//lib/antlr:java_runtime\u0027 is misplaced here (expected \\\n  cc_binary, cc_library, genrule, genproto, java_import, \\\n  java_library, proto_library, sh_binary or sh_library).\n\n\nThis means, that for each artifact :foo that we need to pass as dependency to some java_library rule and that we need to access with the whole content from the command line (to gather WAR archive) we have to define:\n\n  * 1. java_library(name \u003d \u0027foo_library\u0027, ...\n  * 2. java_binary(name \u003d \u0027foo_binary\u0027, ...",
      "parentUuid": "0f27c499_86fb2a85",
      "range": {
        "startLine": 8,
        "startChar": 4,
        "endLine": 9,
        "endChar": 37
      },
      "revId": "e0f10cd1d08a94e93212b536757ce31cef2b0ee8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7401f93c_d1a0e4a9",
        "filename": "lib/lucene/BUILD",
        "patchSetId": 14
      },
      "lineNbr": 9,
      "author": {
        "id": 1025087
      },
      "writtenOn": "2016-06-14T09:06:13Z",
      "side": 1,
      "message": "Why do you need java_runtime to be a java_binary?",
      "parentUuid": "0f27c499_c6f5228f",
      "range": {
        "startLine": 8,
        "startChar": 4,
        "endLine": 9,
        "endChar": 37
      },
      "revId": "e0f10cd1d08a94e93212b536757ce31cef2b0ee8",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}