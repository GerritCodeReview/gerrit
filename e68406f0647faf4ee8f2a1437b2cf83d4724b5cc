{
  "comments": [
    {
      "key": {
        "uuid": "2d30466b_f887048d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2018-01-18T17:55:47Z",
      "side": 1,
      "message": "Do you have links to some of these issues?",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 24,
        "endChar": 12
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "de98f497_3e9b1890",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-01-18T18:11:48Z",
      "side": 1,
      "message": "Our deadlock happening in account cache:\nhttps://bugs.chromium.org/p/gerrit/issues/detail?id\u003d7645\n\nOther deadlock issue:\nhttps://github.com/google/guava/issues/2976\nhttps://github.com/google/guava/issues/2863\n\nPerformance issue:\nhttps://github.com/google/guava/issues/2063\n\nRace condition:\nhttps://github.com/google/guava/issues/2971",
      "parentUuid": "2d30466b_f887048d",
      "range": {
        "startLine": 22,
        "startChar": 0,
        "endLine": 24,
        "endChar": 12
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "84d6f05b_f3b228dc",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-01-18T18:18:20Z",
      "side": 1,
      "message": "I also did some benchmarks about spawning a lot of threads reading/writing values from the caches. I ran those benchmarks on both Guava and Caffeine and Guava was always taking at least double the time than Caffeine to complete all operations.",
      "range": {
        "startLine": 27,
        "startChar": 31,
        "endLine": 27,
        "endChar": 56
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "38716a55_3b2d4266",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 27,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-01-19T08:54:28Z",
      "side": 1,
      "message": "Thanks for confirmation about perfomance advantage of Caffeine compared to Guava.",
      "parentUuid": "84d6f05b_f3b228dc",
      "range": {
        "startLine": 27,
        "startChar": 31,
        "endLine": 27,
        "endChar": 56
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f1040da8_2295c08a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2018-01-19T08:54:28Z",
      "side": 1,
      "message": "Given that Guava caches considered to be core component of Gerrit (like Jetty, SSHD, JGit) and given non-invasive drop-in replacement of the Guava cache implementation with Caffeine backend (Thanks to Caffeine\u0027s Guava adapter) what about instead of hard coded replacement of Guava Caches backend with Caffeine, just add alternative Caffeine backend in addition to Guava caches and not instead of it? We can even left the default backend to be still Guava cache implementation, in which case this CL would be a no-op if the setting is unchanged. We provide already the similar capability with SSHD, and allow to switch to Mina or NIO2 backends used per configuration.\n\nThis approach would have a charm: we would be in position to back-port this change to ancient gerrit releases, without jeopardizing the stability (as the alternative backend would be off per default). By saying the ancient gerrit versions I meant 2.13, as OpenStack and Wikimedia Foundation are still on 2.13.9 (LibreOffice is even on 2.11.8 and it would take quite some time to migrate to 2.13.x).",
      "range": {
        "startLine": 35,
        "startChar": 0,
        "endLine": 37,
        "endChar": 30
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bc156c47_744da8eb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1029953
      },
      "writtenOn": "2018-01-19T12:52:49Z",
      "side": 1,
      "message": "WMF is planning on updating to 2.14 soon, we fixed one of the blockers on Monday and can now do the update. :).",
      "parentUuid": "f1040da8_2295c08a",
      "range": {
        "startLine": 35,
        "startChar": 0,
        "endLine": 37,
        "endChar": 30
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "81b4d3b9_23aa312e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1012987
      },
      "writtenOn": "2018-01-19T15:30:34Z",
      "side": 1,
      "message": "\u003e Given that Guava caches considered to be core component of Gerrit\n \u003e (like Jetty, SSHD, JGit) and given non-invasive drop-in replacement\n \u003e of the Guava cache implementation with Caffeine backend (Thanks to\n \u003e Caffeine\u0027s Guava adapter) what about instead of hard coded\n \u003e replacement of Guava Caches backend with Caffeine, just add\n \u003e alternative Caffeine backend in addition to Guava caches and not\n \u003e instead of it? We can even left the default backend to be still\n \u003e Guava cache implementation, in which case this CL would be a no-op\n \u003e if the setting is unchanged. We provide already the similar\n \u003e capability with SSHD, and allow to switch to Mina or NIO2 backends\n \u003e used per configuration.\n \u003e \n\n\nI can do that but I am not sure this is ideal. Changing to Caffeine is fixing a bug so if we make Guava the default, people may be hit by this bug and them we will tell them to use Caffeine backend. Then they will most likely ask: why is Caffeine not the default?\n\nThe risk of changing a library is typically for big Gerrit instances. This is what is happening to us with every sshd update... Since we (Ericsson) have quite a big Gerrit instance and we already run this in production, I think the risk of this change blowing up for others is not too high.\n\nAnyway, I am open to all options, let\u0027s wait for other to comments:\n\n-Replace Guava by Caffeine\n-Have both and keep Guava the default\n-Have both and make Caffeine the default\n\nOne more thing, supporting both may require a few refactoring changes first because cache builder leaked out of MemoryCacheFactory class. Supporting both will be a bigger change that the current proposal which is maybe not what we want on stable branches.",
      "parentUuid": "f1040da8_2295c08a",
      "range": {
        "startLine": 35,
        "startChar": 0,
        "endLine": 37,
        "endChar": 30
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7b8aa973_a4a020b6",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1010008
      },
      "writtenOn": "2018-01-19T16:38:52Z",
      "side": 1,
      "message": "I would prefer to keep a single supported (local) cache implementation in core. Why should we make admins choose between two implementations when we have all this evidence saying that one is better? If it\u0027s just about stability, then IMHO that is an argument against backporting it to stable-2.14, not against changing it in master.",
      "parentUuid": "81b4d3b9_23aa312e",
      "range": {
        "startLine": 35,
        "startChar": 0,
        "endLine": 37,
        "endChar": 30
      },
      "revId": "e68406f0647faf4ee8f2a1437b2cf83d4724b5cc",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}