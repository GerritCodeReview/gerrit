{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "56252b2e_c49a90d5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-05T11:40:29Z",
      "side": 1,
      "message": "I would like to see a validation test for this scenario, which seems very easy to reproduce looking at your issue.\n\nI am quite surprised that we never realised that WorkQueue had that problem, I am wondering what are the E2E implications for the Gerrit use-cases that are using the WorkQueue with the scheduling at fixed rates.\n\nCan you mention at least one in your ticket?",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7114bef5_f89647bd",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 3228522
      },
      "writtenOn": "2024-01-09T02:43:35Z",
      "side": 1,
      "message": "I\u0027d like to inquire about how to build test cases. I couldn\u0027t find the package for testing `WorkQueue`.\n\nFor example, in the following code.\n```\ntestScheduledThreadPool \u003d (ScheduledThreadPoolExecutor)queue.createQueue(8, \"Test-Schedule-Queue\");\n    ScheduledFuture\u003c?\u003e unusedFuture \u003d testScheduledThreadPool.scheduleAtFixedRate(new Runnable() {\n      @Override\n      public void run() {\n        num++;\n        try {\n          Thread.sleep(2000);\n        } catch (InterruptedException e) {\n          throw new RuntimeException(e);\n        }\n      }\n\n      @Override\n      public String toString() {\n        return String.format(\"scheduleAtFixedRate test num: %d\", num);\n      }\n    }, 0, 1, TimeUnit.SECONDS);\n```\nAfter running about 10 minutes, this task\u0027s status is \u0027sleeping\u0027 with command `ssh show-queue`.",
      "parentUuid": "56252b2e_c49a90d5",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "299c49a6_daf11daf",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 14
      },
      "lineNbr": 692,
      "author": {
        "id": 1010013
      },
      "writtenOn": "2024-01-05T20:03:17Z",
      "side": 1,
      "message": "I am concerned that adding this without a delay will result in full CPU \"spinning\" for thread B if there are no other tasks to be executed while thread A is blocked (say sleeping). In this scenario, I picture that thread B is basically in a fast loop of:\n\n1) get next task from queue, \n2) task is still running, so\n3) add task back into queue\n\nThus I think it is important to ensure that it has some delay which is no larger than the original task\u0027s \"interval\" when resubmitting the task to the queue.",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}