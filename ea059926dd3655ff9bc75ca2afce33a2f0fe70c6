{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "56252b2e_c49a90d5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-05T11:40:29Z",
      "side": 1,
      "message": "I would like to see a validation test for this scenario, which seems very easy to reproduce looking at your issue.\n\nI am quite surprised that we never realised that WorkQueue had that problem, I am wondering what are the E2E implications for the Gerrit use-cases that are using the WorkQueue with the scheduling at fixed rates.\n\nCan you mention at least one in your ticket?",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7114bef5_f89647bd",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 3228522
      },
      "writtenOn": "2024-01-09T02:43:35Z",
      "side": 1,
      "message": "I\u0027d like to inquire about how to build test cases. I couldn\u0027t find the package for testing `WorkQueue`.\n\nFor example, in the following code.\n```\ntestScheduledThreadPool \u003d (ScheduledThreadPoolExecutor)queue.createQueue(8, \"Test-Schedule-Queue\");\n    ScheduledFuture\u003c?\u003e unusedFuture \u003d testScheduledThreadPool.scheduleAtFixedRate(new Runnable() {\n      @Override\n      public void run() {\n        num++;\n        try {\n          Thread.sleep(2000);\n        } catch (InterruptedException e) {\n          throw new RuntimeException(e);\n        }\n      }\n\n      @Override\n      public String toString() {\n        return String.format(\"scheduleAtFixedRate test num: %d\", num);\n      }\n    }, 0, 1, TimeUnit.SECONDS);\n```\nAfter running about 10 minutes, this task\u0027s status is \u0027sleeping\u0027 with command `ssh show-queue`.",
      "parentUuid": "56252b2e_c49a90d5",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ea068fe9_21a98d25",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 3228522
      },
      "writtenOn": "2024-01-10T02:31:00Z",
      "side": 1,
      "message": "I have create a change for test.\nhttps://gerrit-review.googlesource.com/c/gerrit/+/401777\nI\u0027d like to know if it is enough to confirm this issue.",
      "parentUuid": "7114bef5_f89647bd",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d9619953_8977969f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1148165
      },
      "writtenOn": "2024-01-10T12:05:04Z",
      "side": 1,
      "message": "@luca.milanesio@gmail.com\nHe copied WorkQueue.java in test codes. It seems a little bit tricky.\nWould mind telling us where we can write test? We don\u0027t know how to access WorkQueue object in test cases?",
      "parentUuid": "ea068fe9_21a98d25",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b8e8cb16_d15e0da0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1148165
      },
      "writtenOn": "2024-01-12T03:08:29Z",
      "side": 1,
      "message": "pin",
      "parentUuid": "d9619953_8977969f",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b2f0411f_d8fd2e46",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2024-01-15T13:46:46Z",
      "side": 1,
      "message": "Thanks for writing I01cfc65, can we focus on the test first and then continue with the review of the solution to fix the issue?",
      "parentUuid": "b8e8cb16_d15e0da0",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "26bb4f18_ad5db117",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1148165
      },
      "writtenOn": "2024-01-15T14:54:29Z",
      "side": 1,
      "message": "https://gerrit-review.googlesource.com/c/gerrit/+/401777\nThis is the test code. But we\u0027re not sure if it\u0027s the right way to do it.\nIs there any documentation about how to access Gerrit internal WorkQueue Object inside test?",
      "parentUuid": "b2f0411f_d8fd2e46",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "96be0d40_73a939a4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 14
      },
      "lineNbr": 0,
      "author": {
        "id": 1148165
      },
      "writtenOn": "2024-01-17T03:12:58Z",
      "side": 1,
      "message": "@luca.milanesio@gmail.com\nHi. We find a way to write the test. The test is implemented like this:\n1. schedule a task which execute `num++` every 1 second.\n2. put a 1 second sleep in OnStop method.\n2. wait 10 seconds\n3. check if `num` is greater than 1.\n\nhttps://gerrit-review.googlesource.com/c/gerrit/+/399657 pass with our fix\nhttps://gerrit-review.googlesource.com/c/gerrit/+/401777 fails without fix\n\nI think the only thing left is what @mogulguy12@gmail.com said, if we reschedule the task immediately, the CPU would spin for a long time. However we cannot get interval from Task instance.",
      "parentUuid": "26bb4f18_ad5db117",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "299c49a6_daf11daf",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 14
      },
      "lineNbr": 692,
      "author": {
        "id": 1010013
      },
      "writtenOn": "2024-01-05T20:03:17Z",
      "side": 1,
      "message": "I am concerned that adding this without a delay will result in full CPU \"spinning\" for thread B if there are no other tasks to be executed while thread A is blocked (say sleeping). In this scenario, I picture that thread B is basically in a fast loop of:\n\n1) get next task from queue, \n2) task is still running, so\n3) add task back into queue\n\nThus I think it is important to ensure that it has some delay which is no larger than the original task\u0027s \"interval\" when resubmitting the task to the queue.",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "234f7cee_f0db0e6c",
        "filename": "java/com/google/gerrit/server/git/WorkQueue.java",
        "patchSetId": 14
      },
      "lineNbr": 692,
      "author": {
        "id": 1148165
      },
      "writtenOn": "2024-01-10T04:13:12Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "299c49a6_daf11daf",
      "revId": "ea059926dd3655ff9bc75ca2afce33a2f0fe70c6",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}