{
  "comments": [
    {
      "key": {
        "uuid": "98691138_9712cd9d",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-05-06T18:42:57Z",
      "side": 1,
      "message": "This approach is not secondary index agnostic. It works only for Apache Lucene, but not for Google index and  Elasticsearch: there is no such directory. On ES, the index directory looks like this:\n\n  davido@wizball:~/projects/test_site_es/index$ ls -all\n  total 12\n  drwxr-xr-x  2 davido users 4096 May  6 20:24 .\n  drwxr-xr-x 13 davido users 4096 May  6 20:24 ..\n  -rw-r--r--  1 davido users   38 May  6 20:24 gerrit_index.config\n\nSo that this change made the situation even worse: it erroneously assumes that the project index is missing and (always) forcing reindexing for it. But it also removes --no-reindex option, so that there is no way to disable projects index reindexing, even if admin knows, that this index exists.\n\nYou can start parsing gerrit_index.config, to check for something like:\n\n  [index \"projects_0004\"]\n\tready \u003d true\n\nOr you can start searching for All-Users project in index, to see if you can find it.\n\nOr you can just swap the bad named \"--no-index\" option to --index-projects options. So to say make the option upgrade site friendly.\n\nIn Elasticsearch case, after running init from this change, I cannot start gerrit anyway, so what\u0027s the point?\n\n  [2020-05-06T20:27:09.818+0200] [main] ERROR com.google.gerrit.pgm.Daemon : Unable to start daemon\ncom.google.inject.ProvisionException: Unable to provision, see the following errors:\n\n1) No index versions for index \u0027changes\u0027 ready; run java -jar /home/davido/projects/test_site_es/bin/gerrit.war reindex --index changes\n\n1 error\n\nAfter running reindex on the site and initializing changes, accounts and groups, and projects index (again) gerrit can be started.",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c458a407_e89d1906",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-05-06T20:00:59Z",
      "side": 1,
      "message": "\u003e This approach is not secondary index agnostic. It works only for Apache Lucene, but not for Google index and  Elasticsearch: there is no such directory. \n\nI believe Google doesn\u0027t use the standard \u0027java -jar gerrit.war init\u0027 for setting up their instances. Also, there isn\u0027t an open-source version of the Google index.\n\nWith regards to Elasticsearch, what can you propose to do during init?",
      "parentUuid": "98691138_9712cd9d",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1d5350a9_76630efb",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-05-06T20:12:38Z",
      "side": 1,
      "message": "What if I apply your suggestion:\n\n\u003e You can start parsing gerrit_index.config, to check for something like:\n\u003e [index \"projects_0004\"]\n\u003e ready \u003d true\n\nWould the change be acceptable for you?",
      "parentUuid": "c458a407_e89d1906",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9ed8f330_7ae6cefd",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2020-05-06T20:35:26Z",
      "side": 1,
      "message": "Clearly, that this change regresses for gerrit installation sites with ES index backend and cannot be accepted with the current approach.\n\nIf you still after removing --no-reindex option, then, at very least, it must guess existence of projects index for existing index backends today: Lucene \u0026 Elasticsearch, or even for any other possible future index backends that not necessary rely on local file system like: Apache Solr: [1].\n\nIt is out of scope of this change to fix any problems/bugs with init program for site with ES index backend, obviously.\n\n[1] https://lucene.apache.org/solr",
      "parentUuid": "1d5350a9_76630efb",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "334c69b4_23f85c76",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-05-06T20:56:15Z",
      "side": 1,
      "message": "\u003e Clearly, that this change regresses for gerrit installation sites with ES index backend and cannot be accepted with the current approach.\n\nI take this as a \"Yes, that would be acceptable\". Feel free to correct me if I am wrong :-)\n\n\u003e If you still after removing --no-reindex option, then, at very least, it must guess existence of projects index for existing index backends today: Lucene \u0026 Elasticsearch, or even for any other possible future index backends that not necessary rely on local file system like: Apache Solr: [1].\n\nWe removed the support for Apache Solr a long ago, I believe it\u0027s out of scope.\n\nFor existing Gerrit setups with ElasticSearch, no projects reindexing is needed when upgrading from v3.1 to v3.2. For new setups, the parsing of gerrit_index.config would work. \n\nI will also do some E2E installs and upgrades with ES, to make sure that we don\u0027t have further gaps.\n\nThanks again for your review and suggestions, much appreciated :-)",
      "parentUuid": "9ed8f330_7ae6cefd",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a3a1ba28_2feb45f8",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-05-06T23:37:36Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "334c69b4_23f85c76",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "13b6feb6_817b0e78",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-05-06T23:54:41Z",
      "side": 1,
      "message": "\u003e In Elasticsearch case, after running init from this change, I cannot start gerrit anyway, so what\u0027s the point?\n\u003e  [2020-05-06T20:27:09.818+0200] [main] ERROR com.google.gerrit.pgm.Daemon : Unable to start daemon\n\u003e com.google.inject.ProvisionException: Unable to provision, see the following errors:\n\u003e 1) No index versions for index \u0027changes\u0027 ready; run java -jar /home/davido/projects/test_site_es/bin/gerrit.war reindex --index changes\n\nHave you checked *without* this change? Same problem: you cannot start Gerrit+ES until you do a full reindex of everything.\n\nI\u0027ll fix that issue separately, because it isn\u0027t related to the projects reindex.",
      "parentUuid": "a3a1ba28_2feb45f8",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9429a097_19832450",
        "filename": "java/com/google/gerrit/pgm/Init.java",
        "patchSetId": 19
      },
      "lineNbr": 159,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2020-05-07T00:03:09Z",
      "side": 1,
      "message": "Traced as https://bugs.chromium.org/p/gerrit/issues/detail?id\u003d12704 and it will be fixed in a follow-up change.",
      "parentUuid": "13b6feb6_817b0e78",
      "range": {
        "startLine": 153,
        "startChar": 2,
        "endLine": 159,
        "endChar": 3
      },
      "revId": "ee9491c75cce4e8e57d152bec1ab15dd70704510",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}