{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "1927d584_87aae588",
        "filename": "java/com/google/gerrit/httpd/raw/IndexHtmlUtil.java",
        "patchSetId": 4
      },
      "lineNbr": 107,
      "author": {
        "id": 1013302
      },
      "writtenOn": "2022-09-28T15:01:17Z",
      "side": 1,
      "message": "This impacts the latency of initial page load. I don\u0027t think we can wait for this.",
      "revId": "f5ecf2b5d0dd4804c3af479f1f945d0d551c2de9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9995004a_436b3fdc",
        "filename": "java/com/google/gerrit/httpd/raw/IndexHtmlUtil.java",
        "patchSetId": 4
      },
      "lineNbr": 107,
      "author": {
        "id": 1108045
      },
      "writtenOn": "2022-09-29T11:24:59Z",
      "side": 1,
      "message": "I thought about this, but I don\u0027t know how expensive it actually is - I saw we were already querying accounts, for instance, and the call is really fast locally and on my (small) production hosts.\n\nI do believe that proper link previews are quite important for usability - any thought on how we could approach this? Perhaps we could route specific, known user agents to a dedicated link preview servlet?",
      "parentUuid": "1927d584_87aae588",
      "revId": "f5ecf2b5d0dd4804c3af479f1f945d0d551c2de9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9ca6884e_345317f4",
        "filename": "java/com/google/gerrit/httpd/raw/IndexHtmlUtil.java",
        "patchSetId": 4
      },
      "lineNbr": 107,
      "author": {
        "id": 1013302
      },
      "writtenOn": "2022-09-29T13:21:26Z",
      "side": 1,
      "message": "@ekempin@google.com This needs someone from the backend team to look at.",
      "parentUuid": "9995004a_436b3fdc",
      "revId": "f5ecf2b5d0dd4804c3af479f1f945d0d551c2de9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7342191a_a4b22a83",
        "filename": "java/com/google/gerrit/httpd/raw/IndexHtmlUtil.java",
        "patchSetId": 4
      },
      "lineNbr": 107,
      "author": {
        "id": 1108045
      },
      "writtenOn": "2022-09-30T17:09:41Z",
      "side": 1,
      "message": "Some thoughts on how to approach the latency trade off:\n\n- Detect link preview bots and serve a static site just for them. Unfortunately, there is no standard way of identifying them other than by making a list of known user agents. Maintaining a list doesn\u0027t sound great, but otherwise, this would be my preferred solution - zero cost for the SPA, and it would us add more features over time (like Open Graph snippets or including parts of the commit message).\n\n- Make it configurable so users can pick their poison. Not great since it would lead to an inconsistent user experience.\n\n- Fetch /detail and prefetch it - the frontend fetches that anyway so at least don\u0027t pay the cost twice.\n\n(happy to move the discussion to the issue/repo-discuss/elsewhere - I\u0027m aware that submitting a CL without getting sign-off on the overall approach first means it might be rejected, I\u0027m OK with that)",
      "parentUuid": "9ca6884e_345317f4",
      "revId": "f5ecf2b5d0dd4804c3af479f1f945d0d551c2de9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5e674a03_3db61eb8",
        "filename": "java/com/google/gerrit/httpd/raw/IndexHtmlUtil.java",
        "patchSetId": 4
      },
      "lineNbr": 107,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2022-10-04T07:52:10Z",
      "side": 1,
      "message": "IIUC this call results in invoking ChangesCollection#parse which invoked ChangeFinder#find. This means it:\n\n* does an index query (to find the project for changeNum, only if not present in the changeIdProjectCache)\n* loads the change from NoteDb (requires project + changeNum)\n* checks the read permissions of the change\n\nI do agree with Ben that this is likely a too large latency increase to do unconditionally.\n\nIIUC issue 16100 affects only a few user agents, hence your suggestion to make this logic depending on the user agent. Maybe admins could configure the list of user agents in gerrit.config for which the change info should be included? I have no preference for a solution here, but I think we should avoid the latency decrease for callers that do not need the change info.",
      "parentUuid": "7342191a_a4b22a83",
      "revId": "f5ecf2b5d0dd4804c3af479f1f945d0d551c2de9",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}