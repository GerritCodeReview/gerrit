load("@npm_bazel_typescript//:index.bzl", "ts_config", "ts_library")
load("@build_bazel_rules_nodejs//:index.bzl", "nodejs_binary", "npm_package_bin")
load("@npm//typescript:index.bzl", "tsc")
load("//tools/node_tools/node_modules_licenses:node_modules_licenses.bzl", "node_modules_licenses")

filegroup(
    name = "licenses-texts",
    srcs = glob(["licenses/*.txt"]),
)

ts_library(
    name = "licenses-config",
    srcs = [
        "licenses.ts",
    ],
    node_modules = "@tools_npm//:node_modules",
    tsconfig = "tsconfig.json",
    deps = [
        "//tools/node_tools/node_modules_licenses:licenses-map",
        "@tools_npm//@types/node",
    ],
)

genrule(
    name = "tsconfigs",
    srcs = [":tsconfig.json"],
    outs = ["tsconfig_editor.json"],
    cmd = "cp $< $@",
)

# filegroup is enough (instead of rollup-bundle), because we are not going to run licenses.ts file
filegroup(
    name = "licenses-config-js",
    srcs = [":node-modules-licenses"],
    output_group = "es5_sources",
)

# Generate polygerrit-licenses.json for files in @ui_npm workspace.
# For details - see comments for node_modules_licenses rule and
# tools/node_tools/node_modules_licenses/license-map-generator.ts file
node_modules_licenses(
    name = "polygerrit-licenses",
    licenses_config = "licenses-js",
    licenses_texts = [":licenses-texts"],
    node_modules = "@ui_npm//:node_modules",
    visibility = ["//visibility:public"],
)
