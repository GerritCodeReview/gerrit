#!/bin/bash
# Copyright (C) 2015 The Android Open Source Project
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

file=tools/maven/mvn.py

# revert temp. change to file
function revert
{
  # echo "api: reverting temp. changes..." >&2
  git checkout $file

  exit $1
}

# show usage and exit with return code
function help
{
  rc=${1-0}

  cat >&2 <<'eof'
Usage: api action
       api --help|-h

Install or deploy Gerrit Plugin API to local or Central Maven repositories.

Valid actions:
  install
  deploy

  --help                     show this message and exit
  -h                         same as --help
eof

  exit $rc
}

case $1 in
    install|deploy)
        if test $# = 1; then
            action=$1
        else
            echo "api: invalid number of arguments" >&2
            help 1
        fi
        ;;
    --help|-h)
        help
        ;;
    "")
        echo "api: missing action arg" >&2
        help 1
        ;;
    *)
        echo "api: unknown action arg \`$1'" >&2
        help 1
        ;;
esac

# cd to parent directory of the script
cd ${0%/*}/..

# install signal handler to make sure, temp. change gets reverted
trap 'revert 1' 2 3 4 5 6 7 8 9 10 11 12 13 14 15

if test -n "$(git diff $file)"; then
  echo "api: file \`$file' has unclean git status. Please commit first." >&2
  exit 1
fi

# force buck rule execution
echo 'print("We are done, folks!", file=stderr)' >> $file

# main action, save the return code
buck build api_$action
rc=$?

revert $rc
